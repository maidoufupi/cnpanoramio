<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
           http://www.springframework.org/schema/security
           http://www.springframework.org/schema/security/spring-security-3.1.xsd">
 
    <!-- Configure Spring Security -->
    <!--
    <security:http auto-config="true">
        <security:form-login login-page="/login" login-processing-url="/loginProcess" 
            default-target-url="/" authentication-failure-url="/login?login_error=1" />
        <security:logout logout-url="/logout" logout-success-url="/logoutSuccess" />
        <security:remember-me key="bookingtest" />
    </security:http>
    -->
    
    <security:http auto-config="false" entry-point-ref="ajaxAuthenticationEntryPoint">
        <!-- 登录过滤器 -->
             <security:custom-filter before="FORM_LOGIN_FILTER" ref="loginFilter"/>
             <!-- ajax登录过滤器 -->
             <security:custom-filter position="FORM_LOGIN_FILTER" ref="ajaxLoginFilter"/>
             <!-- 只cache get,避免ajax post 被cache -->
             <!-- <security:request-cache ref="httpSessionRequestCache"/> -->
             <!-- 注销过滤器 -->
             <security:logout logout-url="/logout" logout-success-url="/logoutSuccess" />
             <!-- remember me -->
             <!-- <security:remember-me key="bookingtest" /> -->
    </security:http>
     
    <bean id="ajaxAuthenticationEntryPoint" class="com.cnpanoramio.webapp.spring.AjaxAuthenticationEntryPoint">
        <property name="loginFormUrl" value="/login" />
    </bean>
          
    <!-- 验证普通用户 --> 
    <bean id="loginFilter" class="org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="authenticationFailureHandler" ref="failureHandler"/>
        <property name="authenticationSuccessHandler" ref="successHandler"/>
        <property name="filterProcessesUrl" value="/loginProcess"/>
    </bean>
 
    <bean id="failureHandler" class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler">
        <property name="defaultFailureUrl" value="/login?login_error=1" />
    </bean>
 
    <bean id="successHandler" class="org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler">
        <property name="alwaysUseDefaultTargetUrl" value="false"/>
        <property name="defaultTargetUrl" value="/"/>
    </bean>
    
    <!-- 验证ajax请求-->
    <bean id="ajaxLoginFilter" class="org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="authenticationFailureHandler" ref="ajaxFailureHandler"/>
        <property name="authenticationSuccessHandler" ref="ajaxSuccessHandler"/>
        <property name="filterProcessesUrl" value="/ajaxLoginProcess"/>
    </bean>
     
    <bean id="ajaxFailureHandler" class="com.cnpanoramio.webapp.spring.AjaxAuthenticationFailureHandler">
    </bean>
     
    <bean id="ajaxSuccessHandler" class="com.cnpanoramio.webapp.spring.AjaxAuthenticationSuccessHandler">
    </bean>
     
    <security:global-method-security  jsr250-annotations="enabled" secured-annotations="enabled" /> 

</beans>