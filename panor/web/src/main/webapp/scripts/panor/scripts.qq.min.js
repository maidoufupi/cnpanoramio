"use strict";!function(){function a(a,b,c,d){angular.forEach(b.split(" "),function(b){window.qq.maps.event.addListener(c,b,function(c){d.triggerHandler("map-"+b,c),a.$$phase||a.$apply()})})}function b(b,c){e.directive(b,[function(){return{restrict:"A",link:function(d,e,f){d.$watch(f[b],function(b){b&&a(d,c,b,e)})}}}])}function c(a,b){var c,e=[],g=function(a,b){b=angular.isFunction(b)?b():null==b?"":b,e[e.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(angular.isArray(a)||a.jquery&&!angular.isObject(a))angular.forEach(a,function(){g(this.name,this.value)});else for(c in a)d(c,a[c],b,g);return e.join("&").replace(f,"+")}function d(a,b,c,e){var f;if(angular.isArray(b))angular.forEach(b,function(b,f){c||rbracket.test(a)?e(a,b):d(a+"["+("object"==typeof b?f:"")+"]",b,c,e)});else if(!c&&angular.isObject(b))for(f in b)d(a+"["+f+"]",b[f],c,e);else e(a,b)}var e=angular.module("ui.map",["ui.event"]);e.value("uiMapConfig",{}).directive("uiMap",["uiMapConfig","$window","$parse",function(b,c,d){var e="click dblclick rightclick mouseover mouseout mousemove drag dragstart dragend bounds_changed center_changed zoom_changed maptypeid_changed projection_changed idle tilesloaded resize",f=b||{};return{restrict:"A",controller:function(){},link:function(b,g,h){function i(){k.uiMapCache&&c[h.uiMapCache]?(g.replaceWith(window[h.uiMapCache]),j=c[h.uiMapCache+"Map"]):(k.ngCenter&&angular.isNumber(k.ngCenter.lat)&&angular.isNumber(k.ngCenter.lng)&&(k.center=new qq.maps.LatLng(k.ngCenter.lat,k.ngCenter.lng)),angular.isNumber(k.ngZoom)&&(k.zoom=k.ngZoom),j=new qq.maps.Map(g[0],k));var f=d(h.uiMap);f.assign(b,j),a(b,e,j,g)}var j,k=angular.extend({},f,b.$eval(h.uiOptions));b.$on("map.loaded",function(a,b){"qq"!=b||j||i()}),c.qq&&c.qq.maps&&c.qq.maps.Map&&i()}}}]),e.value("uiMapInfoWindowConfig",{}).directive("uiMapInfoWindow",["uiMapInfoWindowConfig","$window","$parse","$compile",function(b,c,d,e){var f="content_changed position_changed zindex_changed closeclick closeclick",g=b||{};return{link:function(b,h,i){function j(){if(!m){m=new window.qq.maps.InfoWindow(k),l.assign(b,m),a(b,f,m,h),h.replaceWith("<div></div>");var c=m.open;m.open=function(a,d,f,g,i,j){e(h.contents())(b),c.call(m,a,d,f,g,i,j)}}}var k=angular.extend({},g,b.$eval(i.uiOptions));k.content=h[0];var l=d(i.uiMapInfoWindow),m=l(b);b.$on("map.loaded",function(a,b){"qq"!=b||m||j()}),c.qq&&c.qq.maps&&c.qq.maps.Map&&j()}}}]),b("uiMapMarker","animation_changed clickable_changed cursor_changed draggable_changed flat_changed icon_changed map_changed position_changed shadow_changed shape_changed title_changed visible_changed zindex_changed click mousedown mouseup mouseover mouseout dblclick rightclick dragstart dragging dragend"),b("uiMapPolyline","map_changed visible_changed zindex_changed click dblclick rightclick mousedown mouseup mouseover mouseout mousemove"),b("uiMapPolygon","map_changed visible_changed zindex_changed click dblclick rightclick mousedown mouseup mouseover mouseout mousemove"),b("uiMapCircle","center_changed map_changed radius_changed visible_changed zindex_changed click dblclick rightclick mousedown mouseup mouseover mouseout mousemove"),b("uiMapGroundOverlay","map_changed visible_changed click mousedown mousemove mouseout mouseover mouseup rightclick"),e.provider("uiMapLoadParams",function(){var a={};this.setParams=function(b){a=b},this.$get=function(){return a}}).directive("uiMapAsyncLoad",["$window","$parse","uiMapLoadParams",function(a,b,d){return{restrict:"A",link:function(b,e,f){a.mapqqLoadedCallback=function(){b.$broadcast("map.loaded","qq")};var g=angular.extend({},d,b.$eval(f.uiMapAsyncLoad));if(g.callback="mapqqLoadedCallback",a.qq&&a.qq.maps&&a.qq.maps.Map)mapqqLoadedCallback();else{var h=document.createElement("script");h.type="text/javascript",h.src="http://map.qq.com/api/js?"+c(g),document.body.appendChild(h)}}}}]);var f=/%20/g}(),function(a){"function"==typeof define&&define.amd?define([window,"jquery","cnmap"],a):a(window,jQuery)}(function(a){return a.cnmap.MapEventListener=function(b){this.opts=b||this.opts,this.addLocationHashListener=function(b,c){var d=[];return d.push(a.qq.maps.event.addListener(b,"idle",function(){var a=b.getCenter();c.apply(this,[a.lat,a.lng,b.getZoom()])})),d},this.removeListener=function(a){a&&$.each(a,function(a,b){qq.maps.event.removeListener(b)})},this.addToolBar=function(){},this.setCenter=function(a,b,c){var d=new qq.maps.LatLng(b,c);a.setCenter(d)},this.setZoom=function(a,b){a.setZoom(Number(b))},this.setZoomAndCenter=function(a,b,c,d){var e=new qq.maps.LatLng(c,d);a.panTo(e),a.zoomTo(Number(b))},this.zoomIn=function(a){a.zoomBy(1)},this.zoomOut=function(a){a.zoomBy(-1)},this.setBounds=function(a,b,c){a.fitBounds(new qq.maps.LatLngBounds(new qq.maps.LatLng(b.lat,b.lng),new qq.maps.LatLng(c.lat,c.lng)))},this.clearMap=function(){},this.inMapView=function(a,b,c){c=c||this.opts.map;var d=new qq.maps.LatLng(a,b),e=c.getBounds();return e?e.contains(d):!1},this.pixelToPoint=function(a,b){var c,d=a.getBounds(),e={},f=$(a.getContainer());return c={width:parseInt(f.width()),height:parseInt(f.height())},e.lng=b.x/c.width*(d.getNorthEast().lng-d.getSouthWest().lng)+d.getSouthWest().lng,e.lat=d.getNorthEast().lat-b.y/c.height*(d.getNorthEast().lat-d.getSouthWest().lat),e},this.pointToPixel=function(a,b){var c=a.getProjection();return c.fromLatLngToPoint(new qq.maps.LatLng(b.lat,pixel.lng))},this.addMarker=function(a,b,c){return new qq.maps.Marker({map:a,position:new qq.maps.LatLng(b,c)})},this.createDraggableMarker=function(a,b,c){return new qq.maps.Marker({draggable:!0,map:a,position:new qq.maps.LatLng(b,c)})},this.activeMarker=function(a){a&&(a.setZIndex(2),a.setIcon("images/marker.png"))},this.deactiveMarker=function(a){a&&(a.setZIndex(1),a.setIcon(""))},this.addMarkerActiveListener=function(b,c){function d(){c.apply(b,[])}a.qq.maps.event.addListener(b,"click",d),a.qq.maps.event.addListener(b,"dragend",d)},this.addDragendListener=function(b,c){a.qq.maps.event.addListener(b,"dragend",function(a){c.apply(b,[a.latLng.lat,a.latLng.lng])})},this.removeMarker=function(a){a.setMap(null)},this.addMapClickListener=function(b,c){a.qq.maps.event.addListener(b,"click",function(a){var d=a.latLng;c.apply(b,[d.lat,d.lng])})},this.setPosition=function(a,b,c){var d=new qq.maps.LatLng(b,c);a.setPosition(d)},this.setMap=function(a,b){a.setMap(b)}},a.cnmap.MapEventListener.prototype=a.cnmap.IMapEventListener,a.cnmap.MapEventListener.factory=function(){return new a.cnmap.MapEventListener},a.cnmap.MapEventListener}),function(a){"function"==typeof define&&define.amd?define([window,"jquery","cnmap"],a):a(window,jQuery)}(function(a){return a.cnmap.MapService=function(a){var b={1:7,2:15,3:17,4:18,5:18,6:19};this.map=a||this.map;var c;this.init=function(){c=new qq.maps.Geocoder},this.getAddress=function(a,b,d){var e=new qq.maps.LatLng(a,b);c.setComplete(function(a){"GEO_INFO"==a.type&&d.apply(void 0,[a.detail.address])}),c.getAddress(e)},this.getAddrPois=function(a,b){var c=jQuery.Deferred(),d=new qq.maps.Geocoder,e=new qq.maps.LatLng(a,b);return d.setComplete(function(a){var b={};if("GEO_INFO"==a.type){var d=a.detail;$.each(d.nearPois,function(a,c){var d="";d=c.name?c.address+" "+c.name:c.address,b[d]={poiweight:c.dist,location:c.latLng}})}c.resolve(b,d.address)}),d.getAddress(e),c.promise()},this.getLocation=function(a,b){c.setComplete(function(a){b.apply(void 0,[a])}),c.getLocation(a)},this.getLocPois=function(a){var d=jQuery.Deferred();return c.setComplete(function(a){var c=[];if("GEO_INFO"==a.type){var e=a.detail;c.push({address:e.address,location:e.location,similarity:e.similarity,zoom:b[e.gps_type]||3}),$.each(e.similarResults,function(a,d){c.push({address:d.address,location:d.location,similarity:d.similarity,zoom:b[e.gps_type]||3})})}d.resolve(c)}),c.getLocation(a),d.promise()}},a.cnmap.MapService.prototype=a.cnmap.IMapService,a.cnmap.MapService.factory=function(){return new a.cnmap.MapService},a.cnmap.MapService}),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.createPoint=function(a){return new qq.maps.LatLng(a.point.lat,a.point.lng)},b.prototype.createMarker=function(a){var b,c;return c=this,b=new qq.maps.Marker({icon:new qq.maps.MarkerImage(""+this.staticCtx+"/"+a.oss_key+"@!panor-lg"),title:a.title||"",map:this.map,position:new qq.maps.LatLng(a.point.lat,a.point.lng)}),b.photo=a,this.opts.clickable&&qq.maps.event.addListener(b,"click",function(){return jQuery(c).trigger("data_clicked",[this.photo.id])}),a.marker=b,this.labels.push(b),b},b.prototype.createPolyline=function(a){return new qq.maps.Polyline({map:this.map,path:a,strokeWeight:2})},b.prototype.setPolylinePath=function(a,b){return a.setPath(b)},b.prototype.removeMarker=function(a){return a.marker?(a.marker.setMap(null),delete a.marker):void 0},b.prototype.toggleSpotLine=function(a,b){return a.polyline?a.polyline.setVisible(b):void 0},b.prototype.spotEditable=function(a,b){var c,d,e,f,g,h,i;for(b=!!b,e=this,c=function(c){if(c){if(c.setDraggable(e.opts.editable&&b),e.opts.editable&&b)return c.dragListener=qq.maps.event.addListener(c,"dragend",function(b){return this.photo.oPoint||(this.photo.oPoint=$.extend({},this.photo.point)),this.photo.point.lat=b.latLng.lat,this.photo.point.lng=b.latLng.lng,e.updateSpotLine(a),$(e).trigger("spot.edited",[a.id])});if(c.dragListener)return qq.maps.event.removeListener(c.dragListener),c.dragListener=null}},h=a.photos,i=[],f=0,g=h.length;g>f;f++)d=h[f],i.push(c(d.marker));return i},b.prototype.cancelSpotEdit=function(a){var b,c,d,e,f;for(b=function(a){return a.oPoint&&(a.point=a.oPoint,delete a.oPoint),a.marker?a.marker.setPosition(new qq.maps.LatLng(a.point.lat,a.point.lng)):void 0},f=a.photos,d=0,e=f.length;e>d;d++)c=f[d],b(c);return this.updateSpotLine(a)},b.prototype.clearMap=function(){var a,b,c,d;for(d=this.labels,b=0,c=d.length;c>b;b++)a=d[b],a.setMap(null),a.setVisible(!1);return this.labels=[]},b}(window.cnmap.ITravelLayer),window.cnmap.TravelLayer=a}.call(this),function(a){"function"==typeof define&&define.amd?define([window,"jquery","Panoramio"],a):a(window,jQuery)}(function(a,b){return a.cnmap=a.cnmap||{},a.cnmap.PanoramioLayer=function(a){var c,d={};this.preZoom=0,this.preBounds=null,this.opts=b.extend({clickable:!0,auto:!0},a),this.opts.map&&this.setMap(this.opts.map),this.getMap=function(){return this.opts.map},this.setMap=function(a){function b(){if($(e).trigger("map_changed",[e.getBounds(),e.getLevel(),e.getSize()]),e.opts.auto){var b=a.getBounds();if(b){e.getBoundsThumbnails(e.getBounds(),e.getLevel(),e.getSize())}}}if(a){this.opts.map=a,c=new qq.maps.InfoWindow,c.setMap(a);var d=qq.maps.event.addListener(a,"idle",b);d=qq.maps.event.addListener(a,"dragend",b)}else this.opts.map=void 0;var e=this},this.hideLabel=function(a){d[a]&&(d[a].setVisible(!1),d[a].setMap(null))},this.createMarker=function(a){var e=this.opts.map,f=this,g=d[a.id];g?(g.setVisible(!0),g.setMap(e)):(g=new qq.maps.Label({style:{padding:0,border:0,cursor:"pointer"}}),g.photoId=a.id,g.setContent(f.getLabelContent(a.oss_key)),g.setMap(e),g.setPosition(new qq.maps.LatLng(a.point.lat,a.point.lng)),f.opts.clickable&&qq.maps.event.addListener(g,"click",function(){f.opts.suppressInfoWindows?(c.setOptions({content:f.getInfoWindowContent(a),position:this.getPosition()}),c.open()):b(f).trigger("data_clicked",[this.photoId])}),d[a.id]=g)},this.getInfoWindowContent=function(a){var b,c=new Date(a.create_date);return b=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"<div class=\"panoramio-info-window\" style=\"'width': '200px','height': '200px','display': 'inline-block'\"><div class=\"header\">"+(a.address||"")+'</div><div class="body"><a href="'+this.ctx+"/photo/"+a.photo_id+'"><img src="'+this.ctx+"/api/rest/photo/"+a.photo_id+'/2"></a></div><div class="media"><a class="pull-left" href="'+this.ctx+"/user/"+a.user_id+'"><img class="media-object" src="'+this.ctx+"/api/rest/user/"+a.user_id+'/avatar" alt="'+a.username+'"></a><div class="media-body"><h4 class="media-heading">作者：<a href="'+this.ctx+"/user/"+a.user_id+'">'+a.username+"</a></h4>"+b+"</div></div></div>"},this.setOptions=function(a){this.opts=a},this.trigger=function(){this.opts.map&&qq.maps.event.trigger(this.opts.map,"dragend")},this.center_changed=function(){},this.getBounds=function(){var a=this.opts.map&&this.opts.map.getBounds();return a?{ne:{lat:a.getNorthEast().lat,lng:a.getNorthEast().lng},sw:{lat:a.getSouthWest().lat,lng:a.getSouthWest().lng}}:{}},this.getLevel=function(){return this.opts.map.getZoom()},this.getSize=function(){var a=b(this.opts.map.getContainer());return{width:parseInt(a.width()),height:parseInt(a.height())}},this.clearMap=function(){$.each(d,function(a,b){b&&b.setMap(null)}),d=[],this.thumbPhotoIds=[]},this.setAuto=function(a){this.opts.auto=a}},a.cnmap.PanoramioLayer.prototype=new a.cnmap.Panoramio,a.cnmap.PanoramioLayer});