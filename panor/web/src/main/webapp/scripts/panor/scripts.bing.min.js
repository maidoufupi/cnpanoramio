"use strict";!function(){function a(a,b,c,d){angular.forEach(b.split(" "),function(b){Microsoft.Maps.Events.addHandler(c,b,function(c){d.triggerHandler("map-"+b,c),a.$$phase||a.$apply()})})}function b(b,c){e.directive(b,[function(){return{restrict:"A",link:function(d,e,f){d.$watch(f[b],function(b){b&&a(d,c,b,e)})}}}])}function c(a,b){var c,e=[],g=function(a,b){b=angular.isFunction(b)?b():null==b?"":b,e[e.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(angular.isArray(a)||a.jquery&&!angular.isObject(a))angular.forEach(a,function(){g(this.name,this.value)});else for(c in a)d(c,a[c],b,g);return e.join("&").replace(f,"+")}function d(a,b,c,e){var f;if(angular.isArray(b))angular.forEach(b,function(b,f){c||rbracket.test(a)?e(a,b):d(a+"["+("object"==typeof b?f:"")+"]",b,c,e)});else if(!c&&angular.isObject(b))for(f in b)d(a+"["+f+"]",b[f],c,e);else e(a,b)}var e=angular.module("ui.map",["ui.event"]);e.value("bingMapConfigs",{}),e.value("uiMapConfig",{}).directive("uiMap",["uiMapConfig","$window","$parse","uiMapLoadParams",function(b,c,d,e){var f="click copyrightchanged dblclick imagerychanged keydown keypress keyup maptypechanged mousedown mousemove mouseout mouseover mouseup mousewheel optionschanged rightclick targetviewchanged tiledownloadcomplete viewchange viewchangeend viewchangestart",g=b||{};return g.credentials=e.key,{restrict:"A",controller:function(){},link:function(b,e,h){function i(){k.uiMapCache&&c[h.uiMapCache]?(e.replaceWith(window[h.uiMapCache]),j=c[h.uiMapCache+"Map"]):j=new Microsoft.Maps.Map(e[0],k);var g=d(h.uiMap);g.assign(b,j),a(b,f,j,e)}var j,k=angular.extend({},g,b.$eval(h.uiOptions));b.$on("map.loaded",function(a,b){"bing"!=b||j||i()}),c.Microsoft&&c.Microsoft.Maps&&c.Microsoft.Maps.Map&&i()}}}]),e.value("uiMapInfoWindowConfig",{}).directive("uiMapInfoWindow",["uiMapInfoWindowConfig","$window","$parse","$compile",function(b,c,d,e){var f="click entitychanged mouseenter mouseleave",g=b||{};return{link:function(b,h,i){function j(){if(!m){m=new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(0,0),k),l.assign(b,m),a(b,f,m,h),h.replaceWith("<div></div>");{m.open}m.open=function(){e(h.contents())(b);var a=this.getOptions();a.htmlContent=h.outerHTML,a.visible=!0,this.setOptions(a)}}}var k=angular.extend({},g,b.$eval(i.uiOptions)),l=d(i.uiMapInfoWindow),m=l(b);b.$on("map.loaded",function(a,b){"bing"!=b||m||j()}),c.Microsoft&&c.Microsoft.Maps&&c.Microsoft.Maps.Map&&j()}}}]),b("uiMapMarker","click dblclick drag dragend dragstart entitychanged mousedown mouseout mouseover mouseup rightclick"),e.provider("uiMapLoadParams",function(){var a={};this.setParams=function(b){a=b},this.$get=function(){return a}}).directive("uiMapAsyncLoad",["$window","$parse","uiMapLoadParams",function(a,b,d){return{restrict:"A",link:function(b,e,f){a.mapBingLoadedCallback=function(){b.$broadcast("map.loaded","bing")};var g={v:d.v||"7.0",mkt:d.mkt||"zh-HK,en-US"};if(g=angular.extend({},g,b.$eval(f.uiMapAsyncLoad)),g.onscriptload="mapBingLoadedCallback",a.Microsoft&&a.Microsoft.Maps&&a.Microsoft.Maps.Map)mapBingLoadedCallback();else{var h=document.createElement("script");h.type="text/javascript",h.src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?"+c(g),document.body.appendChild(h)}}}}]);var f=/%20/g}(),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=window,b=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.addLocationHashListener=function(a,b){var c,d;return d=[],c=function(){var a;return this.target?(a=this.target.getCenter(),b.apply(this,[a.latitude,a.longitude,this.target.getZoom()])):void 0},d.push(Microsoft.Maps.Events.addHandler(a,"viewchangeend",c)),d},b.prototype.addToolBar=function(){},b.prototype.setCenter=function(a,b,c){return a.setView({center:new Microsoft.Maps.Location(b,c)})},b.prototype.setZoom=function(a,b){return a.setView({zoom:b})},b.prototype.setZoomAndCenter=function(a,b,c,d){return a.setView({center:new Microsoft.Maps.Location(c,d),zoom:b})},b.prototype.zoomIn=function(a){return this.setZoom(a,a.getZoom()+1)},b.prototype.zoomOut=function(a){return this.setZoom(a,a.getZoom()-1)},b.prototype.setBounds=function(a,b,c){var d;return d=Microsoft.Maps.LocationRect.fromCorners(new Microsoft.Maps.Location(c.lat,b.lng),new Microsoft.Maps.Location(b.lat,c.lng)),a.setView({bounds:d})},b.prototype.inMapView=function(a,b,c){return c=c||this.opts.map,c.getBounds().contains(new Microsoft.Maps.Location(a,b))},b.prototype.pixelToPoint=function(a,b){var c;return c=a.tryPixelToLocation(new Microsoft.Maps.Point(b.x,b.y),Microsoft.Maps.PixelReference.control),{lat:c.latitude,lng:c.longitude}},b.prototype.pointToPixel=function(a,b){return a.tryLocationToPixel(new Microsoft.Maps.Location(b.lat,b.lng),Microsoft.Maps.PixelReference.control)},b.prototype.addMarker=function(a,b,c){var d;return d=new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(b,c)),a.entities.push(d),d},b.prototype.createDraggableMarker=function(a,b,c){var d;return d=new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(b,c),{draggable:!0}),a.entities.push(d),d},b.prototype.activeMarker=function(a){return a?a.setOptions({icon:"images/marker.png",zIndex:2}):void 0},b.prototype.deactiveMarker=function(a){return a?a.setOptions({icon:"",zIndex:1}):void 0},b.prototype.addMarkerActiveListener=function(a,b){var c;return c=function(){return b.apply(a,[])},Microsoft.Maps.Events.addHandler(a,"click",c),Microsoft.Maps.Events.addHandler(a,"dblclick",c),Microsoft.Maps.Events.addHandler(a,"dragend",c),Microsoft.Maps.Events.addHandler(a,"rightclick",c)},b.prototype.addDragendListener=function(a,b){return Microsoft.Maps.Events.addHandler(a,"dragend",function(c){var d;return d=c.entity.getLocation(),b.apply(a,[d.latitude,d.longitude])})},b.prototype.removeMarker=function(a,b){return b.entities.remove(a)},b.prototype.addMapClickListener=function(a,b){return Microsoft.Maps.Events.addHandler(a,"click",function(c){var d,e;return"map"!==c.targetType||c.mouseMoved?void 0:(e=new Microsoft.Maps.Point(c.getX(),c.getY()),d=c.target.tryPixelToLocation(e),b.apply(a,[d.latitude,d.longitude]))})},b.prototype.setPosition=function(a,b,c){return a.setLocation(new Microsoft.Maps.Location(b,c))},b.prototype.setMap=function(){},b}(window.cnmap.IMapEventListener),b.factory=function(){return new cnmap.MapEventListener},window.cnmap=window.cnmap||{},window.cnmap.MapEventListener=b}.call(this),function(){var a,b,c,d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};a=window,b=function(a){function b(a){this.map=a}return e(b,a),b.prototype.init=function(a,b){var c,d,e;return e=this,c=function(){return e.searchManager=new Microsoft.Maps.Search.SearchManager(a),b?b.apply(this.searchManager,[this.searchManager]):void 0},d=function(){return c()},Microsoft.Maps.Search?c():Microsoft.Maps.loadModule("Microsoft.Maps.Search",{callback:d})},b.prototype.getAddress=function(a,b,c){return this.geocoder||this.init(),this.geocoder.getLocation(new window.BMap.Point(b,a),function(a){return a?c.apply(void 0,[a.address]):void 0})},b.prototype.getAddrPois=function(a,b){var c,d,e,f;return c=jQuery.Deferred(),e=function(a){var b,d;return d={},a?(b=a.name,d[b]={poiweight:a.matchConfidence,location:{lat:a.location.latitude,lng:a.location.longitude}},c.resolve(d,a.name)):void 0},d=function(){return console.log("reverseGeocode error")},f={location:new Microsoft.Maps.Location(a,b),count:10,callback:e,errorCallback:d},this.searchManager.reverseGeocode(f),c.promise()},b.prototype.getLocation=function(a,b){return this.geocoder||this.init(),this.geocoder.getPoint(a,function(a){return a?b.apply(void 0,[a]):void 0})},b.prototype.getLocPois=function(a){var b,c,d,e;return b=jQuery.Deferred(),d=function(c,d){var e,f,g,h,i,j,k,l;for(console.log(c),console.log(d),e=[],l=c.results,j=0,k=l.length;k>j;j++)h=l[j],a={address:h.name,location:{lat:h.location.latitude,lng:h.location.longitude},similarity:h.matchConfidence},h.bestView&&(i={lat:h.bestView.center.latitude-h.bestView.height/2},f=h.bestView.center.longitude-h.bestView.width/2,i.lng=-179>f?180+f+180:f,g={lat:h.bestView.center.latitude+h.bestView.height/2},f=h.bestView.center.longitude+h.bestView.width/2,g.lng=f>180?f-180-180:f,a.bounds={sw:i,ne:g}),e.push(a);return b.resolve(e)},c=function(){},e={where:a,count:10,callback:d,errorCallback:c},this.searchManager.geocode(e),b.promise()},b}(window.cnmap.IMapService),c=void 0,b.factory=function(){return c||(c=new window.cnmap.MapService),c},window.cnmap=window.cnmap||{},window.cnmap.MapService=b}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(a&&(this.map=a),this.calcSpotTime(),this.travel){for(k=this.travel.spots,n=[],e=0,h=k.length;h>e;e++){for(d=k[e],l=d.photos,f=0,i=l.length;i>f;f++)b=l[f],this.createMarker(b);for(c=[],m=d.photos,g=0,j=m.length;j>g;g++)b=m[g],c.push(this.createPoint(b));n.push(d.polyline=this.createPolyline(c))}return n}},b.prototype.createPoint=function(a){return new Microsoft.Maps.Location(a.point.lat,a.point.lng)},b.prototype.createMarker=function(a){var b,c;return c=this,b=new Microsoft.Maps.Pushpin(this.createPoint(a),{icon:this.getMarkerImage(a),text:a.title||""}),b.photo=a,this.map.entities.push(b),this.opts.clickable&&Microsoft.Maps.Events.addHandler(b,"click",function(a){return a.mouseMoved?void 0:jQuery(c).trigger("data_clicked",[a.target.photo.id])}),a.marker=b,b},b.prototype.removeMarker=function(a){return a.marker?(this.map.entities.remove(a.marker),delete a.marker):void 0},b.prototype.toggleSpotLine=function(a,b){return a.polyline?a.polyline.setOptions(b?{visible:!0}:{visible:!1}):void 0},b.prototype.spotEditable=function(a,b){var c,d,e,f,g,h,i;for(b=!!b,e=this,c=function(c){return c?(c.setOptions(e.opts.editable&&b?{draggable:!0}:{draggable:!1}),e.opts.editable&&b?c.dragListener=Microsoft.Maps.Events.addHandler(c,"dragend",function(b){var c;return b.target.photo.oPoint||(b.target.photo.oPoint=$.extend({},b.target.photo.point)),c=b.target.getLocation(),b.target.photo.point.lat=c.latitude,b.target.photo.point.lng=c.longitude,e.updateSpotLine(a),$(e).trigger("spot.edited",[a.id])}):(Microsoft.Maps.Events.removeHandler(c.dragListener),delete c.dragListener)):void 0},h=a.photos,i=[],f=0,g=h.length;g>f;f++)d=h[f],i.push(c(d.marker));return i},b.prototype.cancelSpotEdit=function(a){var b,c,d,e,f,g;for(d=this,b=function(a){return a.oPoint&&(a.point=a.oPoint,delete a.oPoint),a.marker?a.marker.setLocation(d.createPoint(a)):void 0},g=a.photos,e=0,f=g.length;f>e;e++)c=g[e],b(c);return this.updateSpotLine(a)},b.prototype.updateSpotLine=function(a){var b,c,d,e,f;for(c=[],f=a.photos,d=0,e=f.length;e>d;d++)b=f[d],c.push(this.createPoint(b));return a.polyline?a.polyline.setLocations(c):a.polyline=this.createPolyline(c)},b.prototype.createPolyline=function(a){var b;return b=new Microsoft.Maps.Polyline(a,{strokeThickness:2}),this.map.entities.push(b),b},b}(window.cnmap.ITravelLayer),window.cnmap.TravelLayer=a}.call(this),function(a){"function"==typeof define&&define.amd?define([window,"jquery","Panoramio"],a):a(window,jQuery)}(function(a,b){return a.cnmap=a.cnmap||{},a.cnmap.PanoramioLayer=function(a){var c,d={};this.preZoom=0,this.preBounds=null,this.opts=b.extend({clickable:!0,auto:!0,mapVendor:"gps"},a),this.opts.map&&this.setMap(this.opts.map),this.getMap=function(){return this.opts.map},this.setMap=function(a){function b(){if($(d).trigger("map_changed",[d.getBounds(),d.getLevel(),d.getSize()]),d.opts.auto){var a=d.getBounds();if(a.ne){d.getBoundsThumbnails(d.getBounds(),d.getLevel(),d.getSize())}}}if(a){this.opts.map=a;var c=Microsoft.Maps.Events.addHandler(a,"tiledownloadcomplete",b);c=Microsoft.Maps.Events.addHandler(a,"viewchangeend",b)}else this.opts.map=void 0;var d=this},this.hideLabel=function(a){var b=d[a];b&&b.setOptions({visible:!1})},this.createMarker=function(a){var e=this.opts.map,f=this,g=d[a.id];g?g.setOptions({visible:!0}):(g=new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(a.point.lat,a.point.lng),{htmlContent:f.getLabelContent(a.oss_key)}),g.photoId=a.id,f.opts.clickable&&Microsoft.Maps.Events.addHandler(g,"click",function(d){f.opts.suppressInfoWindows?(c.setOptions({content:f.getInfoWindowContent(a),position:this.getPosition()}),c.open()):b(f).trigger("data_clicked",[d.target.photoId])}),e.entities.push(g),d[a.id]=g)},this.setOptions=function(a){this.opts=a},this.trigger=function(){this.opts.map&&Microsoft.Maps.Events.invoke(this.opts.map,"viewchangeend")},this.getBounds=function(){var a=this.opts.map.getBounds();return a?{ne:{lat:a.getNorth(),lng:a.getEast()},sw:{lat:a.getSouth(),lng:a.getWest()}}:{}},this.getLevel=function(){return this.opts.map&&parseInt(this.opts.map.getZoom())},this.getSize=function(){return{width:this.opts.map.getWidth(),height:this.opts.map.getHeight()}},this.clearMap=function(){this.opts.map&&this.opts.map.entities.clear(),d=[],this.thumbPhotoIds=[]},this.setAuto=function(a){this.opts.auto=a}},a.cnmap.PanoramioLayer.prototype=new a.cnmap.Panoramio,a.cnmap.PanoramioLayer});