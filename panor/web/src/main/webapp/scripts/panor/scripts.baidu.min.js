"use strict";!function(){function a(a,b,c,d){angular.forEach(b.split(" "),function(b){c.addEventListener(b,function(c){d.triggerHandler("map-"+b,c),a.$$phase||a.$apply()})})}function b(b,c){e.directive(b,[function(){return{restrict:"A",link:function(d,e,f){d.$watch(f[b],function(b){b&&a(d,c,b,e)})}}}])}function c(a,b){var c,e=[],g=function(a,b){b=angular.isFunction(b)?b():null==b?"":b,e[e.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(angular.isArray(a)||a.jquery&&!angular.isObject(a))angular.forEach(a,function(){g(this.name,this.value)});else for(c in a)d(c,a[c],b,g);return e.join("&").replace(f,"+")}function d(a,b,c,e){var f;if(angular.isArray(b))angular.forEach(b,function(b,f){c||rbracket.test(a)?e(a,b):d(a+"["+("object"==typeof b?f:"")+"]",b,c,e)});else if(!c&&angular.isObject(b))for(f in b)d(a+"["+f+"]",b[f],c,e);else e(a,b)}var e=angular.module("ui.map",["ui.event"]);e.value("uiMapConfig",{}).directive("uiMap",["uiMapConfig","$window","$parse","$timeout",function(b,c,d,e){var f="click dblclick rightclick rightdblclick maptypechange mousemove mouseover mouseout movestart moving moveend zoomstart zoomend addoverlay addcontrol removecontrol removeoverlay clearoverlays dragstart dragging dragend addtilelayer removetilelayer load resize hotspotclick hotspotover hotspotout tilesloaded touchstart touchmove touchend longpress",g=b||{};return{restrict:"A",link:function(b,h,i){function j(){l.uiMapCache&&c[i.uiMapCache]?(h.replaceWith(c[i.uiMapCache]),k=c[i.uiMapCache+"Map"]):(k=new BMap.Map(h[0],l),l.ngCenter&&angular.isNumber(l.ngCenter.lat)&&angular.isNumber(l.ngCenter.lng)&&angular.isNumber(l.ngZoom)?k.centerAndZoom(new BMap.Point(l.ngCenter.lng,l.ngCenter.lat),l.ngZoom):l.ngCenter&&angular.isNumber(l.ngCenter.lat)&&angular.isNumber(l.ngCenter.lng)?k.setCenter(new BMap.Point(l.ngCenter.lng,l.ngCenter.lat)):angular.isNumber(l.ngZoom)&&k.setZoom(l.ngZoom),l.scrollzoom&&(k.addControl(new BMap.NavigationControl),k.enableScrollWheelZoom()),l.toolbar&&(k.addControl(new BMap.ScaleControl),k.addControl(new BMap.MapTypeControl)),l.overview&&k.addControl(new BMap.OverviewMapControl));var e=d(i.uiMap);e.assign(b,k),a(b,f,k,h)}var k,l=angular.extend({},g,b.$eval(i.uiOptions));b.$on("map.loaded",function(a,b){"baidu"!=b||k||j()}),c.BMap&&c.BMap.Map&&e(function(){j()},200)}}}]),e.value("uiMapInfoWindowConfig",{}).directive("uiMapInfoWindow",["uiMapInfoWindowConfig","$window","$parse","$compile",function(b,c,d,e){var f="close open maximize restore clickclose",g=b||{};return{link:function(b,h,i){function j(){m||(m=new c.BMap.InfoWindow(h[0],k),l.assign(b,m)),a(b,f,m,h),h.replaceWith("<div></div>");var d=m.redraw;m.redraw=function(a,c,f,g,i,j){e(h.contents())(b),d.call(m,a,c,f,g,i,j)}}var k=angular.extend({},g,b.$eval(i.uiOptions)),l=d(i.uiMapInfoWindow),m=l(b);b.$on("map.loaded",function(a,b){"baidu"!=b||m||j()}),c.BMap&&c.BMap.Map&&j()}}}]),b("uiMapMarker","click dblclick mousedown mouseup mouseout mouseover remove infowindowclose infowindowopen dragstart dragging dragend rightclick"),b("uiMapPolyline","click dblclick mousedown mouseup mouseout mouseover remove lineupdate"),b("uiMapPolygon","click dblclick mousedown mouseup mouseout mouseover remove lineupdate"),b("uiMapCircle","click dblclick mousedown mouseup mouseout mouseover remove lineupdate"),e.provider("uiMapLoadParams",function(){var a={};this.setParams=function(b){a=b},this.$get=function(){return a}}).directive("uiMapAsyncLoad",["$window","$parse","uiMapLoadParams",function(a,b,d){return{restrict:"A",link:function(b,e,f){a.mapbaiduLoadedCallback=function(){b.$broadcast("map.loaded","baidu")};var g=angular.extend({},d,b.$eval(f.uiMapAsyncLoad));if(g.callback="mapbaiduLoadedCallback",a.BMap&&a.BMap.Map)mapbaiduLoadedCallback();else{var h=document.createElement("script");h.type="text/javascript",h.src="http://api.map.baidu.com/api?"+c(g),document.body.appendChild(h)}}}}]);var f=/%20/g}(),function(){var a,b;a=function(a,b){var c,d;return c=document.getElementsByTagName("head")[0],d=document.createElement("script"),d.type="text/javascript",d.src=a,d.onload=d.onreadystatechange=function(){return this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(b&&b(),d.onload=d.onreadystatechange=null,!c||!d.parentNode)?void 0:c.removeChild(d)},c.insertBefore(d,c.firstChild)},b=function(b,c,d){var e,f;return e="cbk_"+Math.round(1e4*Math.random()),f="http://api.map.baidu.com/ag/coord/convert?from="+c+"&to=4&x="+b.lng+"&y="+b.lat+"&callback=BMap.Convertor."+e,a(f),BMap.Convertor[e]=function(a){return delete BMap.Convertor[e],b=new BMap.Point(a.x,a.y),d&&d(b)}},window.BMap=window.BMap||{},BMap.Convertor={},BMap.Convertor.translate=b}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=window.BMap,b=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.trigger=function(a,b){var c,d,e,f,g,h;for(e=a._e_||{},h=[],f=0,g=e.length;g>f;f++)d=e[f],d._eventName===b&&(c=Array.prototype.slice.call(arguments,2),h.push(d._handler.apply(a,c)));return h},b}(window.ponm.IMapEvent),window.ponm.MapEvent=new b}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=window,b=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b.prototype.addLocationHashListener=function(a,b){var c,d;return d=[],c=function(){var a;return a=this.getCenter(),b.apply(this,[a.lat,a.lng,this.getZoom()])},d.push(a.addEventListener("moveend",c)),d.push(a.addEventListener("zoomend",c)),d.push(a.addEventListener("dragend",c)),d},b.prototype.addToolBar=function(a){return a.addControl(new window.BMap.NavigationControl),a.addControl(new window.BMap.ScaleControl),a.addControl(new window.BMap.OverviewMapControl),a.addControl(new window.BMap.MapTypeControl)},b.prototype.setCenter=function(a,b,c){return a.setCenter(new BMap.Point(c,b))},b.prototype.setZoom=function(a,b){return a.setZoom(b)},b.prototype.setZoomAndCenter=function(a,b,c,d){var e;return e=new BMap.Point(d,c),a.centerAndZoom(e,b)},b.prototype.zoomIn=function(a){return a.zoomIn()},b.prototype.zoomOut=function(a){return a.zoomOut()},b.prototype.setBounds=function(a,b,c){return a.setViewport([new BMap.Point(b.lng,b.lat),new BMap.Point(c.lng,c.lat)])},b.prototype.inMapView=function(a,b,c){return c=c||this.opts.map,c.getBounds().containsPoint(new BMap.Point(b,a))},b.prototype.pixelToPoint=function(a,b){return a.pixelToPoint(new BMap.Pixel(b.x,b.y))},b.prototype.pointToPixel=function(a,b){return a.pointToPixel(new BMap.Point(b.lng,b.lat))},b.prototype.addMarker=function(a,b,c){var d;return d=new BMap.Marker(new BMap.Point(c,b)),a.addOverlay(d),d},b.prototype.createDraggableMarker=function(a,b,c){var d;return d=new BMap.Marker(new BMap.Point(c,b),{enableDragging:!0}),a.addOverlay(d),d},b.prototype.activeMarker=function(a){return a?(a.defaultIcon=a.getIcon(),a.setIcon(new BMap.Icon("images/marker.png",new BMap.Size(20,30),{anchor:new BMap.Size(10,30)})),a.setZIndex(2)):void 0},b.prototype.deactiveMarker=function(a){return a&&a.defaultIcon?(a.setIcon(a.defaultIcon),a.setZIndex(1)):void 0},b.prototype.addMarkerActiveListener=function(a,b){var c;return c=function(){return b.apply(a,[])},a.addEventListener("click",c),a.addEventListener("dragend",c),a.addEventListener("rightclick",c)},b.prototype.addDragendListener=function(a,b){return a.addEventListener("dragend",function(c){return b.apply(a,[c.point.lat,c.point.lng])})},b.prototype.removeMarker=function(a){var b;return b=a.getMap(),b?b.removeOverlay(a):void 0},b.prototype.addMapClickListener=function(a,b){return a.addEventListener("click",function(c){return b.apply(a,[c.point.lat,c.point.lng])})},b.prototype.setPosition=function(a,b,c){return a.setPosition(new BMap.Point(c,b))},b.prototype.setMap=function(a,b){return b.addOverlay(a)},b}(window.cnmap.IMapEventListener),b.factory=function(){return new cnmap.MapEventListener},window.cnmap=window.cnmap||{},window.cnmap.MapEventListener=b}.call(this),function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=window,b=function(a){function b(a){this.map=a}return d(b,a),b.prototype.init=function(a,b){return this.geocoder=new window.BMap.Geocoder,b?b.apply(this.geocoder,[this.geocoder]):void 0},b.prototype.getAddress=function(a,b,c){return this.geocoder||this.init(),this.geocoder.getLocation(new window.BMap.Point(b,a),function(a){return a?c.apply(void 0,[a.address]):void 0})},b.prototype.getAddrPois=function(a,b){var c;return c=jQuery.Deferred(),this.geocoder.getLocation(new window.BMap.Point(b,a),function(a){var b;return console.log(a),b={},a&&$.each(a.surroundingPois,function(a,c){var d;return d=c.title?c.address+" "+c.title:c.address,b[d]={poiweight:1,location:c.point}}),c.resolve(b,a.address)}),c.promise()},b.prototype.getLocation=function(a,b){return this.geocoder||this.init(),this.geocoder.getPoint(a,function(a){return a?b.apply(void 0,[a]):void 0})},b.prototype.getLocPois=function(a){var b;return b=jQuery.Deferred(),this.geocoder||this.init(),this.geocoder.getPoint(a,function(c){var d;return d=[],c&&d.push({address:a,location:c,similarity:1}),b.resolve(d)}),b.promise()},b.prototype.translate=function(){},b}(window.cnmap.IMapService),b.factory=function(){return new window.cnmap.MapService},window.cnmap=window.cnmap||{},window.cnmap.MapService=b}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};a=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return c(b,a),b.prototype.initMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(a&&(this.map=a),this.calcSpotTime(),c=[],this.travel){for(k=this.travel.spots,n=[],e=0,h=k.length;h>e;e++){for(d=k[e],l=d.photos,f=0,i=l.length;i>f;f++)b=l[f],b.point&&this.createMarker(b);for(c=[],m=d.photos,g=0,j=m.length;j>g;g++)b=m[g],b.point&&c.push(this.createPoint(b));d.polyline=new BMap.Polyline(c,{map:this.map,strokeWeight:2}),n.push(this.map.addOverlay(d.polyline))}return n}},b.prototype.createPoint=function(a){return new BMap.Point(a.point.lng,a.point.lat)},b.prototype.createMarker=function(a){var b,c;if(a.point)return c=this,b=new BMap.Marker(this.createPoint(a),{icon:new BMap.Icon(this.getMarkerImage(a),{width:34,height:34}),title:a.title||""}),b.photo=a,this.map.addOverlay(b),this.opts.clickable&&b.addEventListener("click",function(){return jQuery(c).trigger("data_clicked",[this.photo.id])}),a.marker=b,b},b.prototype.removeMarker=function(a){return a.marker?(this.map.removeOverlay(a.marker),delete a.marker):void 0},b.prototype.toggleSpotLine=function(a,b){return a.polyline?b?a.polyline.show():a.polyline.hide():void 0},b.prototype.spotEditable=function(a,b){var c,d,e,f,g,h,i;for(b=!!b,e=this,c=function(c){return c?(e.opts.editable&&b?c.enableDragging():c.disableDragging(),e.opts.editable&&b?c.addEventListener("dragend",function(b){return this.photo.oPoint||(this.photo.oPoint=$.extend({},this.photo.point)),this.photo.point.lat=b.point.lat,this.photo.point.lng=b.point.lng,e.updateSpotLine(a),$(e).trigger("spot.edited",[a.id])}):c.removeEventListener("dragend")):void 0},h=a.photos,i=[],f=0,g=h.length;g>f;f++)d=h[f],i.push(c(d.marker));return i},b.prototype.cancelSpotEdit=function(a){var b,c,d,e,f,g;for(d=this,b=function(a){return a.oPoint&&(a.point=a.oPoint,delete a.oPoint),a.marker?a.marker.setPosition(d.createPoint(a)):void 0},g=a.photos,e=0,f=g.length;f>e;e++)c=g[e],b(c);return this.updateSpotLine(a)},b.prototype.updateSpotLine=function(a){var b,c,d,e,f;for(c=[],f=a.photos,d=0,e=f.length;e>d;d++)b=f[d],c.push(this.createPoint(b));return a.polyline?a.polyline.setPath(c):(a.polyline=new BMap.Polyline(c,{map:this.map,strokeStyle:"dashed"}),this.map.addOverlay(a.polyline))},b}(window.cnmap.ITravelLayer),window.cnmap.TravelLayer=a}.call(this),function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window)}(function(a){return a.cnmap=a.cnmap||{},a.cnmap.PanoramioLayer=function(a){var b,c=[];this.preZoom=0,this.preBounds=null,this.opts=$.extend({clickable:!0,auto:!0,mapVendor:"baidu"},a),this.opts.map&&this.setMap(this.opts.map),this.getMap=function(){return this.opts.map},this.setMap=function(c){function d(){e.loadPhotos()}c?(this.opts.map=c,b=new BMap.InfoWindow(""),b.enableCloseOnClick(),c.addOverlay(b),c.addEventListener("load",d),c.addEventListener("tilesloaded",d),c.addEventListener("zoomend",d),c.addEventListener("moveend",d)):(a.map=null,c.clearOverlays(),c.removeEventListener("tilesloaded"),c.removeEventListener("zoomend"),c.removeEventListener("moveend"));var e=this},this.loadPhotos=function(){var a=this,b=this.opts.map;if($(a).trigger("map_changed",[a.getBounds(),a.getLevel(),a.getSize()]),a.opts.auto){b.getBounds(),b.getSize(),a.getBoundsThumbnails(a.getBounds(),a.getLevel(),a.getSize())}},this.hideLabel=function(a){c[a]&&this.opts.map.removeOverlay(c[a])},this.createMarker=function(d){var e=this.opts.map,f=this,g=c[d.id];g?e.addOverlay(g):(g=new BMap.Label,g.setContent(f.getLabelContent(d.oss_key)),g.setPosition(new BMap.Point(d.point.lng,d.point.lat)),g.photoId=d.id,g.setZIndex(1),g.setStyle({border:0,padding:"0",fontSize:"12px",lineHeight:"20px",fontFamily:"微软雅黑"}),f.opts.clickable&&g.addEventListener("click",function(){a.suppressInfoWindows?b.isOpen()?b.close():(b.setContent(panoramio.getInfoWindowContent(this.photoId)),e.openInfoWindow(b,this.getPosition())):$(f).trigger("data_clicked",[this.photoId])}),c[d.id]=g,e.addOverlay(g))},this.setOptions=function(b){a=b},this.trigger=function(){this.opts.map&&this.loadPhotos()},this.getBounds=function(){var a=this.opts.map.getBounds();return{ne:{lat:a.getNorthEast().lat,lng:a.getNorthEast().lng},sw:{lat:a.getSouthWest().lat,lng:a.getSouthWest().lng}}},this.getLevel=function(){return this.opts.map.getZoom()},this.getSize=function(){return this.opts.map.getSize()},this.clearMap=function(){c=[],this.thumbPhotoIds=[],this.opts.map&&this.opts.map.clearOverlays()}},a.cnmap.PanoramioLayer.prototype=new a.cnmap.Panoramio,a.cnmap.PanoramioLayer});