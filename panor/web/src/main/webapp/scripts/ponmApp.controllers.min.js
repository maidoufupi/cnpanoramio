"use strict";angular.module("ponmApp.controllers",["ngAnimate","ponmApp","xeditable","ui.map","ui.bootstrap"]).run(["editableOptions","editableThemes",function(a,b){a.theme="bs3",b.bs3.submitTpl='<button type="submit" class="btn btn-info">提交</button>',b.bs3.cancelTpl='<button type="button" class="btn btn-default" ng-click="$form.$cancel()">取消</button>'}]),angular.module("adminApp",["ui.bootstrap","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/admin","/admin/manager"),a.state("admin",{"abstract":!0,url:"/admin",views:{"":{templateUrl:"views/admin.html",controller:"AdminCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"},alert:{templateUrl:"views/ponm.alert.html",controller:"AlertsCtrl"}},resolve:{}}).state("admin.manager",{url:"/manager",templateUrl:"views/admin.manager.html",resolve:{},controller:"AdminManagerCtrl"})}]).run(["$rootScope","$window","editableOptions",function(a,b,c){c.theme="bs3"}]).controller("AdminCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","HashStateManager",function(a,b,c,d,e,f,g){d.ctx=g.ctx,d.staticCtx=g.staticCtx,d.apirest=g.apirest,d.userId=g.userId,d.login=g.login,d.ponmCtxConfig=g}]).controller("AdminManagerCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","alertService","PanoramioService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.updatePanoramioIndex=function(){n.get(function(a){h.debug(a),m.clear(),m.add("success","更新成功",2e3)})},d.updatePanoramioLatest=function(){n.get({action:"latest"},function(a){h.debug(a),m.clear(),m.add("success","更新成功",2e3)})}}]),angular.module("ponmApp.controllers").controller("ChUserAvatarCtrl",["$window","$scope","$log","$sce","$http","$modalInstance","$timeout","alertService",function(a,b,c,d,e,f,g,h){b.alertService=angular.copy(h);var i=a.apirest+"/user/avatar";b.cancel=function(){f.dismiss(b.avatar)};var j=a.URL&&a.URL.createObjectURL.bind(a.URL)||a.webkitURL&&a.webkitURL.createObjectURL.bind(a.webkitURL)||a.createObjectURL;b.fileUpload=function(){if(b.alertService.clear(),b.$$childTail.$$childTail.previewUrl){var a=Math.random().toString().substr(2),c="";c+="--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="avatar.png"\r\nContent-type: application/octet-stream\r\n\r\n'+b.$$childTail.$$childTail.previewUrl+"\r\n",c+="--"+a+"--\r\n",e({method:"POST",url:i,data:c,headers:{"Content-Type":"multipart/form-data; charset=utf-8; boundary="+a}}).success(function(a){"OK"==a.status?(b.avatar=a.open_info.avatar,b.alertService.add("success","上传成功!",5e3),g(function(){b.cancel()},1e3)):b.alertService.add("danger","上传失败!",5e3)})}},b.onFileSelect=function(a){b.alertService.clear();var c=d.trustAsResourceUrl(j(a[0]));b.imageUrl=c}}]).directive("imgCropped",function(){return{restrict:"E",scope:{src:"@",previewUrl:"=previewUrl"},link:function(a,b){function c(b){var c=d[0],f=c.width,g=c.height,h=$(c).width(),i=$(c).height(),j=b.x*f/h,k=b.y*g/i,l=b.w*f/h,m=b.h*g/i,n=document.createElement("canvas");n.width=100,n.height=100;var o=n.getContext("2d");o.drawImage(c,j,k,l,m,0,0,100,100),a.$apply(function(){a.previewUrl=n.toDataURL("image/png"),e.attr("src",a.previewUrl)})}var d,e,f=500,g=420,h=function(){d&&(d.next().remove(),d.remove(),d=void 0),e&&(e.next().remove(),e.remove(),e=void 0)};a.$watch("src",function(a){h(),a&&(b.after("<img />"),f=b.parent().innerWidth(),g=b.parent().innerHeight()-110,d=b.next(),d.attr("src",a),$(d).Jcrop({trackDocument:!0,bgFade:!0,boxWidth:f,boxHeight:g,minSize:[16,16],onSelect:c,aspectRatio:1}),d.after('<img class="thumbnail"/>'),e=d.next())}),a.$on("$destroy",h)}}}).directive("ngFileSelect",["$parse","$timeout",function(a,b){return function(c,d,e){var f=a(e.ngFileSelect);d.bind("change",function(a){var d,e,g=[];if(d=a.target.files,null!=d)for(e=0;e<d.length;e++)g.push(d.item(e));b(function(){f(c,{$files:g,$event:a})})}),d.bind("click",function(){this.value=null})}}]),angular.module("ponmApp.dynamic",["ui.bootstrap","ngAnimate","ui.router","ponmApp","xeditable","ngDragDrop","perfect_scrollbar"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/dynamic","/dynamic/my"),a.state("dynamic",{"abstract":!0,url:"/dynamic",views:{"":{templateUrl:"views/dynamic.html",controller:"DynamicCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"},alert:{templateUrl:"views/ponm.alert.html",controller:"AlertsCtrl"}}}).state("dynamic.my",{url:"/my",templateUrl:"views/dynamic.my.html",resolve:{},controller:"DynamicMyCtrl"}).state("dynamic.popular",{url:"/popular",templateUrl:"views/dynamic.popular.html",resolve:{},controller:"DynamicPopularCtrl"})}]).run(["$rootScope","$window","editableOptions",function(a,b,c){c.theme="bs3"}]).factory("MessageManager",["$q","UserService",function(a,b){function c(c){this.userId=c,this.pageSize=10,this.pageNo=1,this.ended=!1,this.getMoreMessages=function(){var c=a.defer();this.loading&&c.reject("loading"),this.ended&&c.reject("ended"),this.loading=!0;var d=this;return b.getMessages({userId:this.userId,value:this.pageSize,action:this.pageNo},function(a){d.loading=!1,"OK"==a.status?(d.pageNo++,a.messages.length<d.pageSize&&(d.ended=!0),c.resolve(a.messages)):c.reject(a.status)},function(a){d.loading=!1,c.reject(a)}),c.promise}}return c}]).controller("DynamicCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","HashStateManager",function(a,b,c,d,e,f,g){d.ctx=g.ctx,d.staticCtx=g.staticCtx,d.apirest=g.apirest,d.userId=g.userId,d.login=g.login,d.ponmCtxConfig=g,d.displayPhoto=function(a){d.photoDisplayModal=f.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}}),d.photoDisplayModal.result.then(function(){d.photoDisplayModal=null},function(){d.photoDisplayModal=null})},d.$on("photo.click",function(a,b){d.displayPhoto(b)})}]).controller("DynamicMyCtrl",["$log","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$state","$stateParams","$timeout","safeApply","jsUtils","MessageManager",function(a,b,c,d,e,f,g,h,i,j,k,l,m){d.$watch(function(){return g.userId},function(a){a&&(d.userId=a,d.messages=[],d.messageManager=new m(d.userId),d.onLoadWaypoint())}),d.onLoadWaypoint=function(){d.messageManager&&d.messageManager.getMoreMessages().then(function(a){d.$broadcast("message.add",a)})}}]).controller("DynamicPopularCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","UserService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.userId=g.userId,d.userId,d.messages=[],d.message={user:{id:5,name:"暗梅幽闻花",avatar:3,tags:[],travels:[]},type:"photo",photo:{id:2,point:{lat:35,lng:116,alt:0},vendor:"gaode",is360:!1,tags:[],create_time:1388509261e3,user_id:1,like_count:0,fav_count:0,comment_count:1,file_name:"filename2.jpg",oss_key:"2.jpg",description:"日本平价超市玉出超市歧视中国货呀，同样的中国进口蔬菜只卖日本当地蔬菜25%～50%的价格，怒而支持中国货。#为洗白汉奸罪名努力"},travel:null,content:"日本平价超市玉出超市歧视中国货呀，同样的中国进口蔬菜只卖日本当地蔬菜25%～50%的价格，怒而支持中国货。#为洗白汉奸罪名努力",tags:["#中国","#当地蔬菜同样","#歧视"],comment_count:1,comments:[{id:5,username:"卧似透春绿",content:"comment content 5",user_id:2,user_avatar:1,photo_id:2,like_count:0},{id:6,username:"卧似透春绿",content:"comment content 5",user_id:2,user_avatar:1,photo_id:2,like_count:0},{id:7,username:"卧似透春绿",content:"comment content 5",user_id:2,user_avatar:1,photo_id:2,like_count:0},{id:8,username:"卧似透春绿",content:"comment content 5",user_id:2,user_avatar:1,photo_id:2,like_count:0}]},d.travelMessage={id:2,user:{id:1,name:"暗梅幽闻花",avatar:1,tags:[],travels:[]},type:"travel",travel:{id:1,username:"暗梅幽闻花",user:{id:1,name:"暗梅幽闻花",avatar:1,tags:[],travels:[]},spots:[{id:1,photos:[{id:20,description:"环境的人员落户问题\n。不断提高高校毕业生、技术工人、职业院校毕业生、留学\n回国人员等常住人口的城",point:{lat:31.271875981148757,lng:121.22485131566845,alt:0,address:"上海市嘉定区安亭镇新黄路4号"},vendor:"gaode",is360:!1,tags:[],create_time:14066907e5,user_id:1,travel_id:1,travel_name:"无锡执行",like_count:0,fav_count:0,comment_count:0,file_size:147239,file_name:"1280x800_174948801.jpg",oss_key:"20.jpg"},{id:19,description:"环境的人员落户问题。不断提高高校毕业生、技术工人、职业院校毕业生、留学回国人员等常住人口的城",point:{lat:31.133046283915075,lng:121.55972960604899,alt:0,address:"上海市浦东新区康桥镇秀沿路216号"},vendor:"gaode",is360:!1,tags:[],create_time:14066907e5,user_id:1,travel_id:1,travel_name:"无锡执行",like_count:0,fav_count:0,comment_count:0,file_size:192250,file_name:"7c1ed21b0ef41bd5e8024d4e51da81cb39db3d32.jpg",oss_key:"19.jpg"},{id:18,description:"意见要求，有效解决户口迁移中的重点问题。认真落实优先解决存量的要求，重点解决进城时间长、就业能力强、可以适",point:{lat:31.078034825814516,lng:121.35820231534143,alt:0,address:"上海市松江区新桥镇春申站"},vendor:"gaode",is360:!1,tags:[],create_time:14066907e5,user_id:1,travel_id:1,travel_name:"无锡执行",like_count:0,fav_count:0,comment_count:0,file_size:817129,file_name:"7.jpg",oss_key:"18.jpg"},{id:17,description:"意见要求，建立与统一城乡户口登记制度相适应的教育、卫生计生、就业、社保、住房、土地及人口统计制度。",point:{lat:31.177952658241825,lng:121.47486773742938,alt:0,address:"上海市浦东新区上钢新村街道后滩公园"},vendor:"gaode",is360:!1,tags:[],create_time:14066907e5,user_id:1,travel_id:1,travel_name:"无锡执行",like_count:0,fav_count:0,comment_count:0,file_size:793901,file_name:"5.jpg",oss_key:"17.jpg"},{id:21,description:"群众来信向中纪委反映党中央主席华国锋的三件事：\n一是华国锋去江苏视察，外出沿途搞戒严，影响交通，",point:{lat:31.067125680105704,lng:121.62285129518345,alt:0,address:"上海市浦东新区航头镇航头镇王楼村文化活动中心"},vendor:"gaode",is360:!1,tags:[],create_time:14066907e5,user_id:1,travel_id:1,travel_name:"无锡执行",like_count:0,fav_count:0,comment_count:0,file_size:58388,file_name:"1280x800_235523352.jpg",oss_key:"21.jpg"},{id:16,title:"美丽湖泊",description:"口与非农业户口\n性质区分和由此衍生的蓝印户口等户口类型，\n统一登记为居民户口，体现户籍制度的人口登记管理功能。",point:{lat:31.269543179119353,lng:121.49404005045348,alt:0,address:"上海市虹口区欧阳路街道祥德路274弄小区"},vendor:"gaode",is360:!0,tags:[],create_time:14066907e5,user_id:1,travel_id:1,travel_name:"无锡执行",like_count:0,fav_count:0,comment_count:2,file_size:448201,file_name:"2.jpg",oss_key:"16.jpg"}],address:"云南省大理白族自治州大理市洱海管理处云洱渔家",title:"大理洱海",description:"大理洱海鱼鹰\n捕鱼表演\n十分好看",travel_id:1},{id:2,photos:[],travel_id:1}],title:"无锡执行",user_id:1,album_cover:"1.jpg",photo_size:6},tags:[],comments:[]},d.messages.push(angular.copy(d.travelMessage))}]).controller("DynamicMessageCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","HashStateManager",function(a,b,c,d){d.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10}}]),angular.module("indexApp",["ponmApp"]).controller("IndexCtrl",["$window","$scope","alertService",function(a,b,c){function d(a){$(".front-photo_sizer img").attr("src",ctx+"/api/rest/photo/"+a.id+"/1"),$(".front-photo_sizer a").attr("href",ctx+"/photo/"+a.id),e.setCenter(b.map,a.lat,a.lng),a.mark||(a.mark=!0,e.createDraggableMarker(b.map,a.lat,a.lng)),$("div.imgLiquidFill").imgLiquid({fill:!0}),f.length>1&&setTimeout(function(){d(f[g]),g=(g+1)%f.length},4e3)}b.alertService=c;var e=a.cnmap.MapEventListener.factory();b.mapOptions={resizeEnable:!0,panControl:!1,zoomControl:!1,uiMapCache:!1},$("div.imgLiquidFill").imgLiquid({fill:!0});var f,g,h=new $.RestClient(window.ctx+"/api/rest/");h.add("index"),h.index.read("photo").done(function(a){f=a,g=0,f.length&&(d(f[g]),g=(g+1)%f.length)})}]),angular.module("ponmApp.login",["ponmApp","ui.router","ngAnimate"]).config(["$stateProvider","$urlRouterProvider",function(a){a.state("login",{url:"",views:{"":{templateUrl:"views/ponm.login.html",controller:"LoginCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"}},resolve:{}}).state("signup",{url:"/signup",views:{"":{templateUrl:"views/ponm.signup.html",controller:"SignupCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"}},resolve:{}})}]).controller("LoginCtrl",["$scope","$log","$q","jsUtils","$location","$state","AuthService","ponmCtxConfig",function(a,b,c,d,f,g,h,i){a.ponmCtxConfig=i,a.$log=b,h.checkLogin().then(function(){g.go("maps.popular",{})}),a.loginError=!!f.search().login_error,a.credentials={},a.login=function(b,c){a.userForm.$valid&&h.loginCheck(c).then(function(){},function(){a.loginError=!0})},a.loginSubmit=function(c,d){return a.userForm.$valid?void h.loginCheck(d).then(function(){return a.loginError=!1,!0},function(){return a.loginError=!0,b.debug(c),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation(),c.preventDefault(),c.stopPropagation(),!0}):!1},a.passwordHint=function(){a.credentials.username?f.$$absUrl=ctx+"/passwordHint?username="+a.credentials.username:(alert("用户名 为必填项。"),e.preventDefault(),e.stopPropagation())},a.cancel=function(){$modalInstance.dismiss("cancel")},a.ok=function(){$modalInstance.close()}}]).controller("SignupCtrl",["$window","$scope","$log","$q","jsUtils","$location","$cookieStore","AuthService","ponmCtxConfig",function(a,b,c,d,e,f,g,h,i){b.ponmCtxConfig=i,b.user={}}]),angular.module("ponmApp.maps",["ui.bootstrap","ui.map","ui.router","xeditable","fileuploadApp","ngDragDrop","ui.bootstrap.datetimepicker"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/maps","/maps/popular"),a.state("maps",{"abstract":!0,url:"/maps",views:{"":{templateUrl:"views/maps.html",controller:"MapsCtrl"},"alerts@maps":{templateUrl:"views/photos.alerts.html",controller:"PhotosAlertsCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"}},resolve:{}}).state("maps.popular",{url:"/popular",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsPopularCtrl"}).state("maps.recent",{url:"/recent",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsRecentCtrl"}).state("maps.travel",{url:"/travel/:travelId",templateUrl:"views/maps.travel.html",resolve:{},controller:"MapsTravelCtrl"}).state("maps.photo",{url:"/photo",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsRecentCtrl"}).state("maps.camera",{url:"/camera",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsRecentCtrl"}).state("maps.user",{url:"/user/:userId",templateUrl:"views/maps.user.html",resolve:{},controller:"MapsUserCtrl"}).state("maps.travels",{url:"/travels",templateUrl:"views/maps.travels.html",resolve:{},controller:"MapsTravelsCtrl"}).state("maps.upload",{url:"/upload",templateUrl:"views/upload.html",resolve:{},controller:"MapsPhotoUploadCtrl"}).state("maps.dynamic",{url:"/dynamic",templateUrl:"views/maps.dynamic.html",resolve:{},controller:"MapsDynamicCtrl"})}]).run(["$rootScope","$window","editableOptions",function(a,b,c){c.theme="bs3",a.user={id:b.userId}}]).service("MapsConfigService",["$rootScope","localStorageService",function(a,b){function c(a){var c=b.get(d),g=b.get(e),h=b.get(f);c&&g&&h&&(a.ngCenter={lat:c,lng:g},a.ngZoom=h)}var d="CON_MAPS_CACHE_LAT",e="CON_MAPS_CACHE_LNG",f="CON_MAPS_CACHE_ZOOM";this.getConfig=function(){var b={ngCenter:{lat:35,lng:116},ngZoom:8,scrollzoom:!0,maptype:!0,overview:!0,rotateEnable:!0,resizeEnable:!0,scaleControl:!0};if(a.cache){var g=a.cache.get(d),h=a.cache.get(e),i=a.cache.get(f);g&&h&&i?(b.ngCenter={lat:g,lng:h},b.ngZoom=i):c(b)}else c(b);return b},this.updateCenter=function(c,g,h){a.cache&&(a.cache.put(d,c),a.cache.put(e,g),a.cache.put(f,h)),b.set(d,c),b.set(e,g),b.set(f,h)},this.hasStatus=function(){if(a.cache){var c=a.cache.get(d),g=a.cache.get(e),h=a.cache.get(f);return c&&g&&h||(c=b.get(d),g=b.get(e),h=b.get(f)),!!(c&&g&&h)}}}]).controller("MapsCtrl",["$window","$location","$rootScope","$scope","$q","PhotoService","UserService","PanoramioService","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","HashStateManager","alertService","matchmedia","$cacheFactory","localStorageService","MapsConfigService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){function w(a){var b=a.name;b=b.replace("maps.",""),d.stateStatus={},d.stateStatus[b]=!0,s.isPhone()?d.stateStatus.dynamic||d.stateStatus.upload?(d.layoutManager.setLayout(d.layoutManager.rightFull),d.setPanormaioType("manual")):d.layoutManager.setLayout(d.layoutManager.leftFull):d.stateStatus.dynamic||d.stateStatus.upload?(d.layoutManager.setLayout(d.layoutManager.leftFixed),d.setPanormaioType("manual")):d.layoutManager.setLayout(d.layoutManager.rightFixed),angular.forEach(d.navbar,function(a){a.active=!1,a.name==b&&(a.active=!0)}),d.$broadcast("dynamic.menu")}function x(a){navigator.geolocation?(k.debug("navigator.geolocation get current postion"),navigator.geolocation.getCurrentPosition(function(b){d.mapEventListener.setCenter(a,b.coords.latitude,b.coords.longitude)},function(a){k.error("Error: Your browser doesn't support geolocation."),k.debug(a)})):k.error("Error: Your browser doesn't support geolocation.")}function y(a){E=d.mapEventListener.addLocationHashListener(a,function(a,b,c){A=a,B=b,C=c,d.setState&&n.cancel(d.setState),D=!0,d.hashStateManager&&d.hashStateManager.set({lat:a,lng:b,zoom:c}),d.setState=n(function(){D=!1},500)}),d.hashStateManager.bindingWatch("lat lng zoom bounds",function(b,c,e,f){if(d.setState&&n.cancel(d.setState),D=!0,e&&b&&c?d.mapEventListener.setZoomAndCenter(a,e,b,c):(b&&c&&d.mapEventListener.setCenter(a,b,c),e&&d.mapEventListener.setZoom(a,e)),d.setState=n(function(){D=!1},500),f){var g=f.split(",");4==g.lenght&&d.mapEventListener.setBounds(a,{lat:g[0],lng:g[1]},{lat:g[2],lng:g[3]})}d.searchVal&&n(function(){d.$broadcast("searchChanged",d.searchVal)},500)})}d.ctx=j.ctx,d.staticCtx=j.staticCtx,d.apirest=j.apirest,d.userId=j.userId,d.login=j.login,d.ponmCtxConfig=j,d.user={},d.$watch(function(){return j.userId},function(a){d.userId=a,d.login=j.login,!d.user.id&&a&&d.setMenu("user",{id:a,name:"我"})}),d.$state=l,d.$location=b,d.$stateParams=m,d.alertService=angular.copy(r),d.alertService.options.alone=!0,d.alertService.options.ttl=1e3,d.editableView=!0,d.$watch("editableView",function(a){d.$broadcast("editableViewChanged",a)}),d.changeEditableView=function(){d.editableView=!d.editableView,d.$broadcast("editableViewChanged",d.editableView)},d.navbarFixedTop=!1,d.hashStateManager=new q(d,b),d.mapOptions=v.getConfig(),d.mapEventListener=a.cnmap.MapEventListener.factory(),d.mapService=a.cnmap.MapService.factory();var z=new cnmap.PanoramioLayer({suppressInfoWindows:!1});d.panoramioLayer=z,z.initEnv(j.ctx,d.staticCtx),jQuery(z).bind("data_changed",function(a,b){d.stateStatus.user||d.$apply(function(){d.photos=p.Array.mergeRightist(d.photos||[],b,"id"),d.$broadcast("ponm.photo.fluid.resize",{})})}),jQuery(z).bind("data_clicked",function(a,b){d.displayPhoto(b)}),d.setPanormaioType=function(a,b){switch(d.tabs={},d.tabs[a]=!0,b&&(d.login&&b==d.userId?d.setMenu("user",{id:b,name:"我"}):(d.setMenu("user",{id:b,name:""}),g.getOpenInfo({userId:b},function(a){"OK"==a.status&&a.open_info&&d.setMenu("user",a.open_info)}))),z.setFavorite(!1),z.setUserId(""),z.setLatest(!1),z.setAuto(!0),z.clearMap(),a){case"user":z.setFavorite(!1),z.setUserId(d.user.id);break;case"popular":z.setUserId(void 0);break;case"recent":z.setLatest(!0);break;case"favorite":z.setFavorite(!0),z.setUserId(d.user.id);break;case"manual":z.setAuto(!1);break;case"auto":z.setAuto(!0)}z.trigger("changed")},d.layoutManager={index:0,layouts:["maps-right-fixed","maps-left-fixed","maps-right-full","maps-left-full"],rightFixed:0,leftFixed:1,rightFull:2,leftFull:3,getLayout:function(){return this.layouts[this.index]},setLayout:function(a){this.index=a},small:function(){switch(this.index){case 0:this.index=1;break;case 1:this.index=2;break;case 2:break;case 3:this.index=0;break;default:this.index=0}},largen:function(){switch(this.index){case 0:this.index=3;break;case 1:this.index=0;break;case 2:this.index=1;break;case 3:break;default:this.index=0}},full:function(){this.index=this.leftFull}},d.$on("$viewContentLoaded",function(){s.onPhone(function(a){a.matches&&(d.layoutManager.index===d.layoutManager.leftFixed?d.layoutManager.setLayout(d.layoutManager.leftFull):d.layoutManager.index===d.layoutManager.rightFixed&&d.layoutManager.setLayout(d.layoutManager.rightFull))},d)}),d.navbar=[{name:"popular",link:"#/maps/popular",text:"受欢迎",more:!1},{name:"recent",link:"#/maps/recent",text:"最新",more:!1},{name:"upload",link:"#/maps/upload",text:"上传",more:!1},{name:"user",link:"#/maps/user/",text:"我的照片",more:!0},{name:"dynamic",link:"#/maps/dynamic",text:"好友动态",more:!0},{name:"travels",link:"#/maps/travels",text:"热门旅行",more:!0},{name:"travel",link:"#/maps/travel",text:"旅行",more:!0,hidden:!0},{name:"news",link:"#/maps/news",text:"热门新闻",more:!0}],d.setMenu=function(a,b){if("user"==a){var c=b;d.user.id=c.id,d.user.name=c.name,angular.forEach(d.navbar,function(a){"user"==a.name&&(a.link="#/maps/user/"+c.id,a.text=c.name+"的照片")})}else"travel"==a&&angular.forEach(d.navbar,function(a){"travel"==a.name&&(a.link="#/maps/travel/"+b.id,a.text=b.name)})},j.userId&&d.setMenu("user",{id:j.userId,name:"我"}),w(l.current),c.$on("$stateChangeSuccess",function(a,b){w(b)}),d.$watch("myMap",function(a){!d.map&&a&&(d.map=a,d.$broadcast("mapChanged",a))}),d.$on("mapChanged",function(a,b){z.setMap(b),d.mapEventListener.addToolBar(b),d.mapService.init(b),y(b),d.hashStateManager.get("lat")||c.cache||x(b)}),d.displayPhoto=function(a,b){b||d.hashStateManager.set("photoid",a),d.photoDisplayModal=i.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}}),d.photoDisplayModal.result.then(function(){d.hashStateManager.set("photoid",""),d.photoDisplayModal=null},function(){d.hashStateManager.set("photoid",""),d.photoDisplayModal=null})},d.$on("photo.click",function(a,b){d.displayPhoto(b)});var A,B,C,D=!1,E=[];d.hashStateManager.watch("photoid",function(a){d.photoDisplayModal&&d.photoDisplayModal.dismiss("cancel"),a&&d.displayPhoto(a,!0)}),d.search=function(a,b){var c=e.defer(),f=z.getBounds(),g=z.getLevel(),i=z.getSize();return h.search({swlat:f.sw.lat,swlng:f.sw.lng,nelat:f.ne.lat,nelng:f.ne.lng,level:g,width:i.width,height:i.height,type:b||"",term:a},function(a){"OK"==a.status&&(d.photos=a.photos,z.createPhotosMarker(d.photos),k.debug("search res size: "+d.photos.length),c.resolve(a.photos))}),c.promise},d.hashStateManager.watch("search",function(a){a?(z.clearMap(),z.setAuto(!1)):(z.clearMap(),z.setAuto(!0)),d.searchVal=a,d.$broadcast("searchChanged",a)}),d.setSearch=function(a,b){d.searchVal=a,b||d.hashStateManager.set("search",a),d.$broadcast("searchChanged",a)},d.clearSearch=function(){z.setAuto(!0),d.searchVal="",d.hashStateManager.set("search","")},d.loadMoreDisabled=!0,d.$on("$destroy",function(){d.mapEventListener.removeListener(E),v.updateCenter(A,B,C),d.hashStateManager.clear(),d.hashStateManager=null}),d.clearState=function(){d.hashStateManager&&d.hashStateManager.set("photoid",""),d.photoDisplayModal&&d.photoDisplayModal.dismiss("cancel")},d.markers=[],d.onPhotoDrop=function(a,b){d.markers[d.markers.length-1]&&d.$broadcast("onDrop",{event:a,ui:b,id:d.markers[d.markers.length-1]})},d.onPhotoOver=function(){}}]).controller("PhotosAlertsCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(){}]).controller("MapsSearchCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","$q",function(a,b,c,d,e,f,g,h,i,j,k,l){d.searching=!1,d.searchTypes=[{type:"photo",name:"图片"},{type:"location",name:"地点"}],d.searchType=d.searchTypes[1],d.setSearchType=function(a){d.searchType=a,d.searching=!1},d.$on("searchChanged",function(a,b){d.asyncSelected=b,d.setSearchType(d.searchTypes[0])}),d.getLocation=function(a){var b=l.defer();return"location"==d.searchType.type&&(d.searching=!0,d.mapService.getLocPois(a).then(function(a){b.resolve(a),d.searching=!1},function(){d.searching=!1})),b.promise},d.goLocation=function(a){if("photo"==d.searchType.type)d.setSearch(a);else{if(!a)return;var b=a.location;d.searching=!0,b?(d.mapEventListener.setCenter(d.map,b.lat,b.lng),a.zoom&&d.mapEventListener.setZoom(d.map,a.zoom),a.bounds&&d.mapEventListener.setBounds(d.map,a.bounds.sw,a.bounds.ne),d.searching=!1):angular.isString(a)&&d.mapService.getLocPois(a).then(function(a){a[0]&&a[0].location&&(d.goLocation(a[0]),d.searching=!1)})}},d.onSelect=function(a){d.goLocation(a)}}]).controller("MapsPopularCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k){d.selectable=!1,d.clearSearch(),d.setPanormaioType("popular"),d.$on("searchChanged",function(a,b){return b?(d.setPanormaioType("manual"),void d.search(b,"photo").then(function(a){d.photos=k.Array.mergeRightist(d.photos||[],a,"id"),d.$broadcast("ponm.photo.fluid.resize",{})})):void d.setPanormaioType("auto")}),d.$on("$destroy",function(){d.clearState()})}]).controller("MapsRecentCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d){d.selectable=!1,d.clearSearch(),d.setPanormaioType("recent"),d.$on("searchChanged",function(a,b){d.search(b,"photo").then(function(a){d.photos=a})}),d.$on("$destroy",function(){d.clearState()})}]).controller("MapsTravelCtrl",["$window","$scope","TravelService","UserService","$modal","MessageService","ponmCtxConfig","$log","$state","$stateParams","$q","jsUtils","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){b.contentLoading=!0,c.getTravel({travelId:a},function(c){"OK"==c.status&&(b.setMenu("travel",{id:a,name:c.travel.title}),m(function(){b.setTravel(c.travel)},500),d.getOpenInfo({userId:c.travel.user_id},function(a){"OK"==a.status&&(b.userOpenInfo=a.open_info)}),c.travel.message_id&&f.get({id:c.travel.message_id},function(a){"OK"==a.status&&(b.message=a.message)}))})}function o(c){b.travelLayer=new a.cnmap.TravelLayer({ctx:b.ctx,staticCtx:b.staticCtx,clickable:!0,editable:!!b.travelEnedit}),jQuery(b.travelLayer).bind("data_clicked",function(a,c){b.displayPhoto(c)}),b.travelLayer.setMap(c),b.travel&&(b.travelLayer.setTravel(b.travel),b.travelLayer.initMap(),b.travel.spots[0]&&b.activeSpot(b.travel.spots[0])),jQuery(b.travelLayer).bind("spot.edited",function(a,c){b.$broadcast("spot.edited."+c)})}b.clearSearch(),b.setPanormaioType("manual"),b.setTravel=function(a){b.travel=a,b.travelEnedit=b.userId==b.travel.user_id&&b.editableView,angular.isArray(b.travel.spots)||(b.travel.spots=[]),b.travel.spot&&b.travel.spots.push(b.travel.spot),angular.forEach(b.travel.spots,function(a){a.addresses={},angular.forEach(a.photos,function(b){b.point&&b.point.address&&(a.addresses[b.point.address]=b.point)})}),b.travelLayer?m(function(){b.travelLayer.clearMap(),b.travelLayer.setEditable(b.travelEnedit),b.travelLayer.setTravel(b.travel),b.travelLayer.initMap(),b.activeSpot(b.travel.spots[0]),b.contentLoading=!1},100):b.contentLoading=!1},b.updateTravel=function(a,b,d){var e=k.defer(),f={id:a.id};return f[b]=d,c.changeTravel({travelId:a.id},f,function(a){a=a||{},"OK"===a.status?e.resolve():e.resolve(a.info)},function(a){e.reject(a.data?a.data.info:"Server error!")}),e.promise},b.$on("travelChanged",function(a,b){n(b)}),b.$on("mapChanged",function(){b.travelLayer||o(b.map)}),b.$on("editableViewChanged",function(a,c){b.travel&&(b.travelEnedit=b.userId==b.travel.user_id&&c,b.travelLayer&&b.travelLayer.setEditable(b.travelEnedit))}),b.$on("photoDeleteEvent",function(a,b){h.debug("photo delete event: photoId = "+b),a.preventDefault(),a.stopPropagation()}),b.activePhoto=function(a){b.photo&&b.photo.id==a.id?b.displayPhoto(a.id):(b.photo=a,b.travelLayer.activePhoto(a))},b.activeSpot=function(a){var c=0;return c=angular.isObject(a)?a.id:a,b.activedSpot&&b.activedSpot.id==c?void b.travelLayer.activeSpot(a):(angular.forEach(b.travel.spots,function(a){a.id==c?(a.active=!0,b.activedSpot=a):a.active=!1}),void b.travelLayer.activeSpot(a))},b.addSpotPhoto=function(a,d){var e={photos:a.id};c.addSpotPhoto({travelId:d.travel_id,typeId:d.id},l.param(e),function(c){"OK"==c.status&&(b.travelLayer.removePhoto(a),b.travelLayer.addPhoto(d,a),b.$broadcast("ponm.photo.fluid.resize"),b.alertService.add("success","更新成功"))})},b.showSpotAddress=function(a){return a.address||"添加地址"},b.dateOptions={formatYear:"yy",startingDay:1};var p=new Date;b.datepickerDisabled=function(a,b){return"day"===b&&a>p},b.map&&o(b.map),j.travelId&&n(j.travelId),b.$on("ponm.photo.fluid.resized",function(){b.$broadcast("waypoint-refresh")}),b.$on("$destroy",function(){b.travelLayer&&b.travelLayer.clearMap(),b.clearState()})}]).controller("MapsTravelSpotCtrl",["$window","$location","$rootScope","$scope","$q","TravelService","UserService","PhotoService","$modal","ponmCtxConfig","$log","$state","$stateParams","$filter","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){d.$watch("spot.timeStart",function(a){if(a){var b=d.updateSpot(d.spot,"time_start",n("date")(a,"yyyy/MM/dd"));b.then(function(){d.spot.time_start=a,d.travelLayer.calcSpotTime()},function(){})}}),d.updateSpot=function(a,b,c){var g=e.defer(),h={id:a.id,title:a.title,description:a.description,address:a.address};return h[b]=c,f.changeSpot({travelId:a.travel_id,typeId:a.id},h,function(a){a=a||{},"OK"===a.status?(d.alertService.add("success","更新成功"),g.resolve()):(d.alertService.add("danger","更新失败 "+a.info,{ttl:2e3}),g.resolve(a.info))},function(a){a.data?(d.alertService.add("danger","更新失败 "+a.data.info,{ttl:2e3}),g.reject(a.data.info)):(d.alertService.add("danger","更新失败",{ttl:2e3}),g.reject("Server error!"))}),g.promise},d.setAlbumCover=function(a){d.updateTravel(d.travel,"album_cover",{id:a.id}).then(function(){d.alertService.add("success","更新成功")},function(a){d.alertService.add("danger","更新失败 "+a,{ttl:3e3})})},d.createSpot=function(a){f.createSpot({travelId:d.spot.travel_id},o.param({}),function(b){"OK"==b.status&&(d.travelLayer.addSpot(b.spot),d.addSpotPhoto(a,b.spot),d.alertService.add("success","创建成功"),d.$broadcast("ponm.photo.fluid.resize"))})},d.removePhoto=function(a){d.$emit("photoDeleteEvent",a.id),f.deletePhoto({travelId:d.spot.travel_id,typeId:a.id},function(b){"OK"==b.status&&(d.travelLayer.removePhoto(a),d.alertService.add("success","删除成功"),d.$broadcast("ponm.photo.fluid.resize"))})},d.deleteSpot=function(a){f.deleteSpot({travelId:a.travel_id,typeId:a.id},function(b){"OK"==b.status&&(d.travelLayer.removeSpot(a),d.alertService.add("success","删除成功"),d.$emit("ponm.photo.fluid.resized"))})},d.saveSpotPhotoPoint=function(a){var b=e.defer(),c={id:a.id,photos:[]};return angular.forEach(a.photos,function(a){var b={id:a.id};a.oPoint&&(b.point=angular.copy(a.point),b.vendor=j.getCoordSS()),a.oDate_time&&(b.date_time=a.date_time),c.photos.push(b)}),f.changeSpot({travelId:a.travel_id,typeId:a.id},c,function(c){"OK"==c.status?(angular.forEach(a.photos,function(a){delete a.oPoint,delete a.oDate_time}),b.resolve()):b.reject()},function(){b.reject()}),b.promise},d.editAndSave=function(a){a.edit?a.save?d.saveSpotPhotoPoint(d.spot).then(function(){d.alertService.add("success","更新成功"),a.save=!1},function(){d.alertService.add("danger","更新失败",{ttl:3e3})}):(a.edit=!1,a.save=!1):(a.edit=!0,a.save=!1),d.travelLayer&&d.travelLayer.setSpotEditable(d.spot,a.edit)},d.cancelEdit=function(a){angular.forEach(d.spot.photos,function(a){a.oDate_time&&(a.date_time=a.oDate_time),delete a.oDate_time}),d.travelLayer&&(d.travelLayer.calcSpotTime(),d.travelLayer.updateSpotLine(d.spot),d.travelLayer.cancelSpotEdit(d.spot),d.$emit("ponm.photo.fluid.resize")),a.save=!1},d.$on("spot.edited."+d.spot.id,function(){d.spotLine.save=!0}),d.spotLine={disp:!0},d.$watch("spotLine.disp",function(a){d.travelLayer&&d.travelLayer.toggleSpotLine(d.spot,!!a)})}]).controller("MapsTravelSpotPhotoCtrl",["$scope","$q",function(a){a.setPhotoDateTime=function(b,c){c!=b&&(a.photo.oDate_time=c,a.photo.date_time=b,a.travelLayer.calcSpotTime(),a.travelLayer.updateSpotLine(a.spot),a.$emit("ponm.photo.fluid.resize"),a.spotLine.edit=!0,a.spotLine.save=!0,a.travelLayer&&a.travelLayer.setSpotEditable(a.spot,!0))
}}]).controller("MapsUserCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){d.loadBusy||(d.loadBusy=!0,e.get({userId:n,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage,swlat:d.bounds.sw.lat,swlng:d.bounds.sw.lng,nelat:d.bounds.ne.lat,nelng:d.bounds.ne.lng},function(a){"OK"==a.status&&(a.photos.length<d.photo.pageSize&&(d.loadMoreDisabled=!0),d.photos=1===d.photo.currentPage?l.Array.mergeRightist(d.photos||[],a.photos,"id"):l.Array.append(d.photos||[],a.photos,"id"),d.photo.currentPage++,d.$broadcast("ponm.photo.fluid.resize",{}),d.loadBusy=!1)}))}d.selectable=!1;var n=k.userId;f.getOpenInfo({userId:n},function(a){"OK"==a.status&&(d.user=a.open_info)}),d.photo={pageSize:20,currentPage:1,maxSize:10},d.photos=[],d.loadMoreDisabled=!1,d.loadBusy=!1,$(d.panoramioLayer).bind("map_changed",function(a,b,c,e){d.bounds=b,d.level=c,d.size=e,d.photo.currentPage=1,d.loadMoreDisabled=!1,m()}),d.setPanormaioType("user",n),d.loadMorePhotos=function(){m()},d.$on("$destroy",function(){$(d.panoramioLayer).unbind("map_changed"),d.clearState()})}]).controller("MapsTravelsCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","TravelService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d,e,f,g,h,i,j,k){d.setPanormaioType("manual"),d.goTravel=function(a){k.go("maps.travel",{travelId:a.id})},d.$on("searchChanged",function(a,b){d.travels=[],d.search(b,"travel").then(function(a){var b={};angular.forEach(a,function(a){a.travel_id&&!b[a.travel_id]&&(b[a.travel_id]=a.travel_id,g.getTravel({travelId:a.travel_id},function(a){"OK"==a.status&&(a.travel.photos=[],angular.forEach(a.travel.spots,function(b){a.travel.photos=a.travel.photos.concat(b.photos)}),d.travels.push(a.travel))}))})})}),d.$on("$destroy",function(){d.clearState()})}]).controller("MapsPhotoUploadCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","TravelService","$modal","ponmCtxConfig","$log","$state","$stateParams","AuthService",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b,c){a.mapVendor.marker?(p.setPosition(a.mapVendor.marker,b,c),p.setMap(a.mapVendor.marker,d.map)):o(a,b,c),d.setPlace(a,b,c)}function o(a,b,c){if(b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=p.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,p.setMap(a.mapVendor.marker,d.map),p.addMarkerActiveListener(a.mapVendor.marker,function(){d.activePhoto(this.photo_file)}),p.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}m.checkLogin().then(function(){},function(){k.go("login",{})});var p=d.mapEventListener,q=d.mapService,r={};d.$on("photoAdd",function(a,b){j.debug("add marker of photo : "),j.debug(b),b.mapVendor=b.mapVendor||{},r[b.uuid]=r[b.uuid]||b,b=r[b.uuid],b.point&&n(b,b.point.lat,b.point.lng)}),d.$on("photoDelete",function(a,b){j.debug("photo delete: "+b.uuid),b=r[b.uuid],b&&(b.mapVendor.marker&&p.removeMarker(b.mapVendor.marker),delete r[b.uuid])}),d.$on("photoActive",function(a,b){j.debug("active: "+b.uuid),b=r[b.uuid],d.activePhoto(b)}),d.map,d.$on("mapChanged",function(){}),d.activePhoto=function(a){d.file&&(d.file.active=!1,d.file.mapVendor&&p.deactiveMarker(d.file.mapVendor.marker),d.file=null),a&&(d.file=a,d.file.active=!0,d.file.mapVendor&&d.file.mapVendor.lat&&(p.activeMarker(d.file.mapVendor.marker),p.inMapView(d.file.mapVendor.lat,d.file.mapVendor.lng,d.map)||p.setCenter(d.map,d.file.mapVendor.lat,d.file.mapVendor.lng)),d.$broadcast("photoReverseActive",a))},d.setPlace=function(a,b,c,e){a.mapVendor.lat=b,a.mapVendor.lng=c,e&&(a.mapVendor.address=e),j.debug("setPlace for photo: "+a.id),q.getAddrPois(b,c).then(function(b,c){e||(a.mapVendor.address=c),a.mapVendor.addresses=b,j.debug("getAddrPois for photo: "+a.id),d.$broadcast("photoReverseAddress",a)})},d.$on("onDrop",function(a,b){j.debug("on drop left = "),j.debug(b.event);var c;r[b.id]?c=r[b.id]:(c={id:b.id,uuid:b.id,mapVendor:{}},r[c.uuid]=c);var e=p.pixelToPoint(d.map,{x:b.event.pageX,y:b.event.clientY-82});n(c,e.lat,e.lng)}),d.$on("$destroy",function(){angular.forEach(r,function(a){a.mapVendor&&a.mapVendor.marker&&p.removeMarker(a.mapVendor.marker)}),p.clearMap(),d.clearState()})}]).controller("MapsDynamicCtrl",["$scope","$log","$state","$document","MessageManager","ponmCtxConfig",function(a,b,c,d,e,f){a.$on("user.login",function(){a.userId&&a.userId==f.userId||(a.userId=userId,a.messageManager=new e(a.userId),a.onLoadWaypoint())}),a.onLoadWaypoint=function(){a.messageManager&&a.messageManager.getMoreMessages().then(function(b){a.$broadcast("message.add",b)})},a.userId&&(a.messageManager=new e(a.userId),a.onLoadWaypoint()),a.$on("message.actived",function(b,c){c.point&&a.$broadcast("message.point.click",c)});var g,h=[];a.$on("message.point.click",function(b,c){var d=h[c.id],e=c.point;d||(d={id:c.id},d.marker=a.mapEventListener.addMarker(a.map,e.lat,e.lng),d.marker.message=c,h[c.id]=d,a.mapEventListener.addMarkerActiveListener(d.marker,function(){a.$broadcast("message.active",this.message)})),a.mapEventListener.setCenter(a.map,e.lat,e.lng),g==c.id?a.mapEventListener.zoomIn(a.map):g=c.id}),a.$on("message.active",function(a,b){var c=angular.element(document.getElementById("message-"+b.id));d.scrollToElementAnimated(c,120)}),a.$on("$destroy",function(){angular.forEach(h,function(b){b.marker&&a.mapEventListener.removeMarker(b.marker)}),a.mapEventListener.clearMap(),a.clearState()})}]),angular.module("ponmApp").controller("NavbarCtrl",["$window","$scope","$log","$http","AuthService","ponmCtxConfig",function(a,b,c,d,e,f){b.ctx=f.ctx,b.staticCtx=f.staticCtx,b.apirest=f.apirest,b.ponmCtxConfig=f,e.checkLogin(),b.$on("login",function(){c.debug(b.ponmCtxConfig.userId)}),b.getLocation=function(a){return d.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},b.update=function(c){var d=c.geometry;d&&(a.location=b.ctx+"/map##lat="+d.location.lat+"&lng="+d.location.lng+"&bounds="+d.bounds.southwest.lat+","+d.bounds.southwest.lng+","+d.bounds.northeast.lat+","+d.bounds.northeast.lng)}}]),angular.module("ponm.Navbar",["ngResource","ui.bootstrap","ponmApp"]).controller("SearchLocCtrl",["$window","$scope","$log","$http","ponmCtxConfig",function(a,b,c,d,e){b.ctx=e.ctx,b.staticCtx=e.staticCtx,b.apirest=e.apirest,b.getLocation=function(a){return d.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},b.update=function(c){var d=c.geometry;d&&(a.location=b.ctx+"/map##lat="+d.location.lat+"&lng="+d.location.lng+"&bounds="+d.bounds.southwest.lat+","+d.bounds.southwest.lng+","+d.bounds.northeast.lat+","+d.bounds.northeast.lng)}}]),angular.module("ponmApp.controllers").controller("PhotoModalCtrl",["$window","$scope","$log","$modalInstance","photoId","travelId","PhotoService","CommentService","UserService","TravelService","$q","$modal","$filter","$location","ponmCtxConfig","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a){g.getCameraInfo({photoId:a},function(a){"OK"==a.status&&(b.cameraInfo=a.camera_info)})}function r(a){g.getComments({photoId:a},function(a){"OK"==a.status&&(b.comments=a.comments)},function(){})}function s(a){j.getTravel({travelId:a},function(a){if("OK"==a.status){b.travel=a.travel,b.travel.photos=[],b.travel.totalPhoto=0,b.travel.currentPhoto=0;var c=0;angular.forEach(b.travel.spots,function(a){angular.forEach(a.photos,function(a){c+=1,a.id==e&&(a.active=!0,b.travel.activePhoto=a),a.sortCount=c,b.travel.photos.push(a)})}),b.travel.totalPhoto=c,b.setGalleryImages(b.travel.photos)}})}function t(a){return b.staticCtx+"/"+a.oss_key+"@1e_20w_20h_1c.jpg"}b.ctx=a.ctx,b.staticCtx=o.staticCtx,b.corsproxyCtx=o.corsproxyCtx,b.apirest=a.apirest,b.photoId=e,b.userId=a.userId,b.login=o.login,b.ponmCtxConfig=o,b.photoDetailCollapsed=!0,b.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},b.setPhotoId=function(a){c.debug("$scope id "+b.$id+" photoId"+a),b.photoId=a,g.getPhoto({photoId:b.photoId},function(a){"OK"==a.status&&(b.photo=a.prop,b.photoEditable=b.ponmCtxConfig.userId==b.photo.user_id,b.comment.totalItems=a.prop.comment_count,b.comment.numPages=Math.ceil(b.comment.totalItems/b.comment.pageSize),i.getOpenInfo({userId:b.photo.user_id},function(a){"OK"==a.status&&(b.userOpenInfo=a.open_info)}),b.setGalleryImages(b.photo),f||(b.photo.travel_id?(f=b.photo.travel_id,s(f)):b.travel={}))}),q(a),r(a)},f&&s(f),b.getPhotoSrc=function(a){if(!a)return"";if("gif"==a.file_type)return b.staticCtx+"/"+a.oss_key;var c="@";return c+="!photo-preview-lg",b.staticCtx+"/"+a.oss_key+c},b.updatePhoto=function(a,b,c){var d=k.defer(),e={};return e[b]=c,g.updateProperties({photoId:a.id},e,function(a){a=a||{},"OK"===a.status?d.resolve():d.resolve(a.info)},function(a){d.reject(a.data?a.data.info:"Server error!")}),d.promise},b.addTravel=function(a){var c=k.defer();return j.addPhoto({travelId:a},p.param({photos:b.photoId}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.showTravel=function(){var a=[];return b.userOpenInfo&&(a=m("filter")(b.userOpenInfo.travels,{id:b.photo.travel_id})),b.photo.travel_id&&a.length?a[0].title:"添加到旅行"},b.$on("deletedCommentEvent",function(a,c){a.preventDefault(),a.stopPropagation(),angular.forEach(b.comments,function(a,d){a.id==c&&(delete b.comments.splice(d,1),b.photo.comment_count-=1)})}),b.$on("replyCommentEvent",function(a,c){a.preventDefault(),a.stopPropagation(),b.comment.placeholder="回复 "+c.name,b.commentContent="@"+c.name+" "}),b.cancelComment=function(){b.comment.placeholder="",b.commentContent=""},b.like=function(){b.photo.like?g.unLike({photoId:b.photoId},function(a){a=a||{},"OK"===a.status&&(b.photo.like=!1,b.photo.like_count-=1)},function(a){a.data}):g.like({photoId:b.photoId},function(a){a=a||{},"OK"===a.status&&(b.photo.like=!0,b.photo.like_count+=1)},function(a){a.data})},b.cancel=function(){d.dismiss("cancel")},b.openTravelAlbum=function(){b.$broadcast("travelAlbum.open")},b.closeTravelAlbum=function(){b.$broadcast("travelAlbum.close")},b.openRecommendAlbum=function(){b.$broadcast("photoRecommendAlbum.open")},b.openPhoto=function(a){b.travel.activePhoto&&(b.travel.activePhoto.active=!1),a.active=!0,b.travel.activePhoto=a,b.closeTravelAlbum(),b.setPhotoId(a.id)},b.previous=function(){var a=0;if(b.travel.activePhoto&&(a=b.travel.activePhoto.sortCount-2)>=0){b.travel.activePhoto.active=!1;var c=b.travel.photos[a];c.active=!0,b.travel.activePhoto=c,b.setPhotoId(c.id)}else b.openTravelAlbum()},b.next=function(){var a=0;if(b.travel.activePhoto&&(a=b.travel.activePhoto.sortCount)<b.travel.photos.length){b.travel.activePhoto.active=!1;var c=b.travel.photos[a];c.active=!0,b.travel.activePhoto=c,b.setPhotoId(c.id)}else b.openRecommendAlbum()},b.setPhotoId(e),b.openMapPhoto=function(){var a=l.open({templateUrl:"views/mapPhoto.html",controller:"MapPhotoCtrl2",windowClass:"map-photo-modal",resolve:{photo:function(){return b.photo}}});a.result.then(function(a){b.selected=a,b.setPhotoId(b.photoId)},function(){c.info("Modal dismissed at: "+new Date),b.setPhotoId(b.photoId)})},b.displayGallery=function(){var a=0;angular.forEach(b.galleryData,function(c,d){c.photoId==b.photoId&&(a=d)}),b.$broadcast("image-gallery",{index:a})},b.galleryData=[],b.setGalleryImages=function(a){angular.isArray(a)?(b.galleryData=[],angular.forEach(a,function(a){b.galleryData.push({photoId:a.id,title:a.title,href:b.getPhotoSrc(a),type:"image/jpeg",thumbnail:t(a)})})):angular.isObject(a)&&b.galleryData.push({photoId:a.id,title:a.title,href:b.getPhotoSrc(a),type:"image/jpeg",thumbnail:t(a)})},b.share=function(){},b.$on("image.click",function(a){a.stopPropagation(),a.preventDefault(),c.debug("image.click "+b.photo.id),b.next()})}]).directive("photoTravelAlbum",["$rootScope","$animate","$log",function(){return{restrict:"A",link:function(a){a.$on("travelAlbum.open",function(){a.show=!0}),a.$on("travelAlbum.close",function(){a.show=!1})}}}]).directive("photoRecommendAlbum",["$rootScope","$animate","$log",function(){return{restrict:"A",link:function(a){a.$on("photoRecommendAlbum.open",function(){a.recommendAlbumShow=!0}),a.$on("photoRecommendAlbum.close",function(){a.recommendAlbumShow=!1})}}}]).controller("MapPhotoCtrl2",["$window","$log","$timeout","$scope","$modalInstance","PhotoService","GeocodeService","photo","ponmCtxConfig","alertService",function(a,b,c,d,e,f,g,h,i,j){function k(){d.file&&d.file.mapVendor&&d.file.mapVendor.marker&&o.setMap(d.file.mapVendor.marker,null),d.file={photoId:d.photoId},f.getPhoto({photoId:d.photoId},function(a){"OK"==a.status&&(d.photo=a.prop,d.file.is360=a.prop.is360)}),f.getGPSInfo({photoId:d.photoId},function(a){if("OK"==a.status){var b=a.gps;b&&(n(d.file,b.point.lat,b.point.lng),o.setCenter(d.map,b.point.lat,b.point.lng),d.setPlace(d.file,b.point.lat,b.point.lng,b.point.address))}})}function l(a,b,c){if(a.mapVendor=a.mapVendor||{},b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=o.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,o.setMap(a.mapVendor.marker,d.map),o.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function m(a){o.addMapClickListener(a,function(a,b){n(d.file,a,b),d.setPlace(d.file,a,b)})}function n(a,b,c){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(o.setPosition(a.mapVendor.marker,b,c),o.setMap(a.mapVendor.marker,d.map)):(l(a,b,c),o.activeMarker(a.mapVendor.marker))}d.ctx=a.ctx,d.staticCtx=i.staticCtx,d.apirest=a.apirest,d.userId=a.userId;var o=a.cnmap.MapEventListener.factory(),p=a.cnmap.MapService.factory();d.mapEventListener=o,d.mapService=p,d.photo=h,d.photoId=h.id,d.alertService=angular.copy(j),d.cancel=function(){e.dismiss("cancel")},d.ok=function(){f.updateProperties({photoId:d.photoId},{point:{lat:d.file.mapVendor.lat,lng:d.file.mapVendor.lng,address:d.file.mapVendor.address},vendor:"gaode",is360:d.file.is360},function(a){"OK"==a.status?(b.debug("properties update successful"),d.alertService.clear(),d.alertService.add("success","保存成功!",{ttl:2e3}),c(function(){d.cancel()},2e3)):(d.alertService.clear(),d.alertService.add("danger","保存失败 "+a.status,{ttl:2e3}))},function(a){d.alertService.clear(),d.alertService.add("danger","保存失败 "+(a.data&&a.data.status),{ttl:2e3})})},d.$watch("$$childTail.myMap",function(a){a&&(d.map=a,p.init(a),m(d.map),k())}),d.addOrUpdateMarker=n,d.setPlace=function(a,b,c,e){d.file.mapVendor=d.file.mapVendor||{},d.file.mapVendor.lat=b,d.file.mapVendor.lng=c,d.file.mapVendor.latPritty=cnmap.GPS.convert(b),d.file.mapVendor.lngPritty=cnmap.GPS.convert(c),e&&(d.file.mapVendor.address=e),p.getAddrPois(b,c).then(function(a,b){e||(d.file.mapVendor.address=b),d.file.mapVendor.addresses=a})},d.clearPlace=function(){},d.mapOptions={zoom:5},h.point&&(d.mapOptions.centerPoint=h.point)}]).controller("TypeaheadCtrl",["$scope","$http","GeocodeService","$q",function(a,b,c,d){a.selected=void 0,a.states=[],a.getLocation=function(b){var c=d.defer();return a.mapService.getLocPois(b).then(function(a){c.resolve(a)}),c.promise.then(function(a){return a})},a.goLocation=function(b){var c=b.location;c&&(a.mapEventListener.setCenter(a.map,c.lat,c.lng),b.bounds?a.mapEventListener.setBounds(a.map,b.bounds.sw,b.bounds.ne):b.zoom&&a.mapEventListener.setZoom(a.map,b.zoom))},a.onSelect=function(b){a.goLocation(b)}}]),angular.module("ponmApp.photos",["ui.bootstrap","ui.map","ui.router","ponmApp","xeditable","duScroll"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/photos/:userId","/photos/:userId/all"),a.state("photos",{"abstract":!0,url:"/photos/:userId",views:{"":{templateUrl:"views/photos.html",controller:"PhotosCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"}},resolve:{},controller:"PhotosCtrl"}).state("photos.all",{url:"/all",templateUrl:"views/photos.all.html",resolve:{},controller:"PhotosAllCtrl"}).state("photos.recent",{url:"/recent",templateUrl:"views/photos.all.html",resolve:{},controller:"PhotosRecentCtrl"}).state("photos.albums",{url:"/albums",templateUrl:"views/photos.albums.html",resolve:{},controller:"PhotosAlbumsCtrl"}).state("photos.album",{url:"/albums/:travelId",templateUrl:"views/photos.album.html",resolve:{},controller:"PhotosAlbumCtrl"}).state("photos.trash",{url:"/trash",templateUrl:"views/photos.trash.html",resolve:{},controller:"PhotosTrashCtrl"})}]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("PhotosCtrl",["$window","$location","$document","$rootScope","$scope","PhotoService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","safeApply","jsUtils","HashStateManager","alertService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){var a=angular.copy(e.selectedPhotos);angular.forEach(a,function(a){e.$broadcast("removePhotoDo",a.id),e.alertService.add("success","移动成功")})}e.ctx=a.ctx,e.staticCtx=i.staticCtx,e.apirest=a.apirest,e.$state=k,e.$location=b,e.$stateParams=l,e.navbarFixedTop=!1,e.hashStateManager=new o(e,b),e.alertService=angular.copy(p),e.alertService.options.alone=!0,e.alertService.options.ttl=2e5,j.debug(k),e.userId=k.params.userId,"yourphotos"==e.userId&&(e.userId=i.userId),e.userId&&e.userId==i.userId||k.go("maps.popular",{}),g.getOpenInfo({userId:e.userId},function(a){"OK"==a.status&&(e.userOpenInfo=a.open_info)}),e.cancelSelect=function(){e.$broadcast("photosCancelSelect",{})},e.$on("photosCancelSelect",function(){e.selectable=!1,angular.forEach(e.selectedPhotos,function(a){a.actionSelected=!1}),e.selectedPhotos=[]}),e.navbarType="photos.trash"==k.current.name?"trash":"move",e.alertType="photos.trash"==k.current.name?"trash":"move",d.$on("$stateChangeSuccess",function(a,b){e.cancelSelect(),e.navbarType="photos.trash"==b.name?"trash":"move",e.alertType="photos.trash"==b.name?"trash":"move",c.scrollTop(0,500)}),e.selectedPhotos=[],e.setSelectable=function(a){e.selectable=a},e.displayPhoto=function(a,b){b||(e.hashStateManager.set("d","d"),e.hashStateManager.set("photoid",a)),e.photoDisplayModal=h.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}}),e.photoDisplayModal.result.then(function(){e.hashStateManager.set("photoid",""),e.photoDisplayModal=null},function(){e.hashStateManager.set("photoid",""),e.photoDisplayModal=null})},e.hashStateManager.watch("photoid",function(a){e.photoDisplayModal&&e.photoDisplayModal.dismiss("cancel"),a&&e.displayPhoto(a,!0)}),e.openMovePhoto=function(){var a=h.open({templateUrl:"views/photos.move.html",controller:"PhotosMoveCtrl",windowClass:"move-photo-modal",resolve:{photos:function(){return e.selectedPhotos},operateType:"move"}});a.result.then(function(){j.debug("move photos success"),q()},function(){j.debug("move photos fail"),j.info("Modal dismissed at: "+new Date)})},e.deletePhoto=function(){angular.forEach(e.selectedPhotos,function(a){f.delete({photoId:a.id},function(b){"OK"==b.status&&(e.$broadcast("removePhotoDo",a.id),e.alertService.add("success","删除成功"))})})},e.cancelRecycle=function(){e.$broadcast("cancelRecycleDo",{})},e.removeRecycle=function(){e.$broadcast("removeRecycleDo",{})},e.selectAll=function(){e.$broadcast("selectAllDo",{})},e.emptyRecycleBin=function(){e.$broadcast("emptyRecycleBinDo",{})},e.photoWallMode="medium",e.backtop=function(){c.scrollTop(0,500)}}]).controller("PhotosAllCtrl",["$window","$location","$rootScope","$scope","$q","$timeout","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","jsUtils","safeApply","PhotosManager",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){d.photoLoading=!0,r.more().then(function(a){d.photos=d.photos.concat(a),d.photos.sort(function(a,b){return b.create_time-a.create_time}),d.photoLoading=!1},function(){d.photoLoading=!1})}var r=new p(d.userId,30);d.photosManager=r,d.photos=[],d.getUserPhotos=q,q(),d.$on("waypointEvent",function(a,b,c){c.date&&o(d,function(){d.timelineDate=c.date})}),d.$on("removePhotoDo",function(a,b){n.Array.removeItem(d.photos,"id",b)})}]).controller("PhotosRecentCtrl",["$window","$location","$rootScope","$scope","PhotosManager","jsUtils","$log","safeApply","$q",function(a,b,c,d,e,f,g,h){function i(){d.photoLoading=!0,j.more().then(function(a){d.photos=d.photos.concat(a),d.photos.sort(function(a,b){return b.create_time-a.create_time}),d.photoLoading=!1},function(){d.photoLoading=!1})}var j=new e(d.userId,30);d.photosManager=j,d.photos=[],d.getUserPhotos=i,i(),d.$on("waypointEvent",function(a,b,c){c.date&&h(d,function(){d.timelineDate=c.date})}),d.$on("removePhotoDo",function(a,b){f.Array.removeItem(d.photos,"id",b)})}]).controller("PhotosAlbumsCtrl",["$rootScope","$scope","UserService","ponmCtxConfig","$log","TravelService",function(a,b,c,d,e,f){b.travels=[],c.getTravels({userId:b.userId},function(a){"OK"==a.status&&(b.travels=b.travels.concat(a.open_info.travels))}),f.get({travelId:0},function(a){"OK"==a.status&&a.travel.spots&&a.travel.spots[0].photos.length&&(a.travel.title="无旅行的图片",b.travels.splice(0,0,a.travel))})}]).controller("PhotosAlbumCtrl",["$scope","TravelService","UserService","dialogService","ponmCtxConfig","$log","$state","$stateParams","TravelManager","jsUtils",function(a,b,c,d,e,f,g,h,i,j){function k(c){c&&b.getTravel({travelId:c},function(b){"OK"==b.status&&(a.travel=b.travel,l=new i(a.travel),l.calculate())})}a.travelId=h.travelId,k(a.travelId);var l,m={closeButtonText:"取消",actionButtonText:"删除旅行相册",headerText:"删除  ?",bodyText:"这么做会删除该相册及其中的照片。"};a.deleteTravel=function(c){m.headerText="删除 "+c.title+"?",d.showModal({},m).then(function(){b.delete({travelId:c.id},function(b){"OK"==b.status&&(g.go("photos.albums"),a.alertService.add("success","删除成功"))})})},a.$on("removePhotoDo",function(b,c){angular.forEach(a.travel.spots,function(a){j.Array.removeItem(a.photos,"id",c)}),a.$broadcast("ponm.photo.fluid.resize")})}]).controller("PhotosTrashCtrl",["$location","$rootScope","$scope","RecycleService","$log","jsUtils","TravelManager",function(a,b,c,d,e,f,g){function h(a){c.selectPhoto(null,a),angular.forEach(c.travels,function(b,d){f.Array.removeItem(b.photos,"id",a.id),0==b.photos.length&&delete c.travels[d]})}d.get({},function(a){"OK"==a.status&&angular.forEach(a.recycles,function(a){if("photo"==a.recy_type)a.photo.recycle=a.id,a.photo.travel_id?(c.travels[a.photo.travel_id]=c.travels[a.photo.travel_id]||{id:a.photo.travel_id,name:a.photo.travel_name,user_id:a.photo.user_id,photos:[]},c.travels[a.photo.travel_id].photos.push(a.photo)):(c.travels.noTravel=c.travels.noTravel||{user_id:a.photo.user_id,name:"无旅行",photos:[]},c.travels.noTravel.photos.push(a.photo));else if("travel"==a.recy_type){a.travel.name=a.travel.title,a.travel.user_id=a.travel.user.id,a.travel.recycleId=a.id;var b=new g(a.travel);c.travels[a.travel.id]=b.travel}})}),c.travels={},c.$on("cancelRecycleDo",function(){angular.forEach(c.selectedPhotos,function(a){d.cancel({id:a.recycle},function(b){"OK"==b.status&&(h(a),c.alertService.add("success","已恢复"))})})}),c.$on("removeRecycleDo",function(){angular.forEach(c.selectedPhotos,function(a){d.delete({id:a.recycle},function(b){"OK"==b.status&&(h(a),c.alertService.add("success","已彻底删除"))})})}),c.$on("selectAllDo",function(){angular.forEach(c.travels,function(a){angular.forEach(a.photos,function(a){c.selectPhoto(null,a)})})}),c.$on("emptyRecycleBinDo",function(){d.delete({},function(a){"OK"==a.status&&(delete c.travels,c.alertService.add("success","已清空"))})})}]).controller("PhotosPhotoCtrl",["$scope","jsUtils",function(a,b){a.selectPhoto=function(c){c.actionSelected=!c.actionSelected,c.actionSelected?(a.rectSelected=!0,a.setSelectable(!0),a.selectedPhotos.push(c)):(a.rectSelected=!1,b.Array.removeItem(a.selectedPhotos,"id",c.id),0==a.selectedPhotos.length&&a.setSelectable(!1))},a.$watch("rectSelected",function(b){(b&&!a.photo.actionSelected||!b&&a.photo.actionSelected)&&a.selectPhoto(a.photo)}),a.$on("selectAllDo",function(){a.selectPhoto(a.photo)}),a.$on("removePhotoDo",function(b){a.photo.id==b&&a.selectPhoto(a.photo)}),a.$on("photosCancelSelect",function(){a.rectSelected=!1})}]).controller("PhotosMoveCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modalInstance","ponmCtxConfig","$log","$q","jsUtils","operateType","photos",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){var b=j.defer();return e.create({},k.param({travel:a}),function(a){"OK"==a.status&&o(d.photos,a.travel).then(function(){b.resolve()})}),b.promise}function o(a,b){var c=[];angular.forEach(a,function(a){c.push(a.id)});var d=j.defer();return c.length>0?e.addPhoto({travelId:b.id},k.param({photos:c.join(",")}),function(a){"OK"==a.status?d.resolve():d.reject(a.info)}):d.resolve(),d.promise}d.ctx=h.ctx,d.staticCtx=h.staticCtx,d.apirest=h.apirest,d.photos=m,d.cancel=function(){g.dismiss("cancel")},f.getTravels({userId:h.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)}),d.newTravel={},d.selectedTravel={},d.select=function(a,b){a.selected=void 0!=b?b:!a.selected,d.selectedTravel!=a&&(d.selectedTravel.selected=!1,d.selectedTravel=a)},d.selectNewTravel=function(a){a?d.select(d.newTravel,!0):d.select(d.newTravel,!1)},d.ok=function(){if(d.newTravel.selected){if(!d.selectedTravel.name)return;n(d.selectedTravel.name,d.photos).then(function(){g.close()},function(){})}else o(d.photos,d.selectedTravel).then(function(){g.close()},function(){})},d.displayText="move"==l?{ok:"移动",title1:"将",title2:"张图片移动到..."}:{ok:"移动",title1:"将",title2:"张图片到..."}}]).controller("PhotosTravelMoveCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modalInstance","ponmCtxConfig","$log","$q","jsUtils","operateType","photos",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b){var c=[];angular.forEach(a,function(a){c.push(a.id)});var d=j.defer();return c.length>0?e.addPhoto({travelId:b.id},k.param({photos:c.join(",")}),function(a){"OK"==a.status?d.resolve():d.reject(a.info)}):d.resolve(),d.promise}d.ctx=a.ctx,d.staticCtx=h.staticCtx,d.apirest=a.apirest,d.photos=m,d.cancel=function(){g.dismiss("cancel")},f.getTravels({userId:h.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)}),d.newTravel={},d.selectedTravel={},d.select=function(a,b){a.selected=void 0!=b?b:!a.selected,d.selectedTravel!=a&&(d.selectedTravel.selected=!1,d.selectedTravel=a)},d.selectNewTravel=function(a){a?d.select(d.newTravel,!0):d.select(d.newTravel,!1)},d.ok=function(){n(d.photos,d.selectedTravel).then(function(){g.close()},function(){})},d.displayText="move"==l?{ok:"移动",title1:"将",title2:"张图片移动到..."}:{ok:"移动",title1:"将",title2:"张图片到..."}}]),angular.module("ponmApp.user",["ui.bootstrap","ngAnimate","ui.router","ponmApp","xeditable","perfect_scrollbar"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/user/{userId:[0-9]{1,10}}","/user/{userId:[0-9]{1,10}}/dynamic"),a.state("user",{"abstract":!0,url:"/user/{userId:[0-9]{1,10}}",views:{"":{templateUrl:"views/user.html",controller:"UserCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"},alert:{templateUrl:"views/ponm.alert.html",controller:"AlertsCtrl"}}}).state("user.dynamic",{url:"/dynamic",templateUrl:"views/user.dynamic.html",resolve:{},controller:"UserDynamicCtrl"}).state("user.message",{url:"/message/{messageId:[0-9]{1,10}}",templateUrl:"views/user.message.html",resolve:{},controller:"UserMessageCtrl"}).state("user.following",{url:"/following",templateUrl:"views/user.following.html",resolve:{},controller:"UserFollowingCtrl"}).state("user.followers",{url:"/followers",templateUrl:"views/user.followers.html",resolve:{},controller:"UserFollowersCtrl"}).state("user.likes",{url:"/likes",templateUrl:"views/user.likes.html",resolve:{},controller:"UserLikesCtrl"})}]).run(["$rootScope","$window","editableOptions",function(a,b,c){c.theme="bs3"}]).factory("MyMessageManager",["$q","UserService",function(a,b){function c(c){this.userId=c,this.pageSize=10,this.pageNo=1,this.ended=!1,this.getMoreMessages=function(){var c=a.defer();this.loading&&c.reject("loading"),this.ended&&c.reject("ended"),this.loading=!0;var d=this;return b.getMyMessages({userId:this.userId,value:this.pageSize,action:this.pageNo},function(a){d.loading=!1,"OK"==a.status?(d.pageNo++,a.messages.length<d.pageSize&&(d.ended=!0),c.resolve(a.messages)):c.reject(a.status)},function(a){d.loading=!1,c.reject(a)}),c.promise}}return c}]).controller("UserCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","UserService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.ctx=g.ctx,d.staticCtx=g.staticCtx,d.apirest=g.apirest,d.login=g.login,d.ponmCtxConfig=g,d.$state=i,d.userId=j.userId,n.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.user=a.open_info)}),d.trendItems=["室内","全景","上海"],d.displayPhoto=function(a){d.photoDisplayModal=f.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}}),d.photoDisplayModal.result.then(function(){d.photoDisplayModal=null},function(){d.photoDisplayModal=null})},d.$on("photo.click",function(a,b){d.displayPhoto(b)})}]).controller("UserDynamicCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","MyMessageManager",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=new n(d.userId);d.messageManager=o,d.messages=[],d.onLoadWaypoint=function(a,b){h.debug("load more "+b),o.getMoreMessages().then(function(a){d.$broadcast("message.add",a)})},d.onLoadWaypoint(),d.$on("message.shared",function(a,b){b.user.id==g.id&&d.$broadcast("message.insert",b)})}]).controller("UserFollowingCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","UserService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.followings=[],n.getCircles({userId:d.userId},function(a){"OK"==a.status&&angular.forEach(a.circles,function(a){angular.forEach(a.users,function(a){a.follow=!0}),d.followings=d.followings.concat(a.users)})})}]).controller("UserFollowersCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","UserService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){n.getFollowers({userId:d.userId},function(a){"OK"==a.status&&(d.followers=a.followers)})}]).controller("UserLikesCtrl",["$window","$location","$rootScope","$scope","$q","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","HashStateManager",function(){}]).controller("UserMessageCtrl",["$scope","$q","ponmCtxConfig","$log","$state","$stateParams","MessageService",function(a,b,c,d,e,f,g){a.messageId=f.messageId,d.debug("message id : "+a.messageId),a.messages=[],g.get({id:a.messageId},function(b){"OK"==b.status&&a.messages.push(b.message)})}]),angular.module("ponmApp.settings",["ui.bootstrap","ngAnimate","ui.router","ponmApp","xeditable","perfect_scrollbar"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/settings","/settings/account"),a.state("settings",{"abstract":!0,url:"/settings",views:{"":{templateUrl:"views/settings.html",controller:"UserSettingsCtrl"},navbar:{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"},alert:{templateUrl:"views/ponm.alert.html",controller:"AlertsCtrl"}}}).state("settings.account",{url:"/account",templateUrl:"views/settings.account.html",controller:"SettingsAccountCtrl"}).state("settings.password",{url:"/password",templateUrl:"views/settings.password.html",controller:"SettingsPasswordCtrl"}).state("settings.security",{url:"/security",templateUrl:"views/settings.security.html",controller:"SettingsSecurityCtrl"}).state("settings.notifications",{url:"/notifications",templateUrl:"views/settings.notifications.html",controller:"SettingsNotificationsCtrl"}).state("settings.map",{url:"/map",templateUrl:"views/settings.map.html",controller:"SettingsMapCtrl"}).state("settings.photo",{url:"/photo",templateUrl:"views/settings.photo.html",controller:"SettingsPhotoCtrl"})
}]).controller("UserSettingsCtrl",["$window","$log","$location","$rootScope","$scope","$modal","$state","SettingsService","UserService","ponmCtxConfig","AuthService","alertService",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){i.getOpenInfo({userId:e.userId},function(a){"OK"==a.status&&(e.user=a.open_info)}),h.get({userId:e.userId},function(a){"OK"==a.status&&(e.settings=a.settings)})}e.ctx=j.ctx,e.staticCtx=j.staticCtx,e.apirest=j.apirest,e.ponmCtxConfig=j,e.$state=g,e.alertService=l,e.alertService.options.alone=!0,e.alertService.options.ttl=3e3,k.checkLogin().then(function(){e.userId=j.userId,m()},function(){g.go("login",{})}),e.changeAvatar=function(){var a=f.open({templateUrl:"views/changeUserAvatar.html",controller:"ChUserAvatarCtrl",windowClass:"avatar-upload-modal",resolve:{}});a.result.then(function(a){e.ponmCtxConfig.avatar=a,e.user&&(e.user.avatar=a)},function(a){b.debug("dismissed avatar is "+a),a&&(e.ponmCtxConfig.avatar=a,e.user&&(e.user.avatar=a))})}}]).controller("SettingsAccountCtrl",["$window","$log","$location","$rootScope","$scope","$modal","$state","SettingsService","alertService","ponmCtxConfig",function(a,b,c,d,e,f,g,h){e.changeAccount=function(){e.saving=!0,h.changeAccount({userId:e.userId},e.settings,function(a){e.saving=!1,"OK"==a.status?e.alertService.add("success","保存成功!",{ttl:1e3}):e.alertService.add("danger","保存失败!",{ttl:1e3})})}}]).controller("SettingsPasswordCtrl",["$window","$log","$location","$rootScope","$scope","$modal","$state","SettingsService","alertService",function(a,b,c,d,e,f,g,h){e.changePassword=function(){b.debug("changePassword"),h.changePassword({userId:e.userId},e.password,function(a){b.debug(a.status),e.saving=!1,"OK"==a.status?e.alertService.add("success","更改成功!",{ttl:1e3}):e.alertService.add("danger","更改失败 "+a.info,{ttl:1e3})},function(a){b.debug(a),a.data&&"PARAM_ERROR"==a.data.status&&"currentPassword"==a.data.info&&e.alertService.add("danger","当前密码错误!",{ttl:2e3})})}}]).controller("SettingsSecurityCtrl",["$window","$log","$location","$rootScope","$scope","$modal","$state","UserPhoto","UserService","ponmCtxConfig","AuthService","alertService",function(){}]).controller("SettingsNotificationsCtrl",["$window","$log","$location","$rootScope","$scope","$modal","$state","UserPhoto","UserService","ponmCtxConfig","AuthService","alertService",function(){}]).controller("SettingsMapCtrl",["$window","$log","$location","$rootScope","$scope","$modal","$state","SettingsService","alertService",function(a,b,c,d,e,f,g,h){e.changeMapVendor=function(){e.saving=!0,h.changeMapVendor({userId:e.userId},e.settings,function(b){e.saving=!1,"OK"==b.status?(e.alertService.add("success","保存成功!",{ttl:1e3}),a.location.reload()):e.alertService.add("danger","保存失败!",{ttl:1e3})})}}]).controller("SettingsPhotoCtrl",["$window","$log","$filter","$rootScope","$scope","$modal","$state","UserPhoto","SettingsService","ponmCtxConfig","AuthService","alertService",function(a,b,c,d,e,f,g,h,i,j){e.$watch("settings",function(a){if(a){a.storage_space||(a.storage_space=0);var b=a.storage_space/10737418240*100;b=c("number")(b,1),0!==b&&.1>b&&(b=.1),e.storageRate=b,e.capacity={type:"success",value:b,stacked:[]},b>90?(e.capacity.type="danger",e.capacity.stacked.push({type:"success",value:"70"}),e.capacity.stacked.push({type:"warning",value:"20"}),e.capacity.stacked.push({type:"danger",value:b-90})):b>70?(e.capacity.type="warning",e.capacity.stacked.push({type:"success",value:"70"}),e.capacity.stacked.push({type:"warning",value:b-70})):e.capacity.stacked.push({type:"success",value:b})}}),e.changeUpload=function(){e.saving=!0,i.changeUpload({userId:e.userId},e.settings,function(a){e.saving=!1,"OK"==a.status?(j.settings.autoUpload=e.settings.auto_upload,e.alertService.add("success","保存成功!")):e.alertService.add("danger","保存失败 "+a.info)},function(a){a.data&&"PARAM_ERROR"==a.data.status&&"currentPassword"==a.data.info&&e.alertService.add("danger","当前密码错误!")})}}]),angular.module("fileuploadApp",["ngResource","ngAnimate","ui.bootstrap","blueimp.fileupload","ui.map","ponmApp","xeditable","duScroll"]).config(["$httpProvider","fileUploadProvider","$logProvider",function(a,b){delete a.defaults.headers.common["X-Requested-With"],b.defaults.redirect=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s"),angular.extend(b.defaults,{maxFileSize:1e7,acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,previewCanvas:!1,previewCrop:!1})}]).controller("DemoFileUploadController",["$window","$scope","$http","fileUpload","$modal","$log","$q","PhotoService","GPSConvertService","LoginUserService","UserService","TravelService","jsUtils","safeApply","ponmCtxConfig","alertService","MessageService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a,c){a.photoId=c.id,a.is360=c.is360,a.vendor=o.getCoordSS(c.vendor),!a.lat&&c.point&&0!=c.point.lat&&0!=c.point.lng&&(a.lat=c.point.lat,a.lng=c.point.lng,a.latPritty=cnmap.GPS.convert(a.lat),a.lngPritty=cnmap.GPS.convert(a.lng)),angular.extend(a.photo,c),a.address||b.$emit("photoAdd",a.photo)}function s(a){if(a){var c=[];angular.forEach(b.queue,function(a){a.photoId&&c.push(a.photoId)}),c.length&&l.addPhoto({travelId:a.id},m.param({photos:c.join(",")}),function(c){"OK"==c.status?(b.alertService.add("success","更新成功"),a.message||t(a)):b.alertService.add("danger","更新失败:"+c.info,{ttl:3e3})},function(){b.alertService.add("danger","更新失败",{ttl:3e3})})}}function t(a){q.save({},{type:"travel",travel:{id:a.id}},function(b){"OK"==b.status&&(a.message=b.message)},function(){})}b.apirest=a.apirest,b.ctx=a.ctx,b.userId=o.userId,b.$watch(function(){return o.userId},function(a){b.userId=a}),b.alertService=angular.copy(p),b.alertService.options.alone=!0,b.alertService.options.ttl=3e3;new a.cnmap.MapService;b.options={autoUpload:!!o.settings.autoUpload,url:b.apirest+"/photo/upload",formData:function(){var a=this.files[0].lat||0,b=this.files[0].lng||0,c=this.files[0].address||"",d=o.getCoordSS(this.files[0].vendor);return[{name:"lat",value:a},{name:"lng",value:b},{name:"address",value:c},{name:"vendor",value:d}]},done:function(a,c){if("OK"==c.result.status){var d=c.result.prop;c.files[0].$submit=!1,c.files[0].$cancel=!1,c.files[0].$endestroy=!0,r(c.files[0],d),c.files[0].saveProperties(),c.files[0].saveTags(),b.travel&&s(b.travel)}else"NO_AUTHORIZE"==c.result.status?(c.files[0].error="请重新登录",c.files[0].$endestroy=!1):(c.files[0].error=c.result.info,c.files[0].$endestroy=!1)},fail:function(a,b){b.result?("NO_AUTHORIZE"==b.result.status&&(b.files[0].error="请重新登录"),"ACCESS_DENIED"==b.result.status&&(b.files[0].error="请重新登录"),b.files[0].$cancel=function(){b.files[0].$destroy()}):d.defaults.fail(a,b)}},d.defaults.autoUpload||(b.options.add=function(a,c){if(a.isDefaultPrevented())return!1;d.defaults.add(a,c);var e=c.files[0];e.uuid=m.uuid(),e.photo={id:e.uuid,uuid:e.uuid},loadImage.parseMetaData(e,function(a){if(a.exif){var c=a.exif.getText("GPSLatitude");if(c&&"undefined"!=c){e.lat=cnmap.GPS.convert(c);var d=a.exif.getText("GPSLatitudeRef");e.latRef=d}var f=a.exif.getText("GPSLongitude");if(f&&"undefined"!=f){e.lng=cnmap.GPS.convert(f);var g=a.exif.getText("GPSLongitudeRef");e.lngRef=g}e.latPritty=cnmap.GPS.convert(e.lat),e.lngPritty=cnmap.GPS.convert(e.lng),(e.lng||e.lat)&&("baidu"==o.getCoordSS()?BMap.Convertor.translate({lat:e.lat,lng:e.lng},0,function(a){e.lat=a.lat,e.lng=a.lng,e.latPritty=cnmap.GPS.convert(e.lat),e.lngPritty=cnmap.GPS.convert(e.lng),e.photo.point={lat:e.lat,lng:e.lng},b.$emit("photoAdd",e.photo)}):i.convert({lat:e.lat,lng:e.lng,dest:"baidu"==o.getCoordSS()?"baidu":"mars"},function(a){e.lat=a.lat,e.lng=a.lng,e.latPritty=cnmap.GPS.convert(e.lat),e.lngPritty=cnmap.GPS.convert(e.lng),e.photo.point={lat:e.lat,lng:e.lng},b.$emit("photoAdd",e.photo)}))}})}),b.convertPritty=function(a){a.latPritty=cnmap.GPS.convert(a.lat),a.lngPritty=cnmap.GPS.convert(a.lng)},b.loadTravelData=function(){{var a=g.defer();k.getTravels({userId:b.userId},function(b){"OK"==b.status&&a.resolve(b.open_info.travels)})}return a.promise},b.newTravelData=function(a){f.debug("new data: "+a);var b=g.defer();return l.create({},m.param({travel:a}),function(a){"OK"==a.status?b.resolve(a.travel):b.reject()},function(){b.reject()}),b.promise},b.loadTagData=function(){f.debug("load tags data");var a=g.defer();return k.getTags({userId:b.userId},function(b){"OK"==b.status?a.resolve(b.open_info.tags):a.reject()},function(){a.reject()}),a.promise},b.newTagData=function(a){f.debug("new data: "+a);var c=g.defer();return k.createTag({userId:b.userId,value:a},function(b){"OK"==b.status?c.resolve(a):c.reject()},function(){c.reject()}),c.promise},b.$watch("travel",function(a){s(a)}),b.$watch("tags",function(){angular.forEach(b.queue,function(a){a.photoId&&a.saveTags()})}),b.publishMessages=function(){angular.forEach(b.queue,function(a){a.photoId&&!a.messageId&&q.save({},{type:"photo",photo:{id:a.photoId}},function(c){"OK"==c.status&&(b.alertService.add("success","发表成功"),a.messageId=c.message.id)},function(){a.messageId=!0})})},b.activePhoto=function(a){angular.forEach(b.queue,function(c){a.photo.uuid==c.photo.uuid?(c.active=!0,b.$emit("photoActive",a.photo)):c.active=!1})}}]).controller("PhotoUploadRowCtrl",["$scope","$document","$q","$log","$timeout","PhotoService","jsUtils","safeApply",function(a,b,c,d,e,f,g,h){a.$on("photoReverseActive",function(c,e){if(a.file.photo.uuid==e.uuid){if(!a.file.active){d.debug("photoReverseActive "+e.uuid),a.file.active=!0;var f=angular.element(document.getElementById("upload-photo-"+e.uuid));b.scrollToElementAnimated(f,160)}}else a.file.active=!1}),a.$on("photoReverseAddress",function(b,c){var e=a.file;e.photo.uuid==c.uuid&&(d.debug("photoReverseAddress : "+c.id),h(a,function(){e.mapVendor=c.mapVendor,e.address=c.mapVendor.address,e.lat=c.mapVendor.lat,e.lng=c.mapVendor.lng,a.convertPritty(e),e.saveProperties()}))}),a.$on("editableViewChanged",function(a,b){}),a.saveProperties=function(b,d){var e=c.defer();if(a.file.photoId){var g={title:a.file.title,description:a.file.description,point:{lat:a.file.lat,lng:a.file.lng,address:a.file.address},vendor:a.file.vendor,is360:a.file.is360};"address"==b?g.point[b]=d:g[b]=d,f.updateProperties({photoId:a.file.photoId},g,function(b){"OK"==b.status?(a.alertService.add("success","更新成功"),e.resolve()):e.resolve(b.info)},function(b){a.alertService.add("danger","更新失败",{ttl:3e3}),e.reject(b.data?b.data.info:"Server error!")})}else"address"==b?a.file.point&&(a.file.point[b]=d):a.file[b]=d,e.resolve();return e.promise};var i=a.file;i.tags=[],a.indoor={tag:"室内"},i.saveProperties=function(){if(this.photoId){var b=this;f.updateProperties({photoId:b.photoId},{title:b.title,description:b.description,point:{lat:b.lat,lng:b.lng,address:b.address},vendor:b.vendor,is360:b.is360,color:b.color},function(b){b&&a.alertService.add("success","更新成功")},function(){a.alertService.add("danger","更新失败",{ttl:3e3})})}},i.saveTags=function(){var b=this,c=[];b.photoId&&(a.indoor.is&&c.push(a.indoor.tag),c=c.concat(b.tags||[]).concat(a.tags||[]),f.tag({photoId:b.photoId},c,function(b){b&&a.alertService.add("success","更新成功")},function(){a.alertService.add("danger","更新失败",{ttl:3e3})}))},a.$watch("file.tags",function(){i.saveTags()}),a.$watch("file.is360",function(){i.saveProperties()}),a.$watch("indoor.is",function(){i.saveTags()}),a.onDragStart=function(a,b){var c=angular.element("<div/>");c.addClass("marker"),c.css("left",a.offsetX-10+"px"),c.css("top",a.offsetY-25+"px"),angular.element(b.helper).append(c),angular.element(b.helper).addClass("drag-marker"),a.photoId=i.photoId}}]).controller("FileDestroyController",["$scope","$log","PhotoService",function(a,b,c){var d,e=a.file;e.$state=function(){return d},e.$destroy=function(){e.photoId&&(d="pending",c.delete({photoId:e.photoId},function(a){d=a?"resolved":"rejected"})),a.clear(e)},e.$cancel||e._index||(e.$cancel=function(){a.clear(e),b.debug("delete upload photo: "+e.name)}),a.delete=function(c){b.debug("delete upload photo: "+c.name),c.photoId?c.$destroy():c.$cancel(),a.$emit("photoDelete",c.photo)}}]).directive("fileUploadColorPreview",["$log","rgbHex",function(a,b){return{restrict:"A",link:function(c,d,e){var f=new ColorThief;c.$watch(e.fileUploadColorPreview+".preview",function(g){if(d.empty(),g){d.append(g);var h=d.find("img");if(h&&h.length){var i=f.getColor(h[0]),j=f.getPalette(h[0]),k=c.$eval(e.fileUploadColorPreview);k&&(k.color=b(i)),k&&(k.palette=j),a.debug(k.color)}}})}}}]),angular.module("ponmApp.Index",["ngSanitize","ponmApp","ponmApp.controllers","ponmApp.photos","ponmApp.maps","ponmApp.settings","adminApp","indexApp","ponmApp.dynamic","ponmApp.user","ui.router","ui.map","ui.bootstrap","ponm.Matchmedia","LocalStorageModule"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","uiMapLoadParamsProvider","$sceDelegateProvider",function(a,b,c,d,e){b.otherwise("/maps"),a.state("home",{url:"/",views:{"":{template:"<div>home view</div>"},"navbar@":{templateUrl:"views/ponm.navbar.html",controller:"NavbarCtrl"}}}),e.resourceUrlWhitelist(["self","http://bdimg.share.baidu.com/**"]),d.setParams("baidu"==window.mapVendor?{v:"2.0",ak:"kp3ODQt4pkpHMW2Yskl2Lwee"}:"qq"==window.mapVendor?{v:"2.0",key:"ZYZBZ-WCCHU-ETAVP-4UZUB-RGLDJ-QDF57"}:"google"==window.mapVendor?{key:"AIzaSyA9e11ZRebw8fHsd1ZIi0FLTXsrSQTc490"}:"bing"==window.mapVendor?{v:"7.0",mkt:"zh-HK,en-US",key:"AhgYefMukpWZ3Y3MDp_oUztLbpDSGFkiqAgiKD7KNCurMLR2rDmwi9bM8N405mNX"}:{v:"1.3",key:"53f7e239ddb8ea62ba552742a233ed1f"})}]).run(["$rootScope","$state","localStorageService","AuthService","$cacheFactory",function(a,b,c,d,e){a.cache=e("cacheId2");var f="unauthState";a.$on("$stateChangeStart",function(a,e,g,h){"login"==h.name&&d.checkLogin().then(function(){},function(){});var i=c.get(f);"login"!=e.name&&i&&(d.checkLogin().then(function(){b.go(i,{})},function(){}),c.set(f,"")),("maps.dynamic"==e.name||"maps.upload"==e.name||"dynamic.my"==e.name||"photos"==e.name)&&d.checkLogin().then(function(){},function(){a.preventDefault(),"login"==h.name?b.go("maps.popular",{}):(c.set(f,e.name),b.go("login",{}))})}),a.$on("$stateChangeSuccess",function(b,c){a.pageNavMode=c.name.indexOf("maps.")>=0?"fixed":""})}]).controller("IndexCtrl",["$window","$location","$rootScope","$scope","PhotoService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","safeApply","jsUtils","HashStateManager","AuthService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){d.checkLogin=function(){return o.checkLogin()},d.checkLogin().then(function(){d.$broadcast("user.login")}),d.displayLogin=function(){var a=g.open({templateUrl:"views/ponm.login.html",controller:"LoginCtrl",windowClass:"photo-modal-fullscreen",resolve:{}});a.result.then(function(){},function(){})}}]).controller("AlertsCtrl",["$window","$rootScope","$scope","ponmCtxConfig","$log","$state","$stateParams","alertService",function(a,b,c,d,e,f,g,h){c.alertService=h}]);