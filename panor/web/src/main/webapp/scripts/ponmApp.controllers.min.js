"use strict";angular.module("aTravelApp",["ponmApp","ui.map","ui.bootstrap","xeditable"]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("ATravelCtrl",["$window","$scope","$log","$http","$location","TravelService","$modal","$q","param",function(a,b,c,d,e,f,g,h,i){function j(){e.search(i(n))}function k(a){f.getTravel({travelId:a},function(a){"OK"==a.status&&(b.travel=a.travel,b.travelEnedit=b.userId==b.travel.user_id,angular.isArray(b.travel.spots)||(b.travel.spots=[]),b.travel.spot&&b.travel.spots.push(b.travel.spot),angular.forEach(b.travel.spots,function(a){a.addresses={},angular.forEach(a.photos,function(b){b.point.address&&(a.addresses[b.point.address]=b.point)})}),m.clearMap(),m.setTravel(b.travel),m.initMap(),b.travel.spots[0]&&b.activeSpot(b.travel.spots[0]))})}b.ctx=a.ctx,b.apirest=a.apirest,b.userId=a.userId;var l=a.cnmap.MapEventListener.factory(),m=new a.cnmap.TravelLayer({ctx:b.ctx,travel:b.travel,clickable:!0});jQuery(m).bind("data_clicked",function(a,c){b.displayPhoto(c)});var n={};b.$watch(function(){return e.search()},function(a){a.id&&a.id!=n.id&&(n.id=a.id,a.id!=b.travelId&&(b.travelId=a.id,k(a.id))),a.photoid&&a.photoid!=n.photoid&&(n.photoid=a.photoid,b.displayPhoto(a.photoid))}),b.activePhoto=function(a){b.photo&&b.photo.id==a.id?b.displayPhoto(a.id):(b.photo=a,m.activePhoto(a))},b.activeSpot=function(a){m.activeSpot(a)},b.updateTravel=function(a,b){var c=h.defer();return f.changeTravel({travelId:a.id},i({description:b}),function(a){a=a||{},"OK"===a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.updateSpot=function(a,b,c,d){var e=h.defer(),g={title:b.title,description:b.description,address:b.address};return g[c]=d,f.changeSpot({travelId:a.id,typeId:b.id},i(g),function(a){a=a||{},"OK"===a.status?e.resolve():e.resolve(a.info)},function(a){e.reject(a.data?a.data.info:"Server error!")}),e.promise},b.showSpotAddress=function(a){return a.address||"添加地址"},b.$on("photoDeleteEvent",function(a,d){c.debug("photo delete event: photoId = "+d),a.preventDefault(),a.stopPropagation(),f.deletePhoto({travelId:b.travel.id,typeId:d},function(a){"OK"==a.status&&(angular.forEach(b.travel.spots,function(a,c){angular.forEach(a.photos,function(b,c){b.id==d&&delete a.photos.splice(c,1)}),a.photos.length||delete b.travel.spots.splice(c,1)}),b.$broadcast("ponmPhotoFluidResize"))})}),b.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0,scaleControl:!0},b.$watch("myMap",function(){var a=b.myMap;l.addToolBar(a),m.setMap(a)}),b.scrollCallback=function(){},b.displayPhoto=function(a){n.photoid=a,j();var c=g.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return b.travel&&b.travel.id||""}}});c.result.then(function(){delete n.photoid,j()},function(){delete n.photoid,j()})}}]),angular.module("ponmApp.controllers").controller("ChLocModalCtrl",["$window","$scope","$log","$modalInstance","files","GPSConvertService","GeocodeService",function(a,b,c,d,e){function f(a,c,d){if(a.mapVendor=a.mapVendor||{},c&&d)a.mapVendor.lat=c,a.mapVendor.lng=d;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=i.createDraggableMarker(b.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,i.setMap(a.mapVendor.marker,b.map),i.addMarkerActiveListener(a.mapVendor.marker,function(){b.activePhoto(this.photo_file)}),i.addDragendListener(a.mapVendor.marker,function(a,c){b.setPlace(this.photo_file,a,c)})}function g(a){i.addMapClickListener(a,function(a,c){h(b.file,a,c),b.setPlace(b.file,a,c)})}function h(a,c,d){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(i.setPosition(a.mapVendor.marker,c,d),i.setMap(a.mapVendor.marker,b.map)):(f(a,c,d),i.activeMarker(a.mapVendor.marker))}var i=a.cnmap.MapEventListener.factory(),j=a.cnmap.MapService.factory();b.mapEventListener=i,b.mapService=j,angular.forEach(e,function(a){if(a.active=!1,delete a.mapVendor,!a.modal&&a.preview){var b=cnmap.cloneCanvas(a.preview);a.modal={preview:b}}a.mapVendor=a.mapVendor||{},a.mapVendor.is360=a.is360}),angular.forEach(e,function(a){!a.loc_preview&&loadImage&&loadImage(a,function(b){a.loc_preview=a.loc_preview||{},jQuery(b).removeAttr("width").removeAttr("height"),a.loc_preview.preview=b},{maxWidth:600,maxHeight:300,minWidth:100,minHeight:50,canvas:!1})}),b.files=e,b.file=b.files[0],b.ok=function(){var a=[];angular.forEach(e,function(b){b.mapVendor&&(b.address=b.mapVendor.address,b.is360=b.mapVendor.is360,b.lat=b.mapVendor.lat,b.lng=b.mapVendor.lng,b.latPritty=b.mapVendor.latPritty,b.lngPritty=b.mapVendor.lngPritty,b.vendor="gaode",a.push(b))}),d.close(a)},b.cancel=function(){d.dismiss("cancel")},b.$watch("$$childTail",function(){b.$$childTail&&b.$$childTail.$watch("myMap",function(){b.$$childTail.myMap&&(b.map=b.$$childTail.myMap,angular.forEach(e,function(a){f(a)}),j.init(b.map),g(b.map),b.activePhoto(b.file))})}),b.addOrUpdateMarker=h,b.setPlace=function(a,c,d,e){b.file.mapVendor=b.file.mapVendor||{},b.file.mapVendor.lat=c,b.file.mapVendor.lng=d,b.file.mapVendor.latPritty=cnmap.GPS.convert(c),b.file.mapVendor.lngPritty=cnmap.GPS.convert(d),e&&(b.file.mapVendor.address=e),j.getAddrPois(c,d,function(a,c){e||(b.file.mapVendor.address=c),b.file.mapVendor.addresses=a})},b.clearPlace=function(){},b.activePhoto=function(a){b.file.active=!1,b.file.mapVendor&&i.deactiveMarker(b.file.mapVendor.marker),b.file=a,b.file.active=!0,b.file.mapVendor&&(b.file.mapVendor.lat?(i.activeMarker(b.file.mapVendor.marker),i.inMapView(b.file.mapVendor.lat,b.file.mapVendor.lng,b.map)||i.setCenter(b.map,b.file.mapVendor.lat,b.file.mapVendor.lng),b.setPlace(b.file,b.file.mapVendor.lat,b.file.mapVendor.lng)):b.clearPlace())},b.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]).controller("TypeaheadCtrl",["$scope","$http","GeocodeService","$q",function(a,b,c,d){a.selected=void 0,a.states=[],a.getLocation=function(b){var c=d.defer();return a.mapService.getLocPois(b,function(a){c.resolve(a)}),c.promise.then(function(a){return a})},a.goLocation=function(b){var c=b.location;c&&(a.mapEventListener.setCenter(a.map,c.lat,c.lng),a.mapEventListener.setZoom(a.map,b.zoom))}}]),angular.module("ponmApp.controllers").controller("ChUserAvatarCtrl",["$window","$scope","$log","$sce","$http","$modalInstance",function(a,b,c,d,e,f){var g=a.apirest+"/user/avatar";b.cancel=function(){f.dismiss(b.avatar)};var h=a.URL&&a.URL.createObjectURL.bind(a.URL)||a.webkitURL&&a.webkitURL.createObjectURL.bind(a.webkitURL)||a.createObjectURL;b.fileUpload=function(){if(b.closeAlert(0),b.$$childTail.$$childTail.previewUrl){var a=Math.random().toString().substr(2),c="";c+="--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="avatar.png"\r\nContent-type: application/octet-stream\r\n\r\n'+b.$$childTail.$$childTail.previewUrl+"\r\n",c+="--"+a+"--\r\n",e({method:"POST",url:g,data:c,headers:{"Content-Type":"multipart/form-data; charset=utf-8; boundary="+a}}).success(function(a){"OK"==a.status?(b.avatar=a.open_info.avatar,b.addAlert({type:"success",msg:"上传成功!"})):b.addAlert({type:"danger",msg:"上传失败!"})})}},b.onFileSelect=function(a){b.closeAlert(0);var c=d.trustAsResourceUrl(h(a[0]));b.imageUrl=c},b.addAlert=function(a){b.alerts=[],b.alerts.push(a)},b.closeAlert=function(a){b.alerts&&b.alerts.splice(a,1)}}]).directive("imgCropped",function(){return{restrict:"E",replace:!0,scope:{src:"@",bind:"=previewUrl"},link:function(a,b){function c(b){var c=d[0],f=c.width,g=c.height,h=$(c).width(),i=$(c).height(),j=b.x*f/h,k=b.y*g/i,l=b.w*f/h,m=b.h*g/i,n=document.createElement("canvas");n.width=100,n.height=100;var o=n.getContext("2d");o.drawImage(c,j,k,l,m,0,0,100,100),a.$apply(function(){a.previewUrl=n.toDataURL("image/png"),e.attr("src",a.previewUrl)})}var d,e,f=800,g=420,h=function(){d&&(d.next().remove(),d.remove(),d=void 0),e&&(e.next().remove(),e.remove(),e=void 0)};a.$watch("src",function(a){h(),a&&(b.after("<img />"),d=b.next(),d.attr("src",a),$(d).Jcrop({trackDocument:!0,bgFade:!0,boxWidth:f,boxHeight:g,minSize:[16,16],onSelect:c,aspectRatio:1}),d.after("<img />"),e=d.next())}),a.$on("$destroy",h)}}}).directive("ngFileSelect",["$parse","$timeout",function(a,b){return function(c,d,e){var f=a(e.ngFileSelect);d.bind("change",function(a){var d,e,g=[];if(d=a.target.files,null!=d)for(e=0;e<d.length;e++)g.push(d.item(e));b(function(){f(c,{$files:g,$event:a})})}),d.bind("click",function(){this.value=null})}}]),angular.module("exploreWorldApp",["ponmApp","ui.map","ui.bootstrap"]).controller("ExploreWorldCtrl",["$window","$location","$scope","UserService","$modal","deparam","param","$timeout",function(a,b,c,d,e,f,g,h){function i(){c.photoEnd=c.slice+m<=c.allPhotos.length?!1:!0,c.photoStart=c.slice>=m?!1:!0}function j(a){o.addLocationHashListener(a,function(a,b,c){k(a,b,c)}),c.$watch(function(){return b.hash()},function(b){if(!q){var d=f(b);if(l(d,"photoid"),d.lat&&d.lng&&(p.lat!=d.lat||p.lng!=d.lng||p.zoom!=d.zoom)&&(c.setState&&h.cancel(c.setState),q=!0,o.setCenter(a,d.lat,d.lng),d.zoom&&o.setZoom(a,d.zoom),c.setState=h(function(){q=!1},500),d.bounds)){var e=d.bounds.split(",");4==e.lenght&&o.setBounds(a,{lat:e[0],lng:e[1]},{lat:e[2],lng:e[3]})}angular.copy(d,p),d.latest?c.setPanormaioType("latest"):d.userid&&(d.favorite?c.setPanormaioType("favorite",d.userid):c.setPanormaioType("user",d.userid)),d.photoid&&c.displayPhoto(d.photoid)}})}function k(a,d,e){if(!q){var i=f(b.hash());l(i,"photoid"),a&&d&&e&&(p.lat=a,p.lng=d,p.zoom=e),(p.lat!=i.lat||p.lng!=i.lng||p.zoom!=i.zoom||p.latest!=i.latest||p.userid!=i.userid||p.favorite!=i.favorite||p.photoid!=i.photoid)&&(c.setState&&h.cancel(c.setState),q=!0,b.hash(g(p)),c.setState=h(function(){q=!1},500))}}function l(a,b){if(a[b]){var c=a[b].split("#");a[b]=c[0]}}c.ctx=a.ctx,c.apirest=a.apirest,c.login=a.login,c.userId=a.userId,c.user={},c.login&&c.userId&&(c.user={id:c.userId,name:"您"}),c.tabs={map:!0},c.photos=[],c.allPhotos=[],c.slice=0,c.photoStart=!0,c.photoEnd=!0,c.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0,scaleControl:!0};var m=20;"qq"==a.mapVendor&&(a.mapVendor="gaode");var n=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});n.initEnv(a.ctx),$(n).bind("data_changed",function(a,b){c.$apply(function(){var a=jQuery("div#thumbinnerarea"),d=a.innerWidth(),e=a.innerHeight(),f=Math.floor((d-40)/116);m=f*Math.floor((e-50)/116),c.updatePhoto(b)})}),jQuery(n).bind("data_clicked",function(a,b){c.displayPhoto(b)}),c.setPanormaioType=function(a,b){switch(c.tabs={},c.tabs[a]=!0,b&&(c.user.id=b,c.login&&b==c.userId?c.user.name="您":d.getOpenInfo({userId:b},function(a){"OK"==a.status&&(c.user.name=a.open_info&&a.open_info.name)})),n.setFavorite(!1),n.setUserId(""),n.setLatest(!1),delete p.userid,delete p.latest,delete p.favorite,a){case"user":n.setFavorite(!1),n.setUserId(c.user.id),p.userid=c.user.id;break;case"map":n.setUserId(void 0);break;case"latest":n.setLatest(!0),p.latest=!0;break;case"favorite":n.setFavorite(!0),p.favorite=!0,n.setUserId(c.user.id),p.userid=c.user.id}n.trigger("changed")},c.updatePhoto=function(a){c.allPhotos=a,c.photos=a.slice(0,m),c.slice=0,i()},c.nextPhoto=function(){c.slice<=c.allPhotos.length&&(c.slice=c.slice+m,c.photos=c.allPhotos.slice(c.slice,c.slice+m),i())},c.prePhoto=function(){c.slice>=m&&(c.slice=c.slice-m,c.photos=c.allPhotos.slice(c.slice,c.slice+m),i())};var o=a.cnmap.MapEventListener.factory();c.$watch("myMap",function(){if(!c.map){c.map=c.myMap;var a=c.myMap;n.setMap(a),j(a),o.addToolBar(a)}});var p={},q=!1;c.displayPhoto=function(a){p.photoid=a,k();var b=e.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}});b.result.then(function(){delete p.photoid,k()},function(){delete p.photoid,k()})}}]),angular.module("map.AMap",["ngRoute","ngResource","ui.bootstrap"]).controller("TypeaheadCtrl",["$scope","$log","$http",function(a,b,c){a.getLocation=function(a){return c.get("http://restapi.amap.com/v3/geocode/geo",{params:{key:"53f7e239ddb8ea62ba552742a233ed1f",address:a}}).then(function(a){var c=[];return angular.forEach(a.data.geocodes,function(a){b.debug(a),c.push(a)}),c})},a.update=function(a){var c=a.location;c&&(c=c.split(","),b.debug(c))}}]),angular.module("indexApp",["ponmApp","ui.map"]).controller("IndexCtrl",["$window","$scope",function(a,b){function c(a){$(".front-photo_sizer img").attr("src",ctx+"/api/rest/photo/"+a.id+"/1"),$(".front-photo_sizer a").attr("href",ctx+"/photo/"+a.id),d.setCenter(b.map,a.lat,a.lng),a.mark||(a.mark=!0,d.createDraggableMarker(b.map,a.lat,a.lng)),$("div.imgLiquidFill").imgLiquid({fill:!0}),e.length>1&&setTimeout(function(){c(e[f]),f=(f+1)%e.length},4e3)}var d=a.cnmap.MapEventListener.factory();b.mapOptions={resizeEnable:!0,panControl:!1,zoomControl:!1,uiMapCache:!1},$("div.imgLiquidFill").imgLiquid({fill:!0});var e,f,g=new $.RestClient(window.ctx+"/api/rest/");g.add("index"),g.index.read("photo").done(function(a){e=a,f=0,e.length&&(c(e[f]),f=(f+1)%e.length)})}]),angular.module("ponmApp.login",["ponmApp"]).controller("LoginCtrl",["$window","$scope","$log","$q","param","$location","$cookieStore",function(a,b,c,d,f,g){b.ctx=a.ctx,b.credentials={},b.login=function(a){b.credentials.username&&b.credentials.password||(a.preventDefault(),a.stopPropagation())},b.passwordHint=function(){b.credentials.username?g.$$absUrl=ctx+"/passwordHint?username="+b.credentials.username:(alert("用户名 为必填项。"),e.preventDefault(),e.stopPropagation())}}]),angular.module("mapPhotoApp",["ponmApp","ui.bootstrap","ui.map"]).controller("MapPhotoCtrl",["$window","$location","$log","$scope","PhotoService",function(a,b,c,d,e){function f(){d.file&&d.file.mapVendor&&d.file.mapVendor.marker&&j.setMap(d.file.mapVendor.marker,null),d.file={photoId:d.photoId},e.getPhoto({photoId:d.photoId},function(a){"OK"==a.status&&(d.file.is360=a.prop.is360)}),e.getGPSInfo({photoId:d.photoId},function(a){"OK"==a.status&&(i(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng),j.setCenter(d.map,a.gps[0].gps.lat,a.gps[0].gps.lng),d.setPlace(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng,a.gps[0].gps.address))})}function g(a,b,c){if(a.mapVendor=a.mapVendor||{},b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=j.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,j.setMap(a.mapVendor.marker,d.map),j.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function h(a){j.addMapClickListener(a,function(a,b){i(d.file,a,b),d.setPlace(d.file,a,b)})}function i(a,b,c){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(j.setPosition(a.mapVendor.marker,b,c),j.setMap(a.mapVendor.marker,d.map)):(g(a,b,c),j.activeMarker(a.mapVendor.marker))}d.ctx=a.ctx,d.apirest=a.apirest;var j=a.cnmap.MapEventListener.factory(),k=a.cnmap.MapService.factory();d.mapEventListener=j,d.mapService=k,d.$watch(function(){return b.hash()},function(a){var b=jQuery.deparam(a);b&&b.id&&(d.photoId=b.id,f(d.photoId))}),d.ok=function(){e.updateProperties({photoId:d.photoId},{point:{lat:d.file.mapVendor.lat,lng:d.file.mapVendor.lng,address:d.file.mapVendor.address},vendor:"gaode",is360:d.file.is360},function(a){"OK"==a.status?(c.debug("properties update successful"),d.addAlert({type:"success",msg:"保存成功!"})):d.addAlert({type:"danger",msg:"保存失败 "+a.status})})},d.cancel=function(){a.history.back()},d.$watch("myMap",function(a){d.map=a,k.init(a),h(d.map),f()}),d.addOrUpdateMarker=i,d.setPlace=function(a,b,c,e){d.file.mapVendor=d.file.mapVendor||{},d.file.mapVendor.lat=b,d.file.mapVendor.lng=c,d.file.mapVendor.latPritty=cnmap.GPS.convert(b),d.file.mapVendor.lngPritty=cnmap.GPS.convert(c),e?d.file.mapVendor.address=e:k.getAddress(b,c,function(a){d.$apply(function(){d.file.mapVendor.address=a})})},d.clearPlace=function(){},d.addAlert=function(a){d.alerts=[],d.alerts.push(a)},d.closeAlert=function(a){d.alerts&&d.alerts.splice(a,1)},d.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]).controller("TypeaheadCtrl",["$scope","$http",function(a,b){a.selected=void 0,a.states=[],a.getLocation=function(a){return b.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},a.goLocation=function(b){var c=b.geometry;c&&(a.mapEventListener.setCenter(a.map,c.location.lat,c.location.lng),a.addOrUpdateMarker(a.file,c.location.lat,c.location.lng),a.setPlace(a.file,c.location.lat,c.location.lng,b.formatted_address),a.mapEventListener.setBounds(a.map,c.viewport.southwest,c.viewport.northeast))}}]),angular.module("ponm.Navbar",["ngResource","ui.bootstrap"]).controller("SearchLocCtrl",["$window","$scope","$log","$http",function(a,b,c,d){b.ctx=a.ctx,b.getLocation=function(a){return d.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},b.update=function(c){var d=c.geometry;d&&(a.location=b.ctx+"/map##lat="+d.location.lat+"&lng="+d.location.lng+"&bounds="+d.bounds.southwest.lat+","+d.bounds.southwest.lng+","+d.bounds.northeast.lat+","+d.bounds.northeast.lng)}}]),angular.module("photoApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","ui.map","ponmApp","ponmApp.services","ponmApp.directives"]).controller("PhotoCtrl",["$window","$location","$log","$rootScope","$scope","$cookieStore","$cookies","PhotoService","CommentService","UserService","UserPhoto",function(a,b,c,d,e,f,g,h,i,j,k){function l(){h.getComments({photoId:e.photoId,pageSize:e.comment.pageSize,pageNo:e.comment.currentPage},function(a){"OK"==a.status&&(e.comments=a.comments)},function(){})}e.ctx=a.ctx,e.apirest=a.apirest;var m=a.cnmap.MapEventListener.factory(),n=b.absUrl(),o=n.match(/\/photo\/[0-9]+/g);e.photoId=o?o[0].match(/[0-9]+/g)[0]:8,e.photo={},e.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},e.comments=[],e.$watch("comment.currentPage",function(){l()}),e.user={},e.user.userId=a.userId,e.user.username=g.username,e.user.login=a.login,e.photo={},h.getPhoto({photoId:e.photoId},function(a){c.debug(a),"OK"==a.status&&(e.photo=a.prop,e.comment.totalItems=a.prop.comment_count,e.comment.numPages=Math.ceil(e.comment.totalItems/e.comment.pageSize),e.photo.save=function(){e.editable="",h.updateProperties({photoId:e.photoId},{title:e.photo.title,description:e.photo.description},function(){})},j.getOpenInfo({userId:e.photo.user_id},function(a){"OK"==a.status&&(e.userOpenInfo=a.open_info)}),k.get({userId:e.photo.user_id,pageSize:e.photoId},function(a){"OK"==a.status&&(e.user_photos=a.photos.slice(0,6))}))}),h.getGPSInfo({photoId:e.photoId,vendor:"gaode"},function(a){"OK"==a.status&&a.gps.length&&(e.gpsInfo=a.gps[0],c.debug(e.gpsInfo),e.gpsInfo.lat=cnmap.GPS.convert(e.gpsInfo.gps.lat),e.gpsInfo.lng=cnmap.GPS.convert(e.gpsInfo.gps.lng),m.setCenter(e.minimap1,e.gpsInfo.gps.lat,e.gpsInfo.gps.lng),m.addMarker(e.minimap1,e.gpsInfo.gps.lat,e.gpsInfo.gps.lng))}),h.getCameraInfo({photoId:e.photoId},function(a){"OK"==a.status&&(e.cameraInfo=a.camera_info),c.debug(e.cameraInfo)}),l(),e.user.login&&e.user.userId&&j.getOpenInfo({userId:e.user.userId},function(a){"OK"==a.status&&(e.user.open_info=a.open_info)}),e.setEditable=function(a){"true"==e.user.login&&e.userOpenInfo.name==e.user.username&&(e.editable=a)},e.deletePhoto=function(){a.alert("您确定要删除这张照片？")},e.createComment=function(a){a&&i.save({photoId:e.photoId,content:a},function(a){"OK"==a.status&&(e.comment.content="",e.comment.count=e.comment.count+1,e.comments.splice(0,0,a.comment))})},e.favorite=function(){e.user.login&&(e.photo.favorite?h.removeFavorite({photoId:e.photoId},function(a){"OK"==a.status&&(e.photo.favorite=!1)}):h.favorite({photoId:e.photoId},{},function(a){"OK"==a.status&&(e.photo.favorite=!0)}))},e.mapOptions={toolbar:!0,scrollzoom:!1,maptype:"SATELLITE",resizeEnable:!0,panControl:!1,level:13,uiMapCache:!1},"qq"==a.mapVendor&&(a.mapVendor="gaode");var p=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});p.initEnv(a.ctx),$(p).bind("data_changed",function(a,b){e.$apply(function(){e.update_nearby_photos(b)})}),e.$watch("minimap1",function(){if(!e.map){e.map=e.minimap1;var a=e.minimap1;p.setMap(a)}}),e.update_nearby_photos=function(a){e.nearby_photos=a&&a.slice(0,5)}}]),angular.module("ponmApp.controllers").controller("PhotoModalCtrl",["$window","$scope","$log","$modalInstance","photoId","travelId","PhotoService","CommentService","UserService","TravelService","$q","$modal","$filter","param","$location",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){g.getComments({photoId:a,pageSize:b.comment.pageSize,pageNo:b.comment.currentPage},function(a){"OK"==a.status&&(b.comments=a.comments)},function(){})}function p(a){j.getTravel({travelId:a},function(a){if("OK"==a.status){b.travel=a.travel,b.travel.photos=[],b.travel.totalPhoto=0,b.travel.currentPhoto=0;var c=0;angular.forEach(b.travel.spots,function(a){angular.forEach(a.photos,function(a){c+=1,a.id==e&&(a.active=!0,b.travel.activePhoto=a),a.sortCount=c,b.travel.photos.push(a)})}),b.travel.totalPhoto=c}})}b.ctx=a.ctx,b.apirest=a.apirest,b.photoId=e,b.userId=a.userId,b.login=a.login,b.photoDetailCollapsed=!0,b.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},b.setPhotoId=function(a){c.debug("photoId"+a),b.photoId=a,g.getPhoto({photoId:b.photoId},function(a){c.debug(a),"OK"==a.status&&(b.photo=a.prop,b.photoEditable=b.userId==b.photo.user_id,b.comment.totalItems=a.prop.comment_count,b.comment.numPages=Math.ceil(b.comment.totalItems/b.comment.pageSize),i.getOpenInfo({userId:b.photo.user_id},function(a){"OK"==a.status&&(b.userOpenInfo=a.open_info)}),f||(b.photo.travel_id?(f=b.photo.travel_id,p(f)):b.travel={}))}),g.getCameraInfo({photoId:a},function(a){"OK"==a.status&&(b.cameraInfo=a.camera_info),c.debug(b.cameraInfo)}),o(a)},f&&p(f),b.createComment=function(a){var c=k.defer();return a?h.save({photo_id:b.photoId,content:a},function(a){a=a||{},"OK"==a.status?(b.comment.count=b.comment.count+1,b.comments.push(a.comment),b.photo.comment_count+=1,c.resolve(!1)):c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}):c.resolve(!1),c.promise},b.updatePhoto=function(a,b,c){var d=k.defer(),e={};return e[b]=c,g.updateProperties({photoId:a.id},e,function(a){a=a||{},"OK"===a.status?d.resolve():d.resolve(a.info)},function(a){d.reject(a.data?a.data.info:"Server error!")}),d.promise},b.addTravel=function(a){var c=k.defer();return j.addPhoto({travelId:a},n({photos:b.photoId}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.showTravel=function(){var a=[];return b.userOpenInfo&&(a=m("filter")(b.userOpenInfo.travels,{id:b.photo.travel_id})),b.photo.travel_id&&a.length?a[0].title:"添加到旅行"},b.$on("deletedCommentEvent",function(a,c){a.preventDefault(),a.stopPropagation(),angular.forEach(b.comments,function(a,d){a.id==c&&(delete b.comments.splice(d,1),b.photo.comment_count-=1)})}),b.$on("replyCommentEvent",function(a,c){a.preventDefault(),a.stopPropagation(),b.comment.placeholder="回复 "+c.name,b.commentContent="@"+c.name+" "}),b.cancelComment=function(){b.comment.placeholder="",b.commentContent=""},b.like=function(){b.photo.like?g.unLike({photoId:b.photoId},function(a){a=a||{},"OK"===a.status&&(b.photo.like=!1,b.photo.like_count-=1)},function(a){a.data}):g.like({photoId:b.photoId},function(a){a=a||{},"OK"===a.status&&(b.photo.like=!0,b.photo.like_count+=1)},function(a){a.data})},b.cancel=function(){d.dismiss("cancel")},b.setTravelAlbum=function(a){b.travelAlbum=a},b.openTravelAlbum=function(){c.debug("open travel album"),b.travelAlbum.open()},b.closeTravelAlbum=function(){b.travelAlbum.close()},b.setRecommendAlbum=function(a){b.recommendAlbum=a},b.openRecommendAlbum=function(){c.debug("open recommend album"),b.recommendAlbum.open()},b.openPhoto=function(a){b.travel.activePhoto&&(b.travel.activePhoto.active=!1),a.active=!0,b.travel.activePhoto=a,b.closeTravelAlbum(),b.setPhotoId(a.id)},b.previous=function(){var a=0;if(b.travel.activePhoto&&(a=b.travel.activePhoto.sortCount-2)>=0){b.travel.activePhoto.active=!1;var c=b.travel.photos[a];c.active=!0,b.travel.activePhoto=c,b.setPhotoId(c.id)}else b.openTravelAlbum()},b.next=function(){var a=0;if(b.travel.activePhoto&&(a=b.travel.activePhoto.sortCount)<b.travel.photos.length){b.travel.activePhoto.active=!1;var c=b.travel.photos[a];c.active=!0,b.travel.activePhoto=c,b.setPhotoId(c.id)}else b.openRecommendAlbum()},b.setPhotoId(e),b.openMapPhoto=function(){var a=l.open({templateUrl:"views/mapPhoto.html",controller:"MapPhotoCtrl2",windowClass:"map-photo-modal",resolve:{photoId:function(){return b.photoId}}});a.result.then(function(a){b.selected=a},function(){c.info("Modal dismissed at: "+new Date)})},b.share=function(){}}]).directive("photoTravelAlbum",["$rootScope","$animate","$log",function(a,b){return{restrict:"A",link:function(a,c){var d=c.find(".travel-album-background"),e=c.find(".travel-album");d.on("click",function(){f.close()});var f={open:function(){b.addClass(d,"show"),b.addClass(e,"show")},close:function(){b.removeClass(d,"show"),b.removeClass(e,"show")}};a.setTravelAlbum(f)}}}]).directive("photoRecommendAlbum",["$rootScope","$animate","$log",function(a,b){return{restrict:"A",link:function(a,c){var d=c.find(".recommend-album-background"),e=c.find(".recommend-album");d.on("click",function(){f.close()});var f={open:function(){b.addClass(d,"show"),b.addClass(e,"show")},close:function(){b.removeClass(d,"show"),b.removeClass(e,"show")}};a.setRecommendAlbum(f)}}}]).controller("MapPhotoCtrl2",["$window","$log","$timeout","$scope","$modalInstance","PhotoService","GeocodeService","photoId",function(a,b,c,d,e,f,g,h){function i(){d.file&&d.file.mapVendor&&d.file.mapVendor.marker&&m.setMap(d.file.mapVendor.marker,null),d.file={photoId:d.photoId},f.getPhoto({photoId:d.photoId},function(a){"OK"==a.status&&(d.file.is360=a.prop.is360)}),f.getGPSInfo({photoId:d.photoId},function(a){"OK"==a.status&&(l(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng),m.setCenter(d.map,a.gps[0].gps.lat,a.gps[0].gps.lng),d.setPlace(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng,a.gps[0].gps.address))})}function j(a,b,c){if(a.mapVendor=a.mapVendor||{},b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=m.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,m.setMap(a.mapVendor.marker,d.map),m.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function k(a){m.addMapClickListener(a,function(a,b){l(d.file,a,b),d.setPlace(d.file,a,b)})}function l(a,b,c){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(m.setPosition(a.mapVendor.marker,b,c),m.setMap(a.mapVendor.marker,d.map)):(j(a,b,c),m.activeMarker(a.mapVendor.marker))}d.ctx=a.ctx,d.apirest=a.apirest,d.userId=a.userId;var m=a.cnmap.MapEventListener.factory(),n=a.cnmap.MapService.factory();d.mapEventListener=m,d.mapService=n,d.photoId=h,d.cancel=function(){e.dismiss("cancel")},d.ok=function(){f.updateProperties({photoId:d.photoId},{point:{lat:d.file.mapVendor.lat,lng:d.file.mapVendor.lng,address:d.file.mapVendor.address},vendor:"gaode",is360:d.file.is360},function(a){"OK"==a.status?(b.debug("properties update successful"),d.addAlert({type:"success",msg:"保存成功!"})):d.addAlert({type:"danger",msg:"保存失败 "+a.status})},function(a){d.addAlert({type:"danger",msg:"保存失败 "+(a.data&&a.data.status)})})},d.$watch("$$childTail.myMap",function(a){d.map=a,n.init(a),k(d.map),i()}),d.addOrUpdateMarker=l,d.setPlace=function(a,b,c,e){d.file.mapVendor=d.file.mapVendor||{},d.file.mapVendor.lat=b,d.file.mapVendor.lng=c,d.file.mapVendor.latPritty=cnmap.GPS.convert(b),d.file.mapVendor.lngPritty=cnmap.GPS.convert(c),e&&(d.file.mapVendor.address=e),n.getAddrPois(b,c,function(a,b){e||(d.file.mapVendor.address=b),d.file.mapVendor.addresses=a})},d.clearPlace=function(){};var o=null;d.addAlert=function(a){d.alerts=[],d.alerts.push(a),o&&c.cancel(o),o=c(function(){d.alerts=[]},3e3)},d.closeAlert=function(a){d.alerts&&d.alerts.splice(a,1)},d.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]),angular.module("userPageApp",["ui.bootstrap","ui.map","ponmApp","xeditable"]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("UserCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal",function(a,b,c,d,e,f,g){function h(a){a?e.getByTag({userId:d.userId,tag:a,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(a){"OK"==a.status&&(d.photos=a.photos)}):e.get({userId:d.userId,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(a){"OK"==a.status&&(d.photos=a.photos)})}function i(){f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info,d.editable=d.userOpenInfo.id==d.userId)})}function j(){f.getTravels({userId:d.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)})}function k(a){e.get({userId:d.userId,pageSize:a},function(a){if("OK"==a.status){var b=a.photo_info.photo_num;d.photo.totalItems=a.photo_info.photo_count,d.photo.currentPage=Math.ceil(b/d.photo.pageSize),d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),h()}})}function l(a){e.getByTag({userId:d.userId,tag:a},function(b){"OK"==b.status&&(d.photo.totalItems=b.photo_info.photo_count||0,d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),h(a))})}function m(){f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info,d.photo.totalItems=a.open_info.photo_count||0,d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),h())}),j()}d.ctx=a.ctx,d.apirest=a.apirest,d.photo={pageSize:40,totalItems:0,numPages:0,currentPage:1,maxSize:10},d.photos=[],d.tag="",d.editable=!1,d.$watch("photo.currentPage",function(){h(d.tag)});var n=b.search();n&&(n.id&&n.id!=d.userId&&(d.userId=n.id),n.with_photo_id?(k(n.with_photo_id),i()):n.tag?(d.tag=n.tag,l(n.tag),i()):m()),d.$watch(function(){return b.search()},function(a){a&&(a.id&&a.id!=d.userId&&(d.userId=a.id),a.with_photo_id?k(a.with_photo_id):a.tag?(d.tag=a.tag,l(a.tag)):m())}),d.$watch("photos",function(){angular.forEach(d.photos,function(a){a.backgroundColor="grey"})}),d.activePhoto=function(a){var b=g.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a.id},travelId:function(){return""}}});b.result.then(function(a){d.selected=a},function(){})},d.mapOptions={toolbar:!0,scrollzoom:!1,maptype:"SATELLITE",resizeEnable:!0,level:3,uiMapCache:!1},"qq"==a.mapVendor&&(a.mapVendor="gaode");var o=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});o.initEnv(a.ctx),o.setUserId(d.userId),d.$watch("minimap",function(){if(!d.map){d.map=d.minimap;var a=d.minimap;o.setMap(a)}})}]),angular.module("userSettingsApp",["ngResource","ui.bootstrap","ponmApp"]).controller("UserSettingsCtrl",["$window","$log","$location","$rootScope","$scope","$modal","UserPhoto","UserService",function(a,b,c,d,e,f,g,h){function i(){h.getSettings({userId:e.userId},function(a){"OK"==a.status&&(e.settings=a.settings)})}e.ctx=a.ctx,e.apirest=a.apirest,e.avatar=e.userId=a.userId,e.changeAvatar=function(){e.avatar=1;var a=f.open({templateUrl:"views/changeUserAvatar.html",controller:"ChUserAvatarCtrl",resolve:{}});a.result.then(function(){e.avatar=e.userId},function(){e.avatar=e.userId,b.info("Modal dismissed at: "+new Date)})},i(),e.submit=function(){h.updateSettings({userId:e.userId},e.settings,function(a){e.addAlert("OK"==a.status?{type:"success",msg:"保存成功!"}:{type:"danger",msg:"保存失败!"})},function(){e.addAlert({type:"danger",msg:"保存失败!"})})},e.addAlert=function(a){e.alerts=[],e.alerts.push(a)
},e.closeAlert=function(a){e.alerts&&e.alerts.splice(a,1)}}]),function(){angular.module("fileuploadApp",["ngResource","ui.bootstrap","blueimp.fileupload","ui.map","ponmApp"]).config(["$httpProvider","fileUploadProvider","$logProvider",function(a,b){delete a.defaults.headers.common["X-Requested-With"],b.defaults.redirect=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s"),angular.extend(b.defaults,{autoUpload:!0,maxFileSize:6e6})}]).controller("DemoFileUploadController",["$window","$scope","$http","fileUpload","$modal","$log","PhotoService","GPSConvertService","LoginUserService","UserService","TravelService","GeocodeService",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){a.photoId=b.id,a.is360=b.is360,b.point&&(a.lat=b.point.lat,a.lng=b.point.lng,a.vendor=b.vendor,a.latPritty=cnmap.GPS.convert(a.lat),a.lngPritty=cnmap.GPS.convert(a.lng),n.getAddress(a.lat,a.lng,function(b){a.address=b,a.saveProperties&&a.saveProperties()}))}function m(){if(b.travel){var a=[];angular.forEach(b.queue,function(b){b.photoId&&a.push(b.photoId)}),a.length&&k.addPhoto({travelId:b.travel.id},jQuery.param({photos:a.join(",")}),function(a){"OK"==a.status})}}b.apirest=a.apirest,b.ctx=a.ctx,b.userId=a.userId;var n=new a.cnmap.MapService;b.options={formData:function(){var a=this.files[0].lat||0,b=this.files[0].lng||0,c=this.files[0].address||"",d=this.files[0].vendor||"gps";return[{name:"lat",value:a},{name:"lng",value:b},{name:"address",value:c},{name:"vendor",value:d}]},done:function(a,b){if("OK"==b.result.status){var c=b.result.prop;b.files[0].$submit=!1,b.files[0].$cancel=!1,b.files[0].$endestroy=!0,l(b.files[0],c),b.files[0].saveProperties(),b.files[0].saveTags(),m()}else"NO_AUTHORIZE"==b.result.status?(b.files[0].error="请重新登录",b.files[0].$endestroy=!1):(b.files[0].error=b.result.info,b.files[0].$endestroy=!1)},fail:function(a,b){b.result?("NO_AUTHORIZE"==b.result.status&&(b.files[0].error="请重新登录"),b.files[0].$cancel=function(){b.files[0].$destroy()}):d.defaults.fail(a,b)}},d.defaults.autoUpload||(b.options.add=function(a,b){if(a.isDefaultPrevented())return!1;d.defaults.add(a,b);var c=b.files[0];loadImage.parseMetaData(c,function(a){if(a.exif){var b=a.exif.getText("GPSLatitude");if(b&&"undefined"!=b){c.lat=cnmap.GPS.convert(b);var d=a.exif.getText("GPSLatitudeRef");c.latRef=d}var e=a.exif.getText("GPSLongitude");if(e&&"undefined"!=e){c.lng=cnmap.GPS.convert(e);var f=a.exif.getText("GPSLongitudeRef");c.lngRef=f}c.latPritty=cnmap.GPS.convert(c.lat),c.lngPritty=cnmap.GPS.convert(c.lng),(c.lng||c.lat)&&h.convert({lat:c.lat,lng:c.lng},function(a){c.lat=a.lat,c.lng=a.lng,c.vendor="gaode",c.latPritty=cnmap.GPS.convert(c.lat),c.lngPritty=cnmap.GPS.convert(c.lng),n.getAddress(c.lat,c.lng,function(a){c.address=a})})}})}),b.changeLocation=function(a){var b=e.open({templateUrl:"views/changeLocationModal.html",controller:"ChLocModalCtrl",windowClass:"map-photo-modal",resolve:{files:function(){return a}}});b.result.then(function(a){angular.forEach(a,function(a){a.saveProperties()})},function(){f.info("Modal dismissed at: "+new Date)})},b.loadTravelData=function(a){var b=j.getTravels({userId:i.getUserId()},function(b){"OK"==b.status&&a&&a.apply(void 0,[b.open_info.travels])});f.debug(b)},b.newTravelData=function(a,b){return f.debug("new data: "+a),k.create({},jQuery.param({travel:a}),function(a){"OK"==a.status&&b&&b.apply(void 0,[a.travels])}),!1},b.loadTagData=function(a){return f.debug("load tags data"),j.getTags({userId:i.getUserId()},function(b){"OK"==b.status&&a&&a.apply(void 0,[b.open_info.tags])}),!0},b.newTagData=function(a,b){return f.debug("new data: "+a),j.createTag({userId:i.getUserId(),value:a},function(a){"OK"==a.status&&b&&b.apply(void 0,[a.open_info.tags])}),!1},b.$watch("travel",function(){m()}),b.$watch("tags",function(){angular.forEach(b.queue,function(a){a.photoId&&a.saveTags()})}),b.$watch("photoMap",function(a){n.init(a)})}]).controller("FileDestroyController",["$scope","$http","PhotoService",function(a,b,c){var d,e=a.file;e.$state=function(){return d},e.$destroy=function(){e.photoId&&(d="pending",c.delete({photoId:e.photoId},function(a){d=a?"resolved":"rejected"})),a.clear(e)},e.$cancel||e._index||(e.$cancel=function(){a.clear(e)})}]).controller("TitleEditorCtrl",["$scope","$http","PhotoService","$log",function(a,b,c,d){var e=a.file;e.saveProperties=function(){if(this.photoId){var a=this;c.updateProperties({photoId:a.photoId},{title:a.title,description:a.description,point:{lat:a.lat,lng:a.lng,address:a.address},vendor:a.vendor,file_size:a.size,is360:a.is360},function(a){a&&d.debug("properties update successful")})}},e.saveTags=function(){var b=this;if(b.photoId&&b.tags){var e=[];e=e.concat(b.tags||[]).concat(a.tags||[]),e.length&&c.tag({photoId:b.photoId},e,function(a){a&&d.debug("tags update successful")})}},a.$watch("title",function(){a.file.title=a.title,e.saveProperties()}),a.$watch("description",function(){a.file.description=a.description,e.saveProperties()}),a.$watch("file.tags",function(){e.saveTags()})}])}();