"use strict";angular.module("aTravelApp",["ponmApp","ui.map","ui.bootstrap","xeditable"]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("ATravelCtrl",["$window","$scope","$log","$http","$location","TravelService","UserService","$modal","$q","param","ponmCtxConfig",function(a,b,c,d,e,f,g,h,i,j,k){function l(){e.search(j(p))}function m(a){f.getTravel({travelId:a},function(a){"OK"==a.status&&(b.setTravel(a.travel),b.travel.spots[0]&&b.activeSpot(b.travel.spots[0]),g.getOpenInfo({userId:b.travel.user_id},function(a){"OK"==a.status&&(b.userOpenInfo=a.open_info)}))})}b.ctx=a.ctx,b.staticCtx=k.staticCtx,b.apirest=a.apirest,b.userId=a.userId;var n=a.cnmap.MapEventListener.factory();b.mapEventListener=n,b.mapService=a.cnmap.MapService.factory();var o=new a.cnmap.TravelLayer({ctx:b.ctx,staticCtx:k.staticCtx,travel:b.travel,clickable:!0});b.travelLayer=o,jQuery(o).bind("data_clicked",function(a,c){b.displayPhoto(c)});var p={};b.$watch(function(){return e.search()},function(a){a.id&&a.id!=p.id&&(p.id=a.id,a.id!=b.travelId&&(b.travelId=a.id,m(a.id))),a.photoid&&a.photoid!=p.photoid&&(p.photoid=a.photoid,b.displayPhoto(a.photoid))}),b.activePhoto=function(a){b.photo&&b.photo.id==a.id?b.displayPhoto(a.id):(b.photo=a,o.activePhoto(a))},b.activeSpot=function(a){var c=0;return c=angular.isObject(a)?a.id:a,b.activedSpot&&b.activedSpot.id==c?void o.activeSpot(a):(angular.forEach(b.travel.spots,function(a){a.id==c?(a.active=!0,b.activedSpot=a):a.active=!1}),void o.activeSpot(a))},b.setTravel=function(a){b.travel=a,b.travelEnedit=b.userId==b.travel.user_id,angular.isArray(b.travel.spots)||(b.travel.spots=[]),b.travel.spot&&b.travel.spots.push(b.travel.spot),angular.forEach(b.travel.spots,function(a){a.addresses={},angular.forEach(a.photos,function(b){b.point.address&&(a.addresses[b.point.address]=b.point)})}),o.clearMap(),o.setTravel(b.travel),o.initMap()},b.updateTravel=function(a,b){var c=i.defer();return f.changeTravel({travelId:a.id},j({description:b}),function(a){a=a||{},"OK"===a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.showSpotAddress=function(a){return a.address||"添加地址"},b.$on("photoDeleteEvent",function(a,d){c.debug("photo delete event: photoId = "+d),a.preventDefault(),a.stopPropagation(),f.deletePhoto({travelId:b.travel.id,typeId:d},function(a){"OK"==a.status&&(angular.forEach(b.travel.spots,function(a,c){angular.forEach(a.photos,function(b,c){b.id==d&&delete a.photos.splice(c,1)}),a.photos.length||delete b.travel.spots.splice(c,1)}),b.$broadcast("ponmPhotoFluidResize"))})}),b.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0,scaleControl:!0},b.$watch("myMap",function(){var a=b.myMap;b.mapService.init(a),n.addToolBar(a),o.setMap(a)}),b.$on("waypointEvent",function(){}),b.displayPhoto=function(a){p.photoid=a,l();var c=h.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return b.travel&&b.travel.id||""}}});c.result.then(function(){delete p.photoid,l(),m(b.travelId)},function(){delete p.photoid,l(),m(b.travelId)})},b.dateOptions={formatYear:"yy",startingDay:1};var q=new Date;b.datepickerDisabled=function(a,b){return"day"===b&&a>q}}]).controller("spotCtrl",["$scope","$log","$filter","$q","TravelService","param",function(a,b,c,d,e,f){a.$watch("spot.timeStart",function(b){if(b){var d=a.updateSpot(a.spot,"time_start",c("date")(b,"yyyy/MM/dd"));d.then(function(){a.spot.time_start=b,a.travelLayer.calcSpotTime()},function(){})}}),a.updateSpot=function(a,b,c){var g=d.defer(),h={title:a.title,description:a.description,address:a.address};return h[b]=c,e.changeSpot({travelId:a.travel_id,typeId:a.id},f(h),function(a){a=a||{},"OK"===a.status?g.resolve():g.resolve(a.info)},function(a){g.reject(a.data?a.data.info:"Server error!")}),g.promise},a.createSpot=function(b){e.createSpot({travelId:a.spot.travel_id},f({}),function(c){"OK"==c.status&&a.addSpotPhoto(b,c.spot)})},a.addSpotPhoto=function(b,c){var d={photos:b.id};e.addSpotPhoto({travelId:c.travel_id,typeId:c.id},f(d),function(b){"OK"==b.status&&a.setTravel(b.travel)})},a.removePhoto=function(b){a.$emit("photoDeleteEvent",b.id)},a.deleteSpot=function(b){e.deleteSpot({travelId:b.travel_id,typeId:b.id},function(b){"OK"==b.status&&a.setTravel(b.travel)})}}]),angular.module("ponmApp.controllers").controller("ChLocModalCtrl",["$window","$scope","$log","$modalInstance","files","GPSConvertService","GeocodeService",function(a,b,c,d,e){function f(a,c,d){if(a.mapVendor=a.mapVendor||{},c&&d)a.mapVendor.lat=c,a.mapVendor.lng=d;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=i.createDraggableMarker(b.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,i.setMap(a.mapVendor.marker,b.map),i.addMarkerActiveListener(a.mapVendor.marker,function(){b.activePhoto(this.photo_file)}),i.addDragendListener(a.mapVendor.marker,function(a,c){b.setPlace(this.photo_file,a,c)})}function g(a){i.addMapClickListener(a,function(a,c){h(b.file,a,c),b.setPlace(b.file,a,c)})}function h(a,c,d){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(i.setPosition(a.mapVendor.marker,c,d),i.setMap(a.mapVendor.marker,b.map)):(f(a,c,d),i.activeMarker(a.mapVendor.marker))}var i=a.cnmap.MapEventListener.factory(),j=a.cnmap.MapService.factory();b.mapEventListener=i,b.mapService=j,angular.forEach(e,function(a){if(a.active=!1,delete a.mapVendor,!a.modal&&a.preview){var b=cnmap.cloneCanvas(a.preview);a.modal={preview:b}}a.mapVendor=a.mapVendor||{},a.mapVendor.is360=a.is360}),angular.forEach(e,function(a){!a.loc_preview&&loadImage&&loadImage(a,function(b){a.loc_preview=a.loc_preview||{},jQuery(b).removeAttr("width").removeAttr("height"),a.loc_preview.preview=b},{maxWidth:600,maxHeight:300,minWidth:100,minHeight:50,canvas:!1})}),b.files=e,b.file=b.files[0],b.ok=function(){var a=[];angular.forEach(e,function(b){b.mapVendor&&(b.address=b.mapVendor.address||b.address,b.is360=b.mapVendor.is360,b.lat=b.mapVendor.lat,b.lng=b.mapVendor.lng,b.latPritty=b.mapVendor.latPritty||b.latPritty,b.lngPritty=b.mapVendor.lngPritty||b.lngPritty,b.vendor="gaode",a.push(b))}),d.close(a)},b.cancel=function(){d.dismiss("cancel")},b.$watch("$$childTail",function(){b.$$childTail&&b.$$childTail.$watch("myMap",function(){b.$$childTail.myMap&&(b.map=b.$$childTail.myMap,angular.forEach(e,function(a){f(a)}),j.init(b.map),g(b.map),b.activePhoto(b.file))})}),b.addOrUpdateMarker=h,b.setPlace=function(a,c,d,e){b.file.mapVendor=b.file.mapVendor||{},b.file.mapVendor.lat=c,b.file.mapVendor.lng=d,b.file.mapVendor.latPritty=cnmap.GPS.convert(c),b.file.mapVendor.lngPritty=cnmap.GPS.convert(d),e&&(b.file.mapVendor.address=e),j.getAddrPois(c,d,function(a,c){e||(b.file.mapVendor.address=c),b.file.mapVendor.addresses=a})},b.clearPlace=function(){},b.activePhoto=function(a){b.file.active=!1,b.file.mapVendor&&i.deactiveMarker(b.file.mapVendor.marker),b.file=a,b.file.active=!0,b.file.mapVendor&&(b.file.mapVendor.lat?(i.activeMarker(b.file.mapVendor.marker),i.inMapView(b.file.mapVendor.lat,b.file.mapVendor.lng,b.map)||i.setCenter(b.map,b.file.mapVendor.lat,b.file.mapVendor.lng),b.setPlace(b.file,b.file.mapVendor.lat,b.file.mapVendor.lng)):b.clearPlace())},b.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]).controller("TypeaheadCtrl",["$scope","$http","GeocodeService","$q",function(a,b,c,d){a.selected=void 0,a.states=[],a.getLocation=function(b){var c=d.defer();return a.mapService.getLocPois(b,function(a){c.resolve(a)}),c.promise.then(function(a){return a})},a.goLocation=function(b){var c=b.location;c&&(a.mapEventListener.setCenter(a.map,c.lat,c.lng),a.mapEventListener.setZoom(a.map,b.zoom))}}]),angular.module("ponmApp.controllers").controller("ChUserAvatarCtrl",["$window","$scope","$log","$sce","$http","$modalInstance",function(a,b,c,d,e,f){var g=a.apirest+"/user/avatar";b.cancel=function(){f.dismiss(b.avatar)};var h=a.URL&&a.URL.createObjectURL.bind(a.URL)||a.webkitURL&&a.webkitURL.createObjectURL.bind(a.webkitURL)||a.createObjectURL;b.fileUpload=function(){if(b.closeAlert(0),b.$$childTail.$$childTail.previewUrl){var a=Math.random().toString().substr(2),c="";c+="--"+a+'\r\nContent-Disposition: form-data; name="file"; filename="avatar.png"\r\nContent-type: application/octet-stream\r\n\r\n'+b.$$childTail.$$childTail.previewUrl+"\r\n",c+="--"+a+"--\r\n",e({method:"POST",url:g,data:c,headers:{"Content-Type":"multipart/form-data; charset=utf-8; boundary="+a}}).success(function(a){"OK"==a.status?(b.avatar=a.open_info.avatar,b.addAlert({type:"success",msg:"上传成功!"})):b.addAlert({type:"danger",msg:"上传失败!"})})}},b.onFileSelect=function(a){b.closeAlert(0);var c=d.trustAsResourceUrl(h(a[0]));b.imageUrl=c},b.addAlert=function(a){b.alerts=[],b.alerts.push(a)},b.closeAlert=function(a){b.alerts&&b.alerts.splice(a,1)}}]).directive("imgCropped",function(){return{restrict:"E",replace:!0,scope:{src:"@",bind:"=previewUrl"},link:function(a,b){function c(b){var c=d[0],f=c.width,g=c.height,h=$(c).width(),i=$(c).height(),j=b.x*f/h,k=b.y*g/i,l=b.w*f/h,m=b.h*g/i,n=document.createElement("canvas");n.width=100,n.height=100;var o=n.getContext("2d");o.drawImage(c,j,k,l,m,0,0,100,100),a.$apply(function(){a.previewUrl=n.toDataURL("image/png"),e.attr("src",a.previewUrl)})}var d,e,f=800,g=420,h=function(){d&&(d.next().remove(),d.remove(),d=void 0),e&&(e.next().remove(),e.remove(),e=void 0)};a.$watch("src",function(a){h(),a&&(b.after("<img />"),d=b.next(),d.attr("src",a),$(d).Jcrop({trackDocument:!0,bgFade:!0,boxWidth:f,boxHeight:g,minSize:[16,16],onSelect:c,aspectRatio:1}),d.after("<img />"),e=d.next())}),a.$on("$destroy",h)}}}).directive("ngFileSelect",["$parse","$timeout",function(a,b){return function(c,d,e){var f=a(e.ngFileSelect);d.bind("change",function(a){var d,e,g=[];if(d=a.target.files,null!=d)for(e=0;e<d.length;e++)g.push(d.item(e));b(function(){f(c,{$files:g,$event:a})})}),d.bind("click",function(){this.value=null})}}]),angular.module("exploreWorldApp",["ponmApp","ui.map","ui.bootstrap"]).controller("ExploreWorldCtrl",["$window","$location","$scope","UserService","$modal","deparam","param","$timeout","ponmCtxConfig",function(a,b,c,d,e,f,g,h,i){function j(){c.photoEnd=c.slice+o<=c.allPhotos.length?!1:!0,c.photoStart=c.slice>=o?!1:!0}function k(a){n.addLocationHashListener(a,function(a,b,c){l(a,b,c)}),c.$watch(function(){return b.hash()},function(b){if(!r){var d=f(b);if(m(d,"photoid"),m(d,"zoom"),m(d,"lat"),m(d,"lng"),d.lat&&d.lng&&(q.lat!=d.lat||q.lng!=d.lng||q.zoom!=d.zoom)&&(c.setState&&h.cancel(c.setState),r=!0,n.setCenter(a,d.lat,d.lng),d.zoom&&n.setZoom(a,d.zoom),c.setState=h(function(){r=!1},500),d.bounds)){var e=d.bounds.split(",");4==e.lenght&&n.setBounds(a,{lat:e[0],lng:e[1]},{lat:e[2],lng:e[3]})}angular.copy(d,q),d.latest?c.setPanormaioType("latest"):d.userid&&(d.favorite?c.setPanormaioType("favorite",d.userid):c.setPanormaioType("user",d.userid)),d.photoid&&c.displayPhoto(d.photoid)}})}function l(a,d,e){if(!r){var i=f(b.hash());m(i,"photoid"),a&&d&&e&&(q.lat=a,q.lng=d,q.zoom=e),(q.lat!=i.lat||q.lng!=i.lng||q.zoom!=i.zoom||q.latest!=i.latest||q.userid!=i.userid||q.favorite!=i.favorite||q.photoid!=i.photoid)&&(c.setState&&h.cancel(c.setState),r=!0,b.hash(g(q)),c.setState=h(function(){r=!1},500))}}function m(a,b){if(a[b]){var c=a[b].split("#");a[b]=c[0]}}c.ctx=a.ctx,c.staticCtx=i.staticCtx,c.apirest=a.apirest,c.login=a.login,c.userId=a.userId;var n=a.cnmap.MapEventListener.factory();c.mapEventListener=n,c.mapService=a.cnmap.MapService.factory(),c.user={},c.login&&c.userId&&(c.user={id:c.userId,name:"您"}),c.tabs={map:!0},c.photos=[],c.allPhotos=[],c.slice=0,c.photoStart=!0,c.photoEnd=!0,c.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0,scaleControl:!0};var o=20;"qq"==a.mapVendor&&(a.mapVendor="gaode");var p=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});p.initEnv(a.ctx,c.staticCtx),$(p).bind("data_changed",function(a,b){c.$apply(function(){var a=jQuery("div#thumbinnerarea"),d=a.innerWidth(),e=a.innerHeight(),f=Math.floor((d-40)/116);o=f*Math.floor((e-50)/116),c.updatePhoto(b)})}),jQuery(p).bind("data_clicked",function(a,b){c.displayPhoto(b)}),c.setPanormaioType=function(a,b){switch(c.tabs={},c.tabs[a]=!0,b&&(c.user.id=b,c.login&&b==c.userId?c.user.name="您":d.getOpenInfo({userId:b},function(a){"OK"==a.status&&(c.user.name=a.open_info&&a.open_info.name)})),p.setFavorite(!1),p.setUserId(""),p.setLatest(!1),delete q.userid,delete q.latest,delete q.favorite,a){case"user":p.setFavorite(!1),p.setUserId(c.user.id),q.userid=c.user.id;break;case"map":p.setUserId(void 0);break;case"latest":p.setLatest(!0),q.latest=!0;break;case"favorite":p.setFavorite(!0),q.favorite=!0,p.setUserId(c.user.id),q.userid=c.user.id}p.trigger("changed")},c.updatePhoto=function(a){c.allPhotos=a,c.photos=a.slice(0,o),c.slice=0,j()},c.nextPhoto=function(){c.slice<=c.allPhotos.length&&(c.slice=c.slice+o,c.photos=c.allPhotos.slice(c.slice,c.slice+o),j())},c.prePhoto=function(){c.slice>=o&&(c.slice=c.slice-o,c.photos=c.allPhotos.slice(c.slice,c.slice+o),j())},c.$watch("myMap",function(){if(!c.map){c.map=c.myMap;var a=c.myMap;p.setMap(a),k(a),n.addToolBar(a),c.mapService.init(c.map)}});var q={},r=!1;c.displayPhoto=function(a){q.photoid=a,l();var b=e.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}});b.result.then(function(){delete q.photoid,l()},function(){delete q.photoid,l()})}}]),angular.module("map.AMap",["ngRoute","ngResource","ui.bootstrap"]).controller("TypeaheadCtrl",["$scope","$log","$http",function(a,b,c){a.getLocation=function(a){return c.get("http://restapi.amap.com/v3/geocode/geo",{params:{key:"53f7e239ddb8ea62ba552742a233ed1f",address:a}}).then(function(a){var c=[];return angular.forEach(a.data.geocodes,function(a){b.debug(a),c.push(a)}),c})},a.update=function(a){var c=a.location;c&&(c=c.split(","),b.debug(c))}}]),angular.module("indexApp",["ponmApp","ui.map"]).controller("IndexCtrl",["$window","$scope",function(a,b){function c(a){$(".front-photo_sizer img").attr("src",ctx+"/api/rest/photo/"+a.id+"/1"),$(".front-photo_sizer a").attr("href",ctx+"/photo/"+a.id),d.setCenter(b.map,a.lat,a.lng),a.mark||(a.mark=!0,d.createDraggableMarker(b.map,a.lat,a.lng)),$("div.imgLiquidFill").imgLiquid({fill:!0}),e.length>1&&setTimeout(function(){c(e[f]),f=(f+1)%e.length},4e3)}var d=a.cnmap.MapEventListener.factory();b.mapOptions={resizeEnable:!0,panControl:!1,zoomControl:!1,uiMapCache:!1},$("div.imgLiquidFill").imgLiquid({fill:!0});var e,f,g=new $.RestClient(window.ctx+"/api/rest/");g.add("index"),g.index.read("photo").done(function(a){e=a,f=0,e.length&&(c(e[f]),f=(f+1)%e.length)})}]),angular.module("ponmApp.login",["ponmApp"]).controller("LoginCtrl",["$window","$scope","$log","$q","param","$location","$cookieStore",function(a,b,c,d,f,g){b.ctx=a.ctx,b.credentials={},b.login=function(a){b.credentials.username||(a.preventDefault(),a.stopPropagation(),b.userForm.j_username.$dirty=!0),b.credentials.password||(a.preventDefault(),a.stopPropagation(),b.userForm.j_password.$dirty=!0)},b.passwordHint=function(){b.credentials.username?g.$$absUrl=ctx+"/passwordHint?username="+b.credentials.username:(alert("用户名 为必填项。"),e.preventDefault(),e.stopPropagation())}}]),angular.module("mapPhotoApp",["ponmApp","ui.bootstrap","ui.map"]).controller("MapPhotoCtrl",["$window","$location","$log","$scope","PhotoService",function(a,b,c,d,e){function f(){d.file&&d.file.mapVendor&&d.file.mapVendor.marker&&j.setMap(d.file.mapVendor.marker,null),d.file={photoId:d.photoId},e.getPhoto({photoId:d.photoId},function(a){"OK"==a.status&&(d.file.is360=a.prop.is360)}),e.getGPSInfo({photoId:d.photoId},function(a){"OK"==a.status&&(i(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng),j.setCenter(d.map,a.gps[0].gps.lat,a.gps[0].gps.lng),d.setPlace(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng,a.gps[0].gps.address))})}function g(a,b,c){if(a.mapVendor=a.mapVendor||{},b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=j.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,j.setMap(a.mapVendor.marker,d.map),j.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function h(a){j.addMapClickListener(a,function(a,b){i(d.file,a,b),d.setPlace(d.file,a,b)})}function i(a,b,c){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(j.setPosition(a.mapVendor.marker,b,c),j.setMap(a.mapVendor.marker,d.map)):(g(a,b,c),j.activeMarker(a.mapVendor.marker))}d.ctx=a.ctx,d.apirest=a.apirest;var j=a.cnmap.MapEventListener.factory(),k=a.cnmap.MapService.factory();d.mapEventListener=j,d.mapService=k,d.$watch(function(){return b.hash()},function(a){var b=jQuery.deparam(a);b&&b.id&&(d.photoId=b.id,f(d.photoId))}),d.ok=function(){e.updateProperties({photoId:d.photoId},{point:{lat:d.file.mapVendor.lat,lng:d.file.mapVendor.lng,address:d.file.mapVendor.address},vendor:"gaode",is360:d.file.is360},function(a){"OK"==a.status?(c.debug("properties update successful"),d.addAlert({type:"success",msg:"保存成功!"})):d.addAlert({type:"danger",msg:"保存失败 "+a.status})})},d.cancel=function(){a.history.back()},d.$watch("myMap",function(a){d.map=a,k.init(a),h(d.map),f()}),d.addOrUpdateMarker=i,d.setPlace=function(a,b,c,e){d.file.mapVendor=d.file.mapVendor||{},d.file.mapVendor.lat=b,d.file.mapVendor.lng=c,d.file.mapVendor.latPritty=cnmap.GPS.convert(b),d.file.mapVendor.lngPritty=cnmap.GPS.convert(c),e?d.file.mapVendor.address=e:k.getAddress(b,c,function(a){d.$apply(function(){d.file.mapVendor.address=a})})},d.clearPlace=function(){},d.addAlert=function(a){d.alerts=[],d.alerts.push(a)},d.closeAlert=function(a){d.alerts&&d.alerts.splice(a,1)},d.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]).controller("TypeaheadCtrl",["$scope","$http",function(a,b){a.selected=void 0,a.states=[],a.getLocation=function(a){return b.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},a.goLocation=function(b){var c=b.geometry;c&&(a.mapEventListener.setCenter(a.map,c.location.lat,c.location.lng),a.addOrUpdateMarker(a.file,c.location.lat,c.location.lng),a.setPlace(a.file,c.location.lat,c.location.lng,b.formatted_address),a.mapEventListener.setBounds(a.map,c.viewport.southwest,c.viewport.northeast))}}]),angular.module("mapsApp",["ui.bootstrap","ui.map","ui.router","ponmApp","xeditable","fileuploadApp"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/","/popular").otherwise("/popular"),a.state("maps",{"abstract":!0,url:"",views:{"":{templateUrl:"views/maps.html",controller:"MapsCtrl"},"alerts@maps":{templateUrl:"views/photos.alerts.html",controller:"PhotosAlertsCtrl"}},resolve:{}}).state("maps.popular",{url:"/popular",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsPopularCtrl"}).state("maps.recent",{url:"/recent",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsRecentCtrl"}).state("maps.travel",{url:"/travel/:travelId",templateUrl:"views/maps.travel.html",resolve:{},controller:"MapsTravelCtrl"}).state("maps.photo",{url:"/photo",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsRecentCtrl"}).state("maps.camera",{url:"/camera",templateUrl:"views/maps.popular.html",resolve:{},controller:"MapsRecentCtrl"}).state("maps.user",{url:"/user/:userId",templateUrl:"views/maps.user.html",resolve:{},controller:"MapsUserCtrl"}).state("maps.travels",{url:"/travels",templateUrl:"views/maps.travels.html",resolve:{},controller:"MapsTravelsCtrl"}).state("maps.upload",{url:"/upload",templateUrl:"views/upload.html",resolve:{},controller:"MapsPhotoUploadCtrl"})}]).run(["$rootScope","$window","editableOptions",function(a,b,c){c.theme="bs3",a.user={id:b.userId}}]).controller("MapsCtrl",["$window","$location","$rootScope","$scope","$q","PhotoService","UserService","PanoramioService","$modal","ponmCtxConfig","$log","$state","$stateParams","$timeout","safeApply","jsUtils","HashStateManager",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a){d.mapEventListener.addLocationHashListener(a,function(a,b,c){k.debug("locationHashListener"),t||(d.setState&&n.cancel(d.setState),t=!0,d.hashStateManager.set({lat:a,lng:b,zoom:c}),d.setState=n(function(){t=!1},500))}),d.hashStateManager.bindingWatch("lat lng zoom bounds",function(b,c,e,f){if(k.debug("watch lat lng zoom"),d.setState&&n.cancel(d.setState),t=!0,e&&b&&c?(k.debug("setZoomAndCenter"),d.mapEventListener.setZoomAndCenter(a,e,b,c)):(b&&c&&(k.debug("setCenter"),d.mapEventListener.setCenter(a,b,c)),e&&(k.debug("setZoom"),d.mapEventListener.setZoom(a,e))),d.setState=n(function(){t=!1},500),f){var g=f.split(",");4==g.lenght&&d.mapEventListener.setBounds(a,{lat:g[0],lng:g[1]},{lat:g[2],lng:g[3]})}})}d.ctx=a.ctx,d.staticCtx=j.staticCtx,d.apirest=a.apirest,d.userId=j.userId,d.login=!!j.userId,d.$state=l,d.$location=b,d.$stateParams=m,d.editableView=!0,d.$watch("editableView",function(a){d.$broadcast("editableViewChanged",a)}),d.changeEditableView=function(){d.editableView=!d.editableView,d.$broadcast("editableViewChanged",d.editableView)},d.navbarFixedTop=!1,d.hashStateManager=new q(d,b),k.debug(l),d.stateStatus={popular:"/popular"==l.current.url,recent:"/recent"==l.current.url,travel:"maps.travel"==l.current.name,upload:"maps.upload"==l.current.name,camera:"/camera"==l.current.url,user:"maps.user"==l.current.name,travels:"/travels"==l.current.url},c.$on("$stateChangeSuccess",function(a,b){d.stateStatus={popular:"/popular"==b.url,recent:"/recent"==b.url,travel:"maps.travel"==b.name,upload:"maps.upload"==b.name,camera:"/camera"==b.url,user:"maps.user"==b.name,travels:"/travels"==b.url},d.clearSearch()}),d.contentLayouts=["right-fixed","left-fixed","right-full","left-full"],d.contentLayout=0,d.changeContentLayout=function(){d.contentLayout=(d.contentLayout+1)%4},d.user={login:!!j.userId,id:j.userId},j.userId&&(d.user.name="您"),d.mapOptions={scrollzoom:!0,maptype:!0,overview:!0,rotateEnable:!0,resizeEnable:!0,scaleControl:!0},d.mapEventListener=a.cnmap.MapEventListener.factory(),d.mapService=a.cnmap.MapService.factory();var s=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});d.panoramioLayer=s,s.initEnv(a.ctx,d.staticCtx),$(s).bind("data_changed",function(a,b){d.stateStatus.user||d.$apply(function(){d.photos=p.Array.mergeRightist(d.photos||[],b,"id"),d.$broadcast("ponmPhotoFluidResize",{})})}),d.$watch("myMap",function(a){!d.map&&a&&(d.map=a,d.$broadcast("mapChanged",a))}),d.$on("mapChanged",function(a,b){s.setMap(b),d.mapEventListener.addToolBar(b),d.mapService.init(b),r(b)}),d.displayPhoto=function(a){d.hashStateManager.set("photoid",a);var b=i.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}});b.result.then(function(){d.hashStateManager.set("photoid","")},function(){d.hashStateManager.set("photoid","")})},d.setPanormaioType=function(a,b){switch(d.tabs={},d.tabs[a]=!0,b&&(d.user.id=b,d.login&&b==d.userId?d.user.name="您":g.getOpenInfo({userId:b},function(a){"OK"==a.status&&(d.user.name=a.open_info&&a.open_info.name)})),s.setFavorite(!1),s.setUserId(""),s.setLatest(!1),s.setAuto(!0),a){case"user":s.setFavorite(!1),s.setUserId(d.user.id);break;case"popular":s.setUserId(void 0);break;case"recent":s.setLatest(!0);break;case"favorite":s.setFavorite(!0),s.setUserId(d.user.id);break;case"manual":s.setAuto(!1),s.clearMap();break;case"auto":s.setAuto(!0)}s.trigger("changed")};var t=!1;d.hashStateManager.watch("photoid",function(a){a&&d.displayPhoto(a)}),d.search=function(a,b){var c=e.defer(),f=s.getBounds(),g=s.getLevel(),i=s.getSize();return h.search({swlat:f.sw.lat,swlng:f.sw.lng,nelat:f.ne.lat,nelng:f.ne.lng,level:g,width:i.width,height:i.height,type:b||"",term:a},function(a){"OK"==a.status&&(d.photos=a.photos,s.createPhotosMarker(d.photos),k.debug("search res size: "+d.photos.length),c.resolve(a.photos))}),c.promise},d.setSearch=function(a){d.setPanormaioType(a?"manual":"auto"),d.searchValObject={val:a},d.hashStateManager.set("search",a),d.$broadcast("searchChanged",a)},d.clearSearch=function(){s.setAuto(!0),d.searchValObject="",d.hashStateManager.set("search","")},d.loadMoreDisabled=!0}]).controller("PhotosAlertsCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(){}]).controller("MapsSearchCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","$q",function(a,b,c,d,e,f,g,h,i,j,k,l){d.selected=void 0,d.preconfigured=[{preconfig:!0,type:"photo",typeDesc:"图片"}],d.$on("searchChanged",function(a,b){d.asyncSelected=b}),d.getLocation=function(a){var b=l.defer();return d.mapService.getLocPois(a,function(a){b.resolve(a)}),b.promise.then(function(b){var c=angular.copy(d.preconfigured);return angular.forEach(c,function(b){b.address=a,b.val=a}),c.concat(b)})},d.goLocation=function(a){if(angular.isString(a)&&d.setSearch(a),a.preconfig)d.setSearch(a.val);else{var b=a.location;b&&(d.mapEventListener.setCenter(d.map,b.lat,b.lng),d.mapEventListener.setZoom(d.map,a.zoom))}},d.onSelect=function(a){d.goLocation(a)}}]).controller("MapsPopularCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d){d.selectable=!1,d.setPanormaioType("popular"),d.$on("searchChanged",function(a,b){d.search(b,"photo").then(function(a){d.photos=a})})}]).controller("MapsRecentCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d){d.selectable=!1,d.setPanormaioType("recent"),d.$on("searchChanged",function(a,b){d.search(b,"photo").then(function(a){d.photos=a})})}]).controller("MapsTravelCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){e.getTravel({travelId:a},function(a){"OK"==a.status&&(d.stateStatus.name=a.travel.title,d.setTravel(a.travel),d.travel.spots[0],f.getOpenInfo({userId:d.travel.user_id},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info)}))})}function m(b){d.travelLayer=new a.cnmap.TravelLayer({ctx:d.ctx,staticCtx:d.staticCtx,travel:d.travel,clickable:!0}),jQuery(d.travelLayer).bind("data_clicked",function(a,b){d.displayPhoto(b)}),d.travelLayer.setMap(b)}function n(){d.travelLayer.clearMap()}d.panoramioLayer.setAuto(!1),d.setTravel=function(a){d.travel=a,d.travelEnedit=d.userId==d.travel.user_id&&d.editableView,angular.isArray(d.travel.spots)||(d.travel.spots=[]),d.travel.spot&&d.travel.spots.push(d.travel.spot),angular.forEach(d.travel.spots,function(a){a.addresses={},angular.forEach(a.photos,function(b){b.point.address&&(a.addresses[b.point.address]=b.point)})}),d.travelLayer.clearMap(),d.travelLayer.setTravel(d.travel),d.travelLayer.initMap()},d.$on("travelChanged",function(a,b){l(b)}),d.$on("mapChanged",function(){m(d.map)}),d.$on("editableViewChanged",function(a,b){d.travel&&(d.travelEnedit=d.userId==d.travel.user_id&&b)}),d.$on("$destroy",function(){n()}),d.activePhoto=function(a){d.photo&&d.photo.id==a.id?d.displayPhoto(a.id):(d.photo=a,d.travelLayer.activePhoto(a))},d.activeSpot=function(a){var b=0;return b=angular.isObject(a)?a.id:a,d.activedSpot&&d.activedSpot.id==b?void d.travelLayer.activeSpot(a):(angular.forEach(d.travel.spots,function(a){a.id==b?(a.active=!0,d.activedSpot=a):a.active=!1}),void d.travelLayer.activeSpot(a))},d.showSpotAddress=function(a){return a.address||"添加地址"},d.dateOptions={formatYear:"yy",startingDay:1};var o=new Date;d.datepickerDisabled=function(a,b){return"day"===b&&a>o},d.map&&m(d.map),k.travelId&&l(k.travelId)}]).controller("MapsTravelSpotCtrl",["$window","$location","$rootScope","$scope","$q","TravelService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","$filter","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){d.$watch("spot.timeStart",function(a){if(a){var b=d.updateSpot(d.spot,"time_start",m("date")(a,"yyyy/MM/dd"));b.then(function(){d.spot.time_start=a,d.travelLayer.calcSpotTime()},function(){})}}),d.updateSpot=function(a,b,c){var d=e.defer(),g={title:a.title,description:a.description,address:a.address};return g[b]=c,f.changeSpot({travelId:a.travel_id,typeId:a.id},n.param(g),function(a){a=a||{},"OK"===a.status?d.resolve():d.resolve(a.info)},function(a){d.reject(a.data?a.data.info:"Server error!")}),d.promise},d.createSpot=function(a){f.createSpot({travelId:d.spot.travel_id},n.param({}),function(b){"OK"==b.status&&d.addSpotPhoto(a,b.spot)})},d.addSpotPhoto=function(a,b){var c={photos:a.id};f.addSpotPhoto({travelId:b.travel_id,typeId:b.id},n.param(c),function(a){"OK"==a.status&&d.setTravel(a.travel)})},d.removePhoto=function(a){d.$emit("photoDeleteEvent",a.id)},d.deleteSpot=function(a){f.deleteSpot({travelId:a.travel_id,typeId:a.id},function(a){"OK"==a.status&&d.setTravel(a.travel)})}}]).controller("MapsUserCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){d.loadBusy||(d.loadBusy=!0,e.get({userId:d.userId,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage,swlat:d.bounds.sw.lat,swlng:d.bounds.sw.lng,nelat:d.bounds.ne.lat,nelng:d.bounds.ne.lng},function(a){"OK"==a.status&&(a.photos.length<d.photo.pageSize&&(d.loadMoreDisabled=!0),d.photos=1===d.photo.currentPage?l.Array.mergeRightist(d.photos||[],a.photos,"id"):l.Array.append(d.photos||[],a.photos,"id"),d.photo.currentPage++,d.$broadcast("ponmPhotoFluidResize",{}),d.loadBusy=!1)}))}d.selectable=!1,d.userId=k.userId,d.photo={pageSize:20,currentPage:1,maxSize:10},d.photos=[],d.loadMoreDisabled=!1,d.loadBusy=!1,$(d.panoramioLayer).bind("map_changed",function(a,b,c,e){i.debug(c),d.bounds=b,d.level=c,d.size=e,d.photo.currentPage=1,d.loadMoreDisabled=!1,m()}),d.setPanormaioType("user",d.userId),d.$on("$destroy",function(){$(d.panoramioLayer).unbind("map_changed")}),d.loadMorePhotos=function(){m()}}]).controller("MapsTravelsCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","TravelService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d,e,f,g,h,i,j,k){d.setPanormaioType("manual"),d.goTravel=function(a){k.go("maps.travel",{travelId:a.id})},d.$on("searchChanged",function(a,b){d.travels=[],d.search(b,"travel").then(function(a){var b={};angular.forEach(a,function(a){a.travel_id&&!b[a.travel_id]&&(b[a.travel_id]=a.travel_id,g.getTravel({travelId:a.travel_id},function(a){"OK"==a.status&&(a.travel.photos=[],angular.forEach(a.travel.spots,function(b){a.travel.photos=a.travel.photos.concat(b.photos)}),d.travels.push(a.travel))}))})})})}]).controller("MapsPhotoUploadCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","TravelService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d,e,f,g,h,i,j){function k(a,b,c){a.mapVendor.marker?(n.setPosition(a.mapVendor.marker,b,c),n.setMap(a.mapVendor.marker,d.map)):l(a,b,c),d.setPlace(a,b,c)}function l(a,b,c){if(b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=n.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,n.setMap(a.mapVendor.marker,d.map),n.addMarkerActiveListener(a.mapVendor.marker,function(){d.activePhoto(this.photo_file)}),n.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function m(a){n.addMapClickListener(a,function(a,b){d.file&&(k(d.file,a,b),n.activeMarker(d.file.mapVendor.marker))
})}d.setPanormaioType("manual");var n=d.mapEventListener,o=d.mapService,p={};d.$on("photoAdd",function(a,b){j.debug(b.id),b.mapVendor=b.mapVendor||{},p[b.id]=p[b.id]||b,b=p[b.id],b.point&&k(b,b.point.lat,b.point.lng)}),d.$on("photoDelete",function(a,b){j.debug("photo delete: "+b.id),b=p[b.id],b&&(b.mapVendor.marker&&n.removeMarker(b.mapVendor.marker),delete p[b.id])}),d.$on("photoActive",function(a,b){j.debug("active: "+b.id),b=p[b.id],b&&d.activePhoto(b)}),d.map&&m(d.map),d.$on("mapChanged",function(){m(d.map)}),d.$on("$destroy",function(){n.clearMap()}),d.activePhoto=function(a){d.file&&(d.file.active=!1,d.file.mapVendor&&n.deactiveMarker(d.file.mapVendor.marker)),d.file=a,d.file.active=!0,d.file.mapVendor&&d.file.mapVendor.lat&&(n.activeMarker(d.file.mapVendor.marker),n.inMapView(d.file.mapVendor.lat,d.file.mapVendor.lng,d.map)||n.setCenter(d.map,d.file.mapVendor.lat,d.file.mapVendor.lng)),d.$broadcast("photoReverseActive",a)},d.setPlace=function(a,b,c,e){a.mapVendor.lat=b,a.mapVendor.lng=c,a.mapVendor.latPritty=cnmap.GPS.convert(b),a.mapVendor.lngPritty=cnmap.GPS.convert(c),e&&(a.mapVendor.address=e),j.debug("setPlace for photo: "+a.id),o.getAddrPois(b,c,function(b,c){e||(a.mapVendor.address=c),a.mapVendor.addresses=b,j.debug("getAddrPois for photo: "+a.id),d.$broadcast("photoReverseAddress",a)})}}]),angular.module("ponm.Navbar",["ngResource","ui.bootstrap","ponmApp"]).controller("SearchLocCtrl",["$window","$scope","$log","$http","ponmCtxConfig",function(a,b,c,d,e){b.ctx=e.ctx,b.staticCtx=e.staticCtx,b.apirest=e.apirest,b.getLocation=function(a){return d.get("http://maps.googleapis.com/maps/api/geocode/json",{params:{address:a,sensor:!1}}).then(function(a){var b=[];return angular.forEach(a.data.results,function(a){b.push(a)}),b})},b.update=function(c){var d=c.geometry;d&&(a.location=b.ctx+"/map##lat="+d.location.lat+"&lng="+d.location.lng+"&bounds="+d.bounds.southwest.lat+","+d.bounds.southwest.lng+","+d.bounds.northeast.lat+","+d.bounds.northeast.lng)}}]),angular.module("photoApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","ui.map","ponmApp","ponmApp.services","ponmApp.directives"]).controller("PhotoCtrl",["$window","$location","$log","$rootScope","$scope","$cookieStore","$cookies","PhotoService","CommentService","UserService","UserPhoto",function(a,b,c,d,e,f,g,h,i,j,k){function l(){h.getComments({photoId:e.photoId,pageSize:e.comment.pageSize,pageNo:e.comment.currentPage},function(a){"OK"==a.status&&(e.comments=a.comments)},function(){})}e.ctx=a.ctx,e.apirest=a.apirest;var m=a.cnmap.MapEventListener.factory(),n=b.absUrl(),o=n.match(/\/photo\/[0-9]+/g);e.photoId=o?o[0].match(/[0-9]+/g)[0]:8,e.photo={},e.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},e.comments=[],e.$watch("comment.currentPage",function(){l()}),e.user={},e.user.userId=a.userId,e.user.username=g.username,e.user.login=a.login,e.photo={},h.getPhoto({photoId:e.photoId},function(a){c.debug(a),"OK"==a.status&&(e.photo=a.prop,e.comment.totalItems=a.prop.comment_count,e.comment.numPages=Math.ceil(e.comment.totalItems/e.comment.pageSize),e.photo.save=function(){e.editable="",h.updateProperties({photoId:e.photoId},{title:e.photo.title,description:e.photo.description},function(){})},j.getOpenInfo({userId:e.photo.user_id},function(a){"OK"==a.status&&(e.userOpenInfo=a.open_info)}),k.get({userId:e.photo.user_id,pageSize:e.photoId},function(a){"OK"==a.status&&(e.user_photos=a.photos.slice(0,6))}))}),h.getGPSInfo({photoId:e.photoId,vendor:"gaode"},function(a){"OK"==a.status&&a.gps.length&&(e.gpsInfo=a.gps[0],c.debug(e.gpsInfo),e.gpsInfo.lat=cnmap.GPS.convert(e.gpsInfo.gps.lat),e.gpsInfo.lng=cnmap.GPS.convert(e.gpsInfo.gps.lng),m.setCenter(e.minimap1,e.gpsInfo.gps.lat,e.gpsInfo.gps.lng),m.addMarker(e.minimap1,e.gpsInfo.gps.lat,e.gpsInfo.gps.lng))}),h.getCameraInfo({photoId:e.photoId},function(a){"OK"==a.status&&(e.cameraInfo=a.camera_info),c.debug(e.cameraInfo)}),l(),e.user.login&&e.user.userId&&j.getOpenInfo({userId:e.user.userId},function(a){"OK"==a.status&&(e.user.open_info=a.open_info)}),e.setEditable=function(a){"true"==e.user.login&&e.userOpenInfo.name==e.user.username&&(e.editable=a)},e.deletePhoto=function(){a.alert("您确定要删除这张照片？")},e.createComment=function(a){a&&i.save({photoId:e.photoId,content:a},function(a){"OK"==a.status&&(e.comment.content="",e.comment.count=e.comment.count+1,e.comments.splice(0,0,a.comment))})},e.favorite=function(){e.user.login&&(e.photo.favorite?h.removeFavorite({photoId:e.photoId},function(a){"OK"==a.status&&(e.photo.favorite=!1)}):h.favorite({photoId:e.photoId},{},function(a){"OK"==a.status&&(e.photo.favorite=!0)}))},e.mapOptions={toolbar:!0,scrollzoom:!1,maptype:"SATELLITE",resizeEnable:!0,panControl:!1,level:13,uiMapCache:!1},"qq"==a.mapVendor&&(a.mapVendor="gaode");var p=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});p.initEnv(a.ctx),$(p).bind("data_changed",function(a,b){e.$apply(function(){e.update_nearby_photos(b)})}),e.$watch("minimap1",function(){if(!e.map){e.map=e.minimap1;var a=e.minimap1;p.setMap(a)}}),e.update_nearby_photos=function(a){e.nearby_photos=a&&a.slice(0,5)}}]),angular.module("ponmApp.controllers").controller("PhotoModalCtrl",["$window","$scope","$log","$modalInstance","photoId","travelId","PhotoService","CommentService","UserService","TravelService","$q","$modal","$filter","param","$location","ponmCtxConfig",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a){g.getCameraInfo({photoId:a},function(a){"OK"==a.status&&(b.cameraInfo=a.camera_info)})}function r(a){g.getComments({photoId:a,pageSize:b.comment.pageSize,pageNo:b.comment.currentPage},function(a){"OK"==a.status&&(b.comments=a.comments)},function(){})}function s(a){j.getTravel({travelId:a},function(a){if("OK"==a.status){b.travel=a.travel,b.travel.photos=[],b.travel.totalPhoto=0,b.travel.currentPhoto=0;var c=0;angular.forEach(b.travel.spots,function(a){angular.forEach(a.photos,function(a){c+=1,a.id==e&&(a.active=!0,b.travel.activePhoto=a),a.sortCount=c,b.travel.photos.push(a)})}),b.travel.totalPhoto=c}})}b.ctx=a.ctx,b.staticCtx=p.staticCtx,b.corsproxyCtx=p.corsproxyCtx,b.apirest=a.apirest,b.photoId=e,b.userId=a.userId,b.login=a.login,b.photoDetailCollapsed=!0,b.comment={pageSize:10,totalItems:0,numPages:0,currentPage:1,maxSize:10},b.setPhotoId=function(a){c.debug("photoId"+a),b.photoId=a,g.getPhoto({photoId:b.photoId},function(a){"OK"==a.status&&(b.photo=a.prop,b.photoEditable=b.userId==b.photo.user_id,b.comment.totalItems=a.prop.comment_count,b.comment.numPages=Math.ceil(b.comment.totalItems/b.comment.pageSize),i.getOpenInfo({userId:b.photo.user_id},function(a){"OK"==a.status&&(b.userOpenInfo=a.open_info)}),f||(b.photo.travel_id?(f=b.photo.travel_id,s(f)):b.travel={}))}),q(a),r(a)},f&&s(f),b.getPhotoSrc=function(a){if(!a)return"";var c="@";return(a.width>2e3||a.height>2e3)&&(c+="0e_2000w_2000h"),a.file_size>4194304?c+="_50Q":a.file_size>2097152?c+="_80Q":a.file_size>1048576&&(c+="_90Q"),c+=".jpg",b.staticCtx+"/"+a.oss_key+c},b.createComment=function(a){var c=k.defer();return a?h.save({photo_id:b.photoId,content:a},function(a){a=a||{},"OK"==a.status?(b.comment.count=b.comment.count+1,b.comments.push(a.comment),b.photo.comment_count+=1,c.resolve(!1)):c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}):c.resolve(!1),c.promise},b.updatePhoto=function(a,b,c){var d=k.defer(),e={};return e[b]=c,g.updateProperties({photoId:a.id},e,function(a){a=a||{},"OK"===a.status?d.resolve():d.resolve(a.info)},function(a){d.reject(a.data?a.data.info:"Server error!")}),d.promise},b.addTravel=function(a){var c=k.defer();return j.addPhoto({travelId:a},n({photos:b.photoId}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.showTravel=function(){var a=[];return b.userOpenInfo&&(a=m("filter")(b.userOpenInfo.travels,{id:b.photo.travel_id})),b.photo.travel_id&&a.length?a[0].title:"添加到旅行"},b.$on("deletedCommentEvent",function(a,c){a.preventDefault(),a.stopPropagation(),angular.forEach(b.comments,function(a,d){a.id==c&&(delete b.comments.splice(d,1),b.photo.comment_count-=1)})}),b.$on("replyCommentEvent",function(a,c){a.preventDefault(),a.stopPropagation(),b.comment.placeholder="回复 "+c.name,b.commentContent="@"+c.name+" "}),b.cancelComment=function(){b.comment.placeholder="",b.commentContent=""},b.like=function(){b.photo.like?g.unLike({photoId:b.photoId},function(a){a=a||{},"OK"===a.status&&(b.photo.like=!1,b.photo.like_count-=1)},function(a){a.data}):g.like({photoId:b.photoId},function(a){a=a||{},"OK"===a.status&&(b.photo.like=!0,b.photo.like_count+=1)},function(a){a.data})},b.cancel=function(){d.dismiss("cancel")},b.setTravelAlbum=function(a){b.travelAlbum=a},b.openTravelAlbum=function(){c.debug("open travel album"),b.travelAlbum.open()},b.closeTravelAlbum=function(){b.travelAlbum.close()},b.setRecommendAlbum=function(a){b.recommendAlbum=a},b.openRecommendAlbum=function(){c.debug("open recommend album"),b.recommendAlbum.open()},b.openPhoto=function(a){b.travel.activePhoto&&(b.travel.activePhoto.active=!1),a.active=!0,b.travel.activePhoto=a,b.closeTravelAlbum(),b.setPhotoId(a.id)},b.previous=function(){var a=0;if(b.travel.activePhoto&&(a=b.travel.activePhoto.sortCount-2)>=0){b.travel.activePhoto.active=!1;var c=b.travel.photos[a];c.active=!0,b.travel.activePhoto=c,b.setPhotoId(c.id)}else b.openTravelAlbum()},b.next=function(){var a=0;if(b.travel.activePhoto&&(a=b.travel.activePhoto.sortCount)<b.travel.photos.length){b.travel.activePhoto.active=!1;var c=b.travel.photos[a];c.active=!0,b.travel.activePhoto=c,b.setPhotoId(c.id)}else b.openRecommendAlbum()},b.setPhotoId(e),b.openMapPhoto=function(){var a=l.open({templateUrl:"views/mapPhoto.html",controller:"MapPhotoCtrl2",windowClass:"map-photo-modal",resolve:{photoId:function(){return b.photoId}}});a.result.then(function(a){b.selected=a,b.setPhotoId(b.photoId)},function(){c.info("Modal dismissed at: "+new Date),b.setPhotoId(b.photoId)})},b.share=function(){}}]).directive("photoTravelAlbum",["$rootScope","$animate","$log",function(a,b){return{restrict:"A",link:function(a,c){var d=c.find(".travel-album-background"),e=c.find(".travel-album");d.on("click",function(){f.close()});var f={open:function(){b.addClass(d,"show"),b.addClass(e,"show")},close:function(){b.removeClass(d,"show"),b.removeClass(e,"show")}};a.setTravelAlbum(f)}}}]).directive("photoRecommendAlbum",["$rootScope","$animate","$log",function(a,b){return{restrict:"A",link:function(a,c){var d=c.find(".recommend-album-background"),e=c.find(".recommend-album");d.on("click",function(){f.close()});var f={open:function(){b.addClass(d,"show"),b.addClass(e,"show")},close:function(){b.removeClass(d,"show"),b.removeClass(e,"show")}};a.setRecommendAlbum(f)}}}]).controller("MapPhotoCtrl2",["$window","$log","$timeout","$scope","$modalInstance","PhotoService","GeocodeService","photoId","ponmCtxConfig",function(a,b,c,d,e,f,g,h,i){function j(){d.file&&d.file.mapVendor&&d.file.mapVendor.marker&&n.setMap(d.file.mapVendor.marker,null),d.file={photoId:d.photoId},f.getPhoto({photoId:d.photoId},function(a){"OK"==a.status&&(d.photo=a.prop,d.file.is360=a.prop.is360)}),f.getGPSInfo({photoId:d.photoId},function(a){"OK"==a.status&&(m(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng),n.setCenter(d.map,a.gps[0].gps.lat,a.gps[0].gps.lng),d.setPlace(d.file,a.gps[0].gps.lat,a.gps[0].gps.lng,a.gps[0].gps.address))})}function k(a,b,c){if(a.mapVendor=a.mapVendor||{},b&&c)a.mapVendor.lat=b,a.mapVendor.lng=c;else{if(!a.lat&&!a.lng)return;a.mapVendor.lat=a.lat,a.mapVendor.lng=a.lng}a.mapVendor.marker=n.createDraggableMarker(d.map,a.mapVendor.lat,a.mapVendor.lng),a.mapVendor.marker.photo_file=a,n.setMap(a.mapVendor.marker,d.map),n.addDragendListener(a.mapVendor.marker,function(a,b){d.setPlace(this.photo_file,a,b)})}function l(a){n.addMapClickListener(a,function(a,b){m(d.file,a,b),d.setPlace(d.file,a,b)})}function m(a,b,c){a.mapVendor=a.mapVendor||{},a.mapVendor.marker?(n.setPosition(a.mapVendor.marker,b,c),n.setMap(a.mapVendor.marker,d.map)):(k(a,b,c),n.activeMarker(a.mapVendor.marker))}d.ctx=a.ctx,d.staticCtx=i.staticCtx,d.apirest=a.apirest,d.userId=a.userId;var n=a.cnmap.MapEventListener.factory(),o=a.cnmap.MapService.factory();d.mapEventListener=n,d.mapService=o,d.photoId=h,d.cancel=function(){e.dismiss("cancel")},d.ok=function(){f.updateProperties({photoId:d.photoId},{point:{lat:d.file.mapVendor.lat,lng:d.file.mapVendor.lng,address:d.file.mapVendor.address},vendor:"gaode",is360:d.file.is360},function(a){"OK"==a.status?(b.debug("properties update successful"),d.addAlert({type:"success",msg:"保存成功!"})):d.addAlert({type:"danger",msg:"保存失败 "+a.status})},function(a){d.addAlert({type:"danger",msg:"保存失败 "+(a.data&&a.data.status)})})},d.$watch("$$childTail.myMap",function(a){d.map=a,o.init(a),l(d.map),j()}),d.addOrUpdateMarker=m,d.setPlace=function(a,b,c,e){d.file.mapVendor=d.file.mapVendor||{},d.file.mapVendor.lat=b,d.file.mapVendor.lng=c,d.file.mapVendor.latPritty=cnmap.GPS.convert(b),d.file.mapVendor.lngPritty=cnmap.GPS.convert(c),e&&(d.file.mapVendor.address=e),o.getAddrPois(b,c,function(a,b){e||(d.file.mapVendor.address=b),d.file.mapVendor.addresses=a})},d.clearPlace=function(){};var p=null;d.addAlert=function(a){d.alerts=[],d.alerts.push(a),p&&c.cancel(p),p=c(function(){d.alerts=[]},3e3)},d.closeAlert=function(a){d.alerts&&d.alerts.splice(a,1)},d.mapOptions={toolbar:!0,scrollzoom:!0,maptype:!0,overview:!0,resizeEnable:!0}}]),angular.module("photosApp",["ui.bootstrap","ui.map","ui.router","ponmApp","xeditable"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/","/yourphotos/all").otherwise("/yourphotos/all"),a.state("photos",{"abstract":!0,url:"/:userId",views:{"":{templateUrl:"views/photos.html",controller:"PhotosCtrl"},"alerts@photos":{templateUrl:"views/photos.alerts.html",controller:"PhotosAlertsCtrl"}},resolve:{},controller:"PhotosCtrl"}).state("photos.all",{url:"/all",templateUrl:"views/photos.all.html",resolve:{},controller:"PhotosAllCtrl"}).state("photos.recent",{url:"/recent",templateUrl:"views/photos.all.html",resolve:{},controller:"PhotosRecentCtrl"}).state("photos.albums",{url:"/albums",templateUrl:"views/photos.albums.html",resolve:{},controller:"PhotosAlbumsCtrl"}).state("photos.album",{url:"/albums/:travelId",templateUrl:"views/photos.album.html",resolve:{},controller:"PhotosAlbumCtrl"}).state("photos.trash",{url:"/trash",templateUrl:"views/photos.trash.html",resolve:{},controller:"PhotosTrashCtrl"})}]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("PhotosCtrl",["$window","$location","$rootScope","$scope","PhotoService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","safeApply","jsUtils","HashStateManager",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){angular.forEach(d.selectedPhotos,function(a){d.selectPhoto(null,a),d.$broadcast("removePhotoDo",a.id)})}d.ctx=a.ctx,d.staticCtx=h.staticCtx,d.apirest=a.apirest,d.$state=j,d.$location=b,d.$stateParams=k,d.navbarFixedTop=!1,d.hashStateManager=new n(d,b),i.debug(j),d.userId=j.params.userId,"yourphotos"==d.userId&&(d.userId=a.userId),d.hashStateManager.set("userid",d.userId),f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info)}),d.cancelSelect=function(){d.$broadcast("photosCancelSelect",{})},d.$on("photosCancelSelect",function(){d.selectable=!1,angular.forEach(d.selectedPhotos,function(a){a.actionSelected=!1}),d.selectedPhotos=[]}),d.navbarType="photos.trash"==j.current.name?"trash":"move",d.alertType="photos.trash"==j.current.name?"trash":"move",c.$on("$stateChangeSuccess",function(a,b){d.cancelSelect(),d.navbarType="photos.trash"==b.name?"trash":"move",d.alertType="photos.trash"==b.name?"trash":"move"}),d.selectedPhotos=[],d.selectPhoto=function(a,b){a&&a.preventDefault(),a&&a.stopPropagation(),b.actionSelected=!b.actionSelected,b.actionSelected?(d.selectable=!0,d.selectedPhotos.push(b)):(m.Array.removeItem(d.selectedPhotos,"id",b.id),0==d.selectedPhotos.length&&(d.selectable=!1))},d.setWaypointRefresh=function(a){d.waypointRefresh=a,d.photoLoading=a},d.displayPhoto=function(a){d.hashStateManager.set("photoid",a);var b=g.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a},travelId:function(){return""}}});b.result.then(function(){d.hashStateManager.set("photoid","")},function(){d.hashStateManager.set("photoid","")})},d.hashStateManager.watch("photoid",function(a){a&&d.displayPhoto(a)}),d.openMovePhoto=function(){var a=g.open({templateUrl:"views/photos.move.html",controller:"PhotosMoveCtrl",windowClass:"map-photo-modal",resolve:{photos:function(){return d.selectedPhotos},operateType:"move"}});a.result.then(function(){i.debug("move photos success"),o()},function(){i.debug("move photos fail"),i.info("Modal dismissed at: "+new Date)})},d.deletePhoto=function(){angular.forEach(d.selectedPhotos,function(a){e.delete({photoId:a.id},function(b){"OK"==b.status&&(d.selectPhoto(null,a),d.$broadcast("removePhotoDo",a.id))})})},d.cancelRecycle=function(){d.$broadcast("cancelRecycleDo",{})},d.removeRecycle=function(){d.$broadcast("removeRecycleDo",{})},d.selectAll=function(){d.$broadcast("selectAllDo",{})},d.emptyRecycleBin=function(){d.$broadcast("emptyRecycleBinDo",{})}}]).controller("PhotosAlertsCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(){}]).controller("PhotosAllCtrl",["$window","$location","$rootScope","$scope","$q","$timeout","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){h.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info,d.editable=d.userOpenInfo.id==d.userId,d.photo.numPages=Math.ceil(d.userOpenInfo.photo_count/d.photo.pageSize))})}function p(){var a=e.defer();return d.photo.currentPage>d.photo.numPages?(f(function(){a.resolve()},500),a.promise):(k.debug("load more photos"),g.get({userId:d.userId,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(b){"OK"==b.status&&(d.photos=d.photos.concat(b.photos)),a.resolve()},function(){d.photoLoading=!1}),d.photo.currentPage+=1,a.promise)}d.photo={pageSize:2,totalItems:0,numPages:2,currentPage:1,maxSize:10},o(),d.photos=[],d.getUserPhotos=p,p(),d.$on("waypointEvent",function(a,b,c){k.debug("waypointSpot: "+b+" = "+c),"loadMore"==c&&(a.preventDefault(),a.stopPropagation(),"down"==b&&p())}),d.$on("removePhotoDo",function(a,b){n.Array.removeItem(d.photos,"id",b)})}]).controller("PhotosRecentCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(){}]).controller("PhotosAlbumsCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d,e,f){f.getTravels({userId:d.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)})}]).controller("PhotosAlbumCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","Travel","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){a&&e.getTravel({travelId:a},function(a){"OK"==a.status&&(d.travel=a.travel,l.calculate(d.travel),f.getOpenInfo({userId:d.travel.user_id},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info)}))})}d.travelId=k.travelId,n(d.travelId),d.selectAll=function(){angular.forEach(d.travel.spots,function(a){angular.forEach(a.photos,function(a){d.selectPhoto(null,a)})})},d.$on("removePhotoDo",function(a,b){angular.forEach(d.travel.spots,function(a){m.Array.removeItem(a.photos,"id",b)})})}]).controller("PhotosTrashCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams","jsUtils",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){d.selectPhoto(null,a),angular.forEach(d.travels,function(b,c){l.Array.removeItem(b.photos,"id",a.id),0==b.photos.length&&delete d.travels[c]})}d.travels={},f.getRecycleBin({userId:d.userId},function(a){"OK"==a.status&&angular.forEach(a.recycles,function(a){"photo"==a.recy_type&&(a.photo.recycle=a.id,a.photo.travel_id?(d.travels[a.photo.travel_id]=d.travels[a.photo.travel_id]||{id:a.photo.travel_id,name:a.photo.travel_name,user_id:a.photo.user_id,photos:[]},d.travels[a.photo.travel_id].photos.push(a.photo)):(d.travels.noTravel=d.travels.noTravel||{user_id:a.photo.user_id,name:"无旅行",photos:[]},d.travels.noTravel.photos.push(a.photo)))})}),d.$on("cancelRecycleDo",function(){angular.forEach(d.selectedPhotos,function(a){f.cancelRecycle({userId:d.userId,value:a.recycle},function(b){"OK"==b.status&&m(a)})})}),d.$on("removeRecycleDo",function(){angular.forEach(d.selectedPhotos,function(a){f.removeRecycle({userId:d.userId,value:a.recycle},function(b){"OK"==b.status&&m(a)})})}),d.$on("selectAllDo",function(){angular.forEach(d.travels,function(a){angular.forEach(a.photos,function(a){d.selectPhoto(null,a)})})}),d.$on("emptyRecycleBinDo",function(){f.emptyRecycleBin({userId:d.userId},function(a){"OK"==a.status&&delete d.travels})})}]).controller("PhotosPhotoCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modal","ponmCtxConfig","$log","$state","$stateParams",function(a,b,c,d){d.$watch("rectSelected",function(a){(a&&!d.photo.actionSelected||!a&&d.photo.actionSelected)&&d.selectPhoto(null,d.photo)}),d.$on("photosCancelSelect",function(){d.rectSelected=!1})}]).controller("PhotosMoveCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modalInstance","ponmCtxConfig","$log","$q","param","operateType","photos",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b){var c=[];angular.forEach(a,function(a){c.push(a.id)});var d=j.defer();return c.length>0?e.addPhoto({travelId:b.id},k({photos:c.join(",")}),function(a){"OK"==a.status?d.resolve():d.reject(a.info)}):d.resolve(),d.promise}d.ctx=a.ctx,d.staticCtx=h.staticCtx,d.apirest=a.apirest,d.photos=m,d.cancel=function(){g.dismiss("cancel")},f.getTravels({userId:h.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)}),d.newTravel={},d.selectedTravel={},d.select=function(a,b){a.selected=void 0!=b?b:!a.selected,d.selectedTravel!=a&&(d.selectedTravel.selected=!1,d.selectedTravel=a)},d.selectNewTravel=function(a){a?d.select(d.newTravel,!0):d.select(d.newTravel,!1)},d.ok=function(){n(d.photos,d.selectedTravel).then(function(){g.close()},function(){})},d.displayText="move"==l?{ok:"移动",title1:"将",title2:"张图片移动到..."}:{ok:"移动",title1:"将",title2:"张图片到..."}}]).controller("PhotosTravelMoveCtrl",["$window","$location","$rootScope","$scope","TravelService","UserService","$modalInstance","ponmCtxConfig","$log","$q","param","operateType","photos",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b){var c=[];angular.forEach(a,function(a){c.push(a.id)});var d=j.defer();return c.length>0?e.addPhoto({travelId:b.id},k({photos:c.join(",")}),function(a){"OK"==a.status?d.resolve():d.reject(a.info)}):d.resolve(),d.promise}d.ctx=a.ctx,d.staticCtx=h.staticCtx,d.apirest=a.apirest,d.photos=m,d.cancel=function(){g.dismiss("cancel")},f.getTravels({userId:h.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)}),d.newTravel={},d.selectedTravel={},d.select=function(a,b){a.selected=void 0!=b?b:!a.selected,d.selectedTravel!=a&&(d.selectedTravel.selected=!1,d.selectedTravel=a)},d.selectNewTravel=function(a){a?d.select(d.newTravel,!0):d.select(d.newTravel,!1)},d.ok=function(){n(d.photos,d.selectedTravel).then(function(){g.close()},function(){})},d.displayText="move"==l?{ok:"移动",title1:"将",title2:"张图片移动到..."}:{ok:"移动",title1:"将",title2:"张图片到..."}}]),angular.module("userPageApp",["ui.bootstrap","ui.map","ponmApp","xeditable"]).run(["editableOptions",function(a){a.theme="bs3"}]).controller("UserCtrl",["$window","$location","$rootScope","$scope","UserPhoto","UserService","$modal","ponmCtxConfig",function(a,b,c,d,e,f,g,h){function i(a){a?e.getByTag({userId:d.userId,tag:a,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(a){"OK"==a.status&&(d.photos=a.photos)}):e.get({userId:d.userId,pageSize:d.photo.pageSize,pageNo:d.photo.currentPage},function(a){"OK"==a.status&&(d.photos=a.photos)})}function j(){f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info,d.editable=d.userOpenInfo.id==d.userId)})}function k(){f.getTravels({userId:d.userId},function(a){"OK"==a.status&&(d.travels=a.open_info.travels)})}function l(a){e.get({userId:d.userId,pageSize:a},function(a){if("OK"==a.status){var b=a.photo_info.photo_num;d.photo.totalItems=a.photo_info.photo_count,d.photo.currentPage=Math.ceil(b/d.photo.pageSize),d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),i()}})}function m(a){e.getByTag({userId:d.userId,tag:a},function(b){"OK"==b.status&&(d.photo.totalItems=b.photo_info.photo_count||0,d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),i(a))})}function n(){f.getOpenInfo({userId:d.userId},function(a){"OK"==a.status&&(d.userOpenInfo=a.open_info,d.photo.totalItems=a.open_info.photo_count||0,d.photo.numPages=Math.round(d.photo.totalItems/d.photo.pageSize),i())}),k()}d.ctx=a.ctx,d.staticCtx=h.staticCtx,d.apirest=a.apirest,d.photo={pageSize:40,totalItems:0,numPages:0,currentPage:1,maxSize:10},d.photos=[],d.tag="",d.editable=!1,d.$watch("photo.currentPage",function(){i(d.tag)});var o=b.search();o&&(o.id&&o.id!=d.userId&&(d.userId=o.id),o.with_photo_id?(l(o.with_photo_id),j()):o.tag?(d.tag=o.tag,m(o.tag),j()):n()),d.$watch(function(){return b.search()},function(a){a&&(a.id&&a.id!=d.userId&&(d.userId=a.id),a.with_photo_id?l(a.with_photo_id):a.tag?(d.tag=a.tag,m(a.tag)):n())}),d.$watch("photos",function(){angular.forEach(d.photos,function(a){a.backgroundColor="grey"})}),d.activePhoto=function(a){var b=g.open({templateUrl:"views/photo.html",controller:"PhotoModalCtrl",windowClass:"photo-modal-fullscreen",resolve:{photoId:function(){return a.id},travelId:function(){return""}}});b.result.then(function(a){d.selected=a},function(){})},d.mapOptions={toolbar:!0,scrollzoom:!1,maptype:"SATELLITE",resizeEnable:!0,level:3,uiMapCache:!1},"qq"==a.mapVendor&&(a.mapVendor="gaode");var p=new cnmap.PanoramioLayer({suppressInfoWindows:!1,mapVendor:a.mapVendor||"gaode"});p.initEnv(a.ctx,d.staticCtx),p.setUserId(d.userId),d.$watch("minimap",function(){if(!d.map){d.map=d.minimap;var a=d.minimap;p.setMap(a)}})}]),angular.module("userSettingsApp",["ngResource","ui.bootstrap","ponmApp"]).controller("UserSettingsCtrl",["$window","$log","$location","$rootScope","$scope","$modal","UserPhoto","UserService","ponmCtxConfig",function(a,b,c,d,e,f,g,h,i){function j(){h.getSettings({userId:e.userId},function(a){"OK"==a.status&&(e.settings=a.settings)})}e.ctx=a.ctx,e.staticCtx=i.staticCtx,e.apirest=a.apirest,e.avatar=e.userId=a.userId,e.changeAvatar=function(){e.avatar=1;var a=f.open({templateUrl:"views/changeUserAvatar.html",controller:"ChUserAvatarCtrl",windowClass:"map-photo-modal",resolve:{}});a.result.then(function(){e.avatar=e.userId},function(){e.avatar=e.userId,b.info("Modal dismissed at: "+new Date)})},j(),e.submit=function(){h.updateSettings({userId:e.userId},e.settings,function(a){e.addAlert("OK"==a.status?{type:"success",msg:"保存成功!"}:{type:"danger",msg:"保存失败!"})},function(){e.addAlert({type:"danger",msg:"保存失败!"})})},e.addAlert=function(a){e.alerts=[],e.alerts.push(a)},e.closeAlert=function(a){e.alerts&&e.alerts.splice(a,1)}}]),angular.module("fileuploadApp",["ngResource","ngAnimate","ui.bootstrap","blueimp.fileupload","ui.map","ponmApp","xeditable"]).config(["$httpProvider","fileUploadProvider","$logProvider",function(a,b){delete a.defaults.headers.common["X-Requested-With"],b.defaults.redirect=window.location.href.replace(/\/[^\/]*$/,"/cors/result.html?%s"),angular.extend(b.defaults,{autoUpload:!0,maxFileSize:1e7})}]).controller("DemoFileUploadController",["$window","$scope","$http","fileUpload","$modal","$log","PhotoService","GPSConvertService","LoginUserService","UserService","TravelService","jsUtils","safeApply",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,c){a.photoId=c.id,a.is360=c.is360,c.point&&(a.lat=c.point.lat,a.lng=c.point.lng,a.vendor=c.vendor,a.latPritty=cnmap.GPS.convert(a.lat),a.lngPritty=cnmap.GPS.convert(a.lng)),b.$emit("photoAdd",c)}function o(a){a.latPritty=cnmap.GPS.convert(a.lat),a.lngPritty=cnmap.GPS.convert(a.lng)}function p(a){if(a){var c=[];angular.forEach(b.queue,function(a){a.photoId&&c.push(a.photoId)}),c.length&&k.addPhoto({travelId:a.id},l.param({photos:c.join(",")}),function(a){"OK"==a.status})}}b.apirest=a.apirest,b.ctx=a.ctx,b.userId=a.userId;new a.cnmap.MapService;b.options={url:b.apirest+"/photo/upload",formData:function(){var a=this.files[0].lat||0,b=this.files[0].lng||0,c=this.files[0].address||"",d=this.files[0].vendor||"gps";return[{name:"lat",value:a},{name:"lng",value:b},{name:"address",value:c},{name:"vendor",value:d}]},done:function(a,b){if("OK"==b.result.status){var c=b.result.prop;b.files[0].$submit=!1,b.files[0].$cancel=!1,b.files[0].$endestroy=!0,n(b.files[0],c),b.files[0].saveProperties(),b.files[0].saveTags(),p()}else"NO_AUTHORIZE"==b.result.status?(b.files[0].error="请重新登录",b.files[0].$endestroy=!1):(b.files[0].error=b.result.info,b.files[0].$endestroy=!1)},fail:function(a,b){b.result?("NO_AUTHORIZE"==b.result.status&&(b.files[0].error="请重新登录"),b.files[0].$cancel=function(){b.files[0].$destroy()}):d.defaults.fail(a,b)}},d.defaults.autoUpload||(b.options.add=function(a,c){if(a.isDefaultPrevented())return!1;d.defaults.add(a,c);var e=c.files[0];loadImage.parseMetaData(e,function(a){if(a.exif){var c=a.exif.getText("GPSLatitude");if(c&&"undefined"!=c){e.lat=cnmap.GPS.convert(c);var d=a.exif.getText("GPSLatitudeRef");e.latRef=d}var f=a.exif.getText("GPSLongitude");if(f&&"undefined"!=f){e.lng=cnmap.GPS.convert(f);var g=a.exif.getText("GPSLongitudeRef");e.lngRef=g}e.latPritty=cnmap.GPS.convert(e.lat),e.lngPritty=cnmap.GPS.convert(e.lng),(e.lng||e.lat)&&h.convert({lat:e.lat,lng:e.lng},function(a){e.lat=a.lat,e.lng=a.lng,e.vendor="gaode",e.latPritty=cnmap.GPS.convert(e.lat),e.lngPritty=cnmap.GPS.convert(e.lng),b.$emit("photoAdd",{id:e.photoId,point:{lat:e.lat,lng:e.lng}})})}}),b.photoCount=b.photoCount||0,b.photoCount+=1,e.photoId=b.photoCount,b.$emit("photoAdd",{id:b.photoCount})}),b.$on("photoReverseAddress",function(a,c){f.debug("photoReverseAddress : "+c.id),angular.forEach(b.queue,function(a){a.photoId==c.id&&m(b,function(){a.mapVendor=c.mapVendor,a.address=c.mapVendor.address,a.lat=c.mapVendor.lat,a.lng=c.mapVendor.lng,o(a),a.saveProperties()})})}),b.changeLocation=function(a){var b=e.open({templateUrl:"views/changeLocationModal.html",controller:"ChLocModalCtrl",windowClass:"map-photo-modal",resolve:{files:function(){return a}}});b.result.then(function(a){angular.forEach(a,function(a){a.saveProperties()})},function(){f.info("Modal dismissed at: "+new Date)})},b.loadTravelData=function(a){var b=j.getTravels({userId:i.getUserId()},function(b){"OK"==b.status&&a&&a.apply(void 0,[b.open_info.travels])});f.debug(b)},b.newTravelData=function(a,b){return f.debug("new data: "+a),k.create({},jQuery.param({travel:a}),function(a){"OK"==a.status&&b&&b.apply(void 0,[a.travels])}),!1},b.loadTagData=function(a){return f.debug("load tags data"),j.getTags({userId:i.getUserId()},function(b){"OK"==b.status&&a&&a.apply(void 0,[b.open_info.tags])}),!0},b.newTagData=function(a,b){return f.debug("new data: "+a),j.createTag({userId:i.getUserId(),value:a},function(a){"OK"==a.status&&b&&b.apply(void 0,[a.open_info.tags])}),!1},b.$watch("travel",function(a){p(a)}),b.$watch("tags",function(){angular.forEach(b.queue,function(a){a.photoId&&a.saveTags()})})}]).controller("PhotoUploadRowCtrl",["$scope","$http","$q","$log","PhotoService","jsUtils",function(a,b,c,d,e){a.activePhoto=function(b){a.$emit("photoActive",{id:b.photoId}),a.activeFile&&(a.activeFile.active=!1),b.active=!0,a.activeFile=b
},a.$on("photoReverseActive",function(b,c){a.activeFile&&a.activeFile.photoId==c.id||(a.activeFile&&(a.activeFile.active=!1),angular.forEach(a.queue,function(b){b.photoId==c.id&&(b.active=!0,a.activeFile=b)}))}),a.$on("editableViewChanged",function(a,b){}),a.saveProperties=function(b,d){var f=c.defer();if(a.file.photoId){var g={title:a.file.title,description:a.file.description,point:{lat:a.file.lat,lng:a.file.lng,address:a.file.address},vendor:a.file.vendor,is360:a.file.is360};"address"==b?g.point[b]=d:g[b]=d,e.updateProperties({photoId:a.file.photoId},g,function(a){"OK"==a.status?f.resolve():f.resolve(a.info)},function(a){f.reject(a.data?a.data.info:"Server error!")})}else $timeout(function(){"address"==b?a.file.point[b]=d:a.file[b]=d},500);return f.promise};var f=a.file;f.tags=[],a.indoor={tag:"室内"},f.saveProperties=function(){if(this.photoId){var a=this;e.updateProperties({photoId:a.photoId},{title:a.title,description:a.description,point:{lat:a.lat,lng:a.lng,address:a.address},vendor:a.vendor,file_size:a.size,is360:a.is360},function(a){a&&d.debug("properties update successful")})}},f.saveTags=function(){var b=this,c=[];b.photoId&&(a.indoor.is&&c.push(a.indoor.tag),c=c.concat(b.tags||[]).concat(a.tags||[]),e.tag({photoId:b.photoId},c,function(a){a&&d.debug("tags update successful")}))},a.$watch("file.tags",function(){f.saveTags()}),a.$watch("file.is360",function(){f.saveProperties()}),a.$watch("indoor.is",function(){f.saveTags()})}]).controller("FileDestroyController",["$scope","$log","PhotoService",function(a,b,c){var d,e=a.file;e.$state=function(){return d},e.$destroy=function(){e.photoId&&(d="pending",c.delete({photoId:e.photoId},function(a){d=a?"resolved":"rejected"})),a.clear(e)},e.$cancel||e._index||(e.$cancel=function(){a.clear(e),b.debug("delete upload photo: "+e.name)}),a.delete=function(c){b.debug("delete upload photo: "+c.name),c.photoId?c.$destroy():c.$cancel(),a.$emit("photoDelete",{id:c.photoId})}}]);