"use strict";angular.module("ponmApp",["ngAnimate","ponmApp.directives","ponmApp.services"]).config(["$logProvider",function(a){a.debugEnabled=!0}]),angular.module("ponmApp.directives",["ponmApp.services","ngResource"]),angular.module("ponmApp.directives").directive("flexText",["$compile","$rootScope","$log",function(){function a(a,b){this.$textarea=a,this.options=b,this._init()}return a.prototype={_init:function(){var a=this;this.$textarea.wrap('<div class="flex-text-wrap" />').before("<pre><span /><br /></pre>"),a.options.hasUnderline&&this.$textarea.after('<div class="under-line"/>'),this.$span=this.$textarea.parent().find("span"),this.$underLine=this.$textarea.parent().find(".under-line"),this.$textarea.on("input propertychange keyup change",function(){a._mirror()}),this.$textarea.on("focus",function(){a.$underLine&&a.$underLine.addClass("active")}),this.$textarea.on("blur",function(){a.$underLine&&a.$underLine.removeClass("active")}),this._mirror()},_mirror:function(){this.$span.text(this.$textarea.val())}},{restrict:"A",link:function(b,c,d){var e=new a(c,{hasUnderline:!!d.hasUnderline});b.$watch(function(){return c.val()},function(){e._mirror()})}}}]),angular.module("perfect_scrollbar",[]).directive("perfectScrollbar",["$parse","$window",function(a,b){var c=["wheelSpeed","wheelPropagation","minScrollbarLength","useBothWheelAxes","useKeyboard","suppressScrollX","suppressScrollY","scrollXMarginOffset","scrollYMarginOffset","includePadding"];return{restrict:"EA",transclude:!0,template:"<div><div ng-transclude></div></div>",replace:!0,link:function(d,e,f){function g(a){d.$evalAsync(function(){"true"==f.scrollDown&&"mouseenter"!=a&&setTimeout(function(){$(e).scrollTop($(e).prop("scrollHeight"))},100),e.perfectScrollbar("update")});var b=d.$root&&d.$root.$$phase;"$apply"==b||"$digest"==b||d.$apply()}for(var h=angular.element(b),i={},j=0,k=c.length;k>j;j++){var l=c[j];void 0!==f[l]&&(i[l]=a(f[l])())}d.$evalAsync(function(){e.perfectScrollbar(i);var b=a(f.onScroll);e.scroll(function(){var a=e.scrollTop(),c=e.prop("scrollHeight")-e.height();d.$apply(function(){b(d,{scrollTop:a,scrollHeight:c})})})}),e.bind("mouseenter",g("mouseenter")),f.refreshOnChange&&d.$watchCollection(f.refreshOnChange,function(){g()}),f.refreshOnResize&&h.on("resize",g),e.bind("$destroy",function(){h.off("resize",g),e.perfectScrollbar("destroy")})}}}]),angular.module("ponmApp.directives").directive("backstretch",function(){return{restrict:"A",link:function(a,b,c){jQuery(b).backstretch(c.backgroundUrl),c.$observe("backgroundUrl",function(a){jQuery(b).backstretch(a)})}}}),angular.module("ponmApp.directives").directive("bdShare",["$window","$animate","$log","jsUtils","$q","$sce","$location",function(a,b,c,d,e,f,g){return{restrict:"EA",scope:{bdText:"@text",bdDesc:"@desc",bdComment:"@comment",bdUrl:"@url",bdPic:"@pic",bdBind:"@bdBind"},templateUrl:"views/bdShare.html",link:function(b){b.$watch(function(){return g.absUrl()},function(a){b.url=a.indexOf("&")>0?a+"&d":a}),a._bd_share_config={common:{bdSnsKey:{},bdMini:"2",bdMiniList:!1,bdStyle:"1",bdSize:"16"},share:{bdSize:16}};var c=document.createElement("script");c.type="text/javascript",c.src="http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion="+(new Date).getHours(),document.getElementsByTagName("body")[0].appendChild(c)}}}]),angular.module("ponmApp.directives").directive("dynamicMessage",["ponmCtxConfig","MessageService","alertService",function(a,b,c){return{restrict:"A",scope:{message:"=message",owner:"=owner"},templateUrl:"views/dynamic-message.html",link:function(d){switch(d.ctx=a.ctx,d.staticCtx=a.staticCtx,d.ponmCtxConfig=a,d.message.type){case"photo":d.message.point=d.message.photo.point;break;case"travel":d.message.travel.album_cover&&(d.message.point=d.message.travel.album_cover.point);break;case"message":var e=d.message.share_message;if(e)switch(d.message.tags=e.tags,d.message.comments=e.comments,d.message.like_count=e.like_count,d.message.like=e.like,e.type){case"photo":d.message.point=e.photo.point;break;case"travel":e.travel.album_cover&&(d.message.point=e.travel.album_cover.point)}}d.photoClick=function(a){d.$emit("photo.click",a)},d.pointClick=function(){d.message.point&&d.$emit("message.point.click",d.message)},d.getPhotoSrc=function(a){return"gif"==a.file_type?d.staticCtx+"/"+a.oss_key:d.staticCtx+"/"+a.oss_key+"@!photo-preview-big"},d.onWaypoint=function(a,b){"down"==b&&(a.addClass("shown"),d.active||(d.$emit("message.actived",angular.copy(d.message)),d.active=!0))},d.like=function(){d.message.like?b.unLike({id:d.message.id},function(a){"OK"==a.status&&(d.message.like=!1,d.message.like_count=1|d.message.like_count,d.message.like_count--)}):b.like({id:d.message.id},function(a){"OK"==a.status&&(d.message.like=!0,d.message.like_count=0|d.message.like_count,d.message.like_count++)})},d.share=function(a){b.share({id:a.id},{content:d.shareContent},function(a){"OK"==a.status?(d.flipx=!1,d.sharing=!1,c.add("success","分享成功!",{alone:!0}),d.$emit("message.shared",a.message)):c.add("danger","分享失败",{ttl:2e3})},function(){c.add("danger","分享失败",{ttl:2e3})})},d.delete=function(a){b.delete({id:a.id},function(b){"OK"==b.status?(c.add("success","删除成功!",{alone:!0,ttl:1e3}),d.$emit("message.deleted",a)):c.add("danger","删除失败",{ttl:1e3})},function(){c.add("danger","删除失败",{ttl:1e3})})}}}}]),angular.module("ponmApp.directives").directive("dynamicMessagesLayout",["$window","$timeout","$filter","$log","$q","ponmCtxConfig","jsUtils",function(a,b,c,d,e,f,g){var h={type:"photo",rules:{phone:767,tablet:979,desktop:1200}};return{restrict:"A",scope:{columnWidth:"=columnWidth",columnSize:"=columnSize"},templateUrl:"views/dynamic-messages.html",link:function(e,i,j){function k(){if(e.messages&&e.cursor<e.messages.length){var a=e.messages[e.cursor];if(e.cursor++,a){if(!p)switch(p=i.find(".messages-col"),p.removeClass("col-md-3"),p.removeClass("col-md-4"),p.removeClass("col-md-6"),p.removeClass("col-md-12"),e.columnSize){case 4:p.addClass("col-md-3");break;case 3:p.addClass("col-md-4");break;case 2:p.addClass("col-md-6");break;case 1:p.addClass("col-md-12");break;default:e.columnWidth?p.css("width",e.columnWidth):p.addClass("col-md-6")}angular.forEach(e.cols,function(a,b){a.height=angular.element(p[b]).outerHeight()});var d=e.cols.slice(0,e.columnSize);d=c("orderBy")(d,"height"),d[0].messages.push(a),e.layoutHander=b(function(){k()},500)}}}function l(a){e.layoutHander&&b.cancel(e.layoutHander),a>0&&(d.debug("layout changed layout"),e.cursor=0,angular.forEach(e.cols,function(a){a.messages=[]}),p=null,k())}function m(a){e.activeMessage&&(e.activeMessage.active=!1),angular.forEach(e.messages,function(b){b.id==a.id&&(e.activeMessage=b,e.activeMessage.active=!0)})}var n,o;o=e.$eval(j.dynamicMessagesLayout||"{}"),n=angular.extend({},h,o),e.owner=f;var p;e.cols=[{messages:[],height:0},{messages:[],height:0},{messages:[],height:0},{messages:[],height:0}],e.messages=[],e.cursor=0,e.updateLayout=function(a){var b;a>n.rules.phone?a>n.rules.tablet?a>n.rules.desktop||(b="desktop"):b="tablet":b="phone",e.layout!=b&&(e.layout=b,e.columnSize="phone"==b?1:"tablet"==b?2:"desktop"==b?3:4,d.debug("layout changed columnSize = "+e.columnSize),l(e.columnSize))},e.$watch("columnSize",function(a){l(a)}),e.$on("message.insert",function(a,b){e.cols[0].messages.splice(0,0,b),e.messages.splice(0,0,b)}),e.$on("message.add",function(a,b){b&&b.length&&(e.messages=e.messages.concat(b),k())}),e.$on("message.deleted",function(a,b){angular.forEach(e.cols,function(a){g.Array.removeItem(a.messages,"id",b.id)}),g.Array.removeItem(e.messages,"id",b.id)}),e.$on("message.point.click",function(a,b){m(b)}),e.$on("message.actived",function(a,b){m(b)}),e.$on("message.active",function(a,b){m(b)}),e.$watch(function(){return i.innerWidth&&i.innerWidth()},function(a){d.debug("container width changed"),e.updateLayout(a)}),angular.element(a).bind("resize",function(){var a=i.innerWidth&&i.innerWidth();a&&e.updateLayout(a)})}}}]),angular.module("ponmApp.directives").filter("newlines",function(){return function(a){return a?a.split(/\n/g):""}}).filter("calculatetime",function(){return function(a){if(!a||!angular.isNumber(a))return"";var b=new Date(a),c=new Date,d=c-b,e=Math.round(d/864e5);if(1>e){var f=Math.round(d/36e5);if(1>f){var g=Math.round(d/6e4)+1;return g+"分钟前"}return f+"小时前"}return e>5?a:e+"天前"}}).filter("bytes",function(){return function(a,b){if(isNaN(parseFloat(a))||!isFinite(a))return"-";"undefined"==typeof b&&(b=1);var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}}),angular.module("ponmApp.directives").directive("imageGallery",["$parse","$log","jsUtils",function(){var a={},b={fullScreen:!0};return{restrict:"EA",templateUrl:"views/imageGallery.html",link:function(c,d,e){var f,g=c.$eval(e.imageGallery||e.options||"{}");f=angular.extend({},a,g);var h=d.find(".blueimp-gallery");b.container=h,f.galleryCallback&&c.$eval(f.galleryCallback)(function(a,c){blueimp.Gallery(a,angular.extend({},b,c))}),c.$on("image-gallery",function(a,d){var e=c.$eval(f.galleryData||"galleryData");blueimp.Gallery(e,angular.extend({},b,d))})}}}]),function(){var a;a=angular.module("ponmApp.directives"),a.value("THROTTLE_MILLISECONDS",null),a.directive("infiniteScroll",["$rootScope","$window","$timeout","THROTTLE_MILLISECONDS",function(a,b,c,d){return{scope:{infiniteScroll:"&",infiniteScrollContainer:"=",infiniteScrollDistance:"=",infiniteScrollDisabled:"=",infiniteScrollUseDocumentBottom:"="},link:function(e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t;return b=angular.element(b),q=null,r=null,i=null,j=null,p=!0,t=!1,o=function(){var c,d,g,h,k;return j===b?(c=$(j).height()+$(j).scrollTop(),g=$(f).offset().top+$(f).height()):(c=j.height(),d=0,void 0!==j.offset()&&(d=j.offset().top),g=f.offset().top-d+f.height()),t&&(g=$(document).height()),h=g-c,k=h<=$(j).height()*q+1,k?(i=!0,r?e.$$phase||a.$$phase?e.infiniteScroll():e.$apply(e.infiniteScroll):void 0):i=!1},s=function(a,b){var d,e,f;return f=null,e=0,d=function(){var b;return e=(new Date).getTime(),c.cancel(f),f=null,a.call(),b=null},function(){var g,h;return g=(new Date).getTime(),h=b-(g-e),0>=h?(clearTimeout(f),c.cancel(f),f=null,e=g,a.call()):f?void 0:f=c(d,h)}},null!=d&&(o=s(o,d)),e.$on("$destroy",function(){return j.off("scroll",o)}),m=function(a){return q=parseInt(a,10)||0},e.$watch("infiniteScrollDistance",m),m(e.infiniteScrollDistance),l=function(a){return r=!a,r&&i?(i=!1,o()):void 0},e.$watch("infiniteScrollDisabled",l),l(e.infiniteScrollDisabled),n=function(a){return t=a},e.$watch("infiniteScrollUseDocumentBottom",n),n(e.infiniteScrollUseDocumentBottom),h=function(a){return null!=j&&j.off("scroll",o),j="function"==typeof a.last&&a!==b?a.last():a,null!=a?j.on("scroll",o):void 0},h(b),k=function(a){if(null!=a&&0!==a.length){if(a=angular.element(a),null!=a)return h(a);throw new Exception("invalid infinite-scroll-container attribute.")}},e.$watch("infiniteScrollContainer",k),k(e.infiniteScrollContainer||[]),null!=g.infiniteScrollParent&&h(angular.element(f.parent())),null!=g.infiniteScrollImmediateCheck&&(p=e.$eval(g.infiniteScrollImmediateCheck)),c(function(){return p?o():void 0},0)}}}])}.call(this),angular.module("ponmApp.directives").directive("ponmDynamicMenu",["$log",function(){return{name:"ponmDynamicMenu",scope:{navbar:"="},restrict:"EA",templateUrl:"views/ponm-dynamic-menu.html",replace:!0,link:function(a){function b(){var b=!1;angular.forEach(a.navbar,function(a){a.more&&a.active&&(a.once=!0,b=!0),a.hidden||(a.hidden=!1)}),angular.forEach(a.navbar,function(a){a.more&&!a.active&&(b?a.once=!1:a.once||(a.once=!1))})}a.more={more:!0,active:!1,once:!1,hidden:!1},a.normal={more:!1,hidden:!1},a.once={once:!0},a.$on("dynamic.menu",function(){b()}),b()}}}]),angular.module("ponmApp.directives").directive("passwordMatch",[function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(b){var e=a.$eval(c.passwordMatch);return d.$setValidity("unique",b==e),b}),a.$watch(c.passwordMatch,function(a){var b=d.$viewValue;d.$setValidity("unique",b==a)})}}}]).directive("passwordStrength",[function(){return{replace:!1,restrict:"A",link:function(a,b,c){var d={colors:["#F00","#F90","#FF0","#9F0","#0F0"],mesureStrength:function(a){var b=0,c=/[$-/:-?{-~!"^_`\[\]]/g,d=/[a-z]+/.test(a),e=/[A-Z]+/.test(a),f=/[0-9]+/.test(a),g=c.test(a),h=[d,e,f,g],i=$.grep(h,function(a){return a===!0}).length;return b+=2*a.length+(a.length>=10?1:0),b+=10*i,b=a.length<=6?Math.min(b,10):b,b=1==i?Math.min(b,10):b,b=2==i?Math.min(b,20):b,b=3==i?Math.min(b,40):b},getColor:function(a){var b=0;return b=10>=a?0:20>=a?1:30>=a?2:40>=a?3:4,{idx:b+1,col:this.colors[b]}}};a.$watch(c.passwordStrength,function(a){if(a){var c=d.getColor(d.mesureStrength(a));b.css({display:"inline"}),b.children("li").css({background:"#DDD"});for(var e=0;e<c.idx;e++)angular.element(b.children("li")[e]).css({background:c.col})}else b.css({display:"none"})})},template:'<li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li><li class="point"></li>'}}]).directive("ngRemoteValidate",["$http","$timeout","$q","$log",function($http,$timeout,$q,$log){var directiveId="ngRemoteValidate";return{restrict:"A",require:"ngModel",link:function(scope,el,attrs,ngModel){var cache={},handleChange,setValidation,addToCache,request,shouldProcess,options={ngRemoteThrottle:400,ngRemoteMethod:"POST"};angular.extend(options,attrs),options.urls="["===options.ngRemoteValidate.charAt(0)?eval(options.ngRemoteValidate):[options.ngRemoteValidate],addToCache=function(a){var b=a[0].data.value;return cache[b]?cache[b]:void(cache[b]=a)},shouldProcess=function(){var a=!1;for(var b in ngModel.$error)if(ngModel.$error[b]&&b!=directiveId){a=!0;break}return!(ngModel.$pristine||a)},setValidation=function(a,b){for(var c=0,d=a.length,e=!0;d>c;c++)if(!a[c].data.isValid){e=!1;break}b||addToCache(a),ngModel.$setValidity(directiveId,e),el.removeClass("ng-processing"),ngModel.$processing=!1},handleChange=function(a){return"undefined"!=typeof a?shouldProcess(a)?cache[a]?setValidation(cache[a],!0):(request&&$timeout.cancel(request),request=$timeout(function(){el.addClass("ng-processing"),ngModel.$processing=!0;var b=[],c=0,d=options.urls.length,e={value:a},f={method:options.ngRemoteMethod};for("POST"==options.ngRemoteMethod?f.data=e:f.params=e;d>c;c++)f.url=options.urls[c],b.push($http(f));$q.all(b).then(setValidation)},options.ngRemoteThrottle),!0):setValidation([{data:{isValid:!0,value:a}}],!0):void 0},scope.$watch(function(){return ngModel.$viewValue},handleChange)}}}]).directive("ngModelValidate",[function(){return{require:"ngModel",scope:{ngModelValidate:"&"},link:function(a,b,c,d){var e=a.ngModelValidate&&a.ngModelValidate();d.$parsers.unshift(function(b){if(e||(e=a.ngModelValidate&&a.ngModelValidate()),e){var c=e(b);return d.$setValidity(c.errorKey,c.isValid),c.isValid?b:void 0}return b})}}}]),angular.module("ponmApp.directives").directive("photoContainerFluid",["$window","$animate","$log","$timeout",function(a,b,c,d){var e={targetHeight:400,fadeSpeed:"fast",display:"inline-block",effect:"default",direction:"vertical",allowPartialLastRow:!1,imagesLoaded:!1,delayTime:500};return{restrict:"EA",link:function(b,f,g){function h(){f.removeWhitespace().collagePlus(j),b.$emit("ponm.photo.fluid.resized")}var i,j={};i=b.$eval(g.photoContainerFluid||"{}"),angular.extend(j,e,i),b.$watch(function(){return f.innerWidth&&f.innerWidth()},function(){b.updateFluid()}),angular.element(a).bind("resize",function(){b.updateFluid()}),b.$on("ponm.photo.fluid.resize",function(){b.updateFluid()}),g.$observe("photoContainerFluidTargetHeight",function(a){a&&j.targetHeight!=a&&(j.targetHeight=a,b.updateFluid())}),b.updateFluid=function(){c.debug("collage images"),b.updatePromise=d(function(){if(j.imagesLoaded&&a.imagesLoaded){var c=a.imagesLoaded&&a.imagesLoaded(f);c.on("always",function(){h(),d(function(){b.$apply(function(){})},j.delayTime)})}else h()},j.delayTime)}}}}]),angular.module("ponmApp.directives").directive("photoFluidContainer",["$window","$parse","$animate","$log","$timeout",function(a,b,c,d,e){return{restrict:"A",link:function(b,c,f){function g(){var a=c.innerWidth(),d=c.find(l.itemSelector);"maxi"==l.size?j(d,a):"mini"==l.size&&i(d,a),b.$emit("ponm-photo-fluid-resized")}function h(a,b){b>l.lineMaxHeight&&(b=l.lineMaxHeight);var c=Number(l.itemBorder),d=Number(l.itemMargin);b-=2*d,angular.forEach(a,function(a){var d=a.find("img");a.css("height",b+"px"),d.css("height",b-2*c+"px")})}function i(a,b){var c=[],d=0;angular.forEach(a,function(a){if(a=angular.element(a),a.scope&&a.scope()&&a.scope().photo&&a.scope().photo.width&&a.scope().photo.height)var e=a.scope().photo.width+2*l.itemMargin,f=a.scope().photo.height+2*l.itemMargin;else var e=a.outerWidth()+2*l.itemMargin,f=a.outerHeight()+2*l.itemMargin;var g=d+e*l.lineMinHeight/f;g>b?(h(c,b/d*l.lineMinHeight),c=[a],d=e*l.lineMinHeight/f):(c.push(a),d=g)}),c.length&&h(c,b/d*l.lineMinHeight)}function j(a,b){var c=[],d=0;angular.forEach(a,function(a){if(a=angular.element(a),a.scope&&a.scope()&&a.scope().photo&&a.scope().photo.width&&a.scope().photo.height)var e=a.scope().photo.width+2*l.itemMargin,f=a.scope().photo.height+2*l.itemMargin;else var e=a.outerWidth()+2*l.itemMargin,f=a.outerHeight()+2*l.itemMargin;c.push(a),d+=e/f*l.lineMaxHeight,d>=b&&(h(c,Math.floor(b*(l.lineMaxHeight/d))),c=[],d=0)}),c.length&&h(c,Math.floor(b*(l.lineMaxHeight/d)))}var k,l={size:"maxi",lineMaxHeight:200,lineMinHeight:100,itemSelector:".fluid-brick",itemMargin:0,itemBorder:0};k=b.$eval(f.photoFluidContainer||"{}"),angular.extend(l,k),b.$watch(function(){return c.innerWidth&&c.innerWidth()},function(){d.debug("container width changed"),b.updateFluid()}),angular.element(a).bind("resize",function(){b.updateFluid()}),b.$on("ponm.photo.fluid.resize",function(){d.debug("ponm.photo.fluid.resize"),b.updateFluid()}),b.updateFluid=function(){d.debug("updateFluid"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){g(),e(function(){b.$apply(function(){})},500)},500)},b.$watch(f.photoFluidContainer,function(){b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},1e3)})}}}]),angular.module("ponmApp.directives").directive("ponmProfileCard",["$window","$animate","$log","UserService","$q","ponmCtxConfig",function(a,b,c,d,e,f){return{restrict:"A",scope:{user:"=user",owner:"=owner"},templateUrl:"views/ponm-profile-card.html",link:{pre:function(a){a.staticCtx=f.staticCtx},post:function(a){a.following=function(b){a.followDoing=!0,c.debug(a.owner),d.following({userId:a.owner.id,value:b.id},{},function(c){a.followDoing=!1,"OK"==c.status&&(b.follow=!0)},function(){a.followDoing=!1})},a.unFollowing=function(b){d.unFollowing({userId:a.owner.id,value:b.id},function(c){a.followDoing=!1,"OK"==c.status&&(b.follow=!1)},function(){a.followDoing=!1})}}}}}]),angular.module("ponmApp.directives").directive("ponmTravelAlbum",["$window","$log","$q","ponmCtxConfig","TravelManager",function(a,b,c,d,e){return{restrict:"EA",scope:{travel:"=travel"},templateUrl:"views/ponm-travel-album.html",link:{pre:function(a){a.staticCtx=d.staticCtx;new e(a.travel)},post:function(a){a.photoClick=function(b){a.$emit("photo.click",b)}}}}}]),angular.module("ponmApp.directives").directive("ponmWhoToFollow",["$window","$animate","$log","UserService","$q","ponmCtxConfig",function(a,b,c,d,e,f){return{restrict:"A",scope:{user:"=user"},templateUrl:"views/ponm-who-to-follow.html",link:{pre:function(a){a.staticCtx=f.staticCtx},post:function(a){function b(b){d.getFollowSuggested({userId:b},function(b){"OK"==b.status&&(a.follows=b.follow)})}a.$watch("user.id",function(a){a&&b(a)}),a.following=function(b){a.followDoing=!0,c.debug(a.user),d.following({userId:a.user.id,value:b.id},{},function(c){a.followDoing=!1,"OK"==c.status&&(b.follow=!0)},function(){a.followDoing=!1})},a.unFollowing=function(b){d.unFollowing({userId:a.user.id,value:b.id},function(c){a.followDoing=!1,"OK"==c.status&&(b.follow=!1)},function(){a.followDoing=!1})},a.removeFollow=function(b){a.follows.splice(a.follows.indexOf(b),1)},a.refresh=function(){b(a.user.id)}}}}}]),angular.module("ponmApp.directives").directive("ponmComment",["$window","$animate","$log","CommentService","jsUtils","$q","ponmCtxConfig",function(a,b,c,d,e,f,g){return{restrict:"A",scope:{comment:"=",userId:"="},templateUrl:"views/ponm-comment.html",link:function(a){a.ctx=g.ctx,a.staticCtx=g.staticCtx,a.ponmCtxConfig=g,a.comment.editable=a.comment.user_id==a.userId,a.deleteCommment=function(b){d.delete({commentId:b.id},function(c){"OK"==c.status&&a.$emit("deletedCommentEvent",b.id)})},a.likeComment=function(a){a.like?d.unLike({commentId:a.id},function(b){b=b||{},"OK"===b.status&&(a.like=!1,a.like_count-=1)},function(a){a.data}):d.like({commentId:a.id},function(b){b=b||{},"OK"===b.status&&(a.like=!0,a.like_count=a.like_count||0,a.like_count+=1)},function(a){a.data})},a.modifyComment=function(a,b){var c=f.defer();return b&&d.modify({commentId:a.id},e.param({content:b}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},a.replyComment=function(b){a.$emit("replyCommentEvent",{id:b.user_id,name:b.username})}}}}]).directive("ponmComments",["$window","$animate","$log","$q","ponmCtxConfig","CommentService",function(a,b,c,d,e,f){var g={type:"photo"};return{restrict:"A",scope:{entityId:"&ponmCommentTo",comments:"=ponmCommentComments"},templateUrl:"views/ponm-comments.html",link:function(a,b,c){function h(){a.comment.commentLimit||(a.comment.limit=a.comments&&a.comments.length)}a.ctx=e.ctx,a.staticCtx=e.staticCtx,a.ponmCtxConfig=e;var i,j;j=a.$eval(c.ponmComments||"{}"),i=angular.extend({},g,j),a.comment={commentLimit:i.commentLimit,limit:i.commentLimit||a.comments&&a.comments.length},a.$watch("comments",function(b){a.comment.limit=a.comment.commentLimit||b&&b.length}),a.$on("replyCommentEvent",function(b,c){b.preventDefault(),b.stopPropagation(),a.comment=a.comment||{},a.comment.placeholder="回复 "+c.name,a.commentContent="@"+c.name+" "}),a.createComment=function(b){var c=d.defer();return b?f.save({type:i.type,entity_id:a.entityId(a),content:b},function(b){b=b||{},"OK"==b.status?(a.comments.splice(0,0,b.comment),h(),c.resolve(!1)):c.resolve(b.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}):c.resolve(!1),c.promise}}}}]),angular.module("ponmApp.directives").directive("ponmMapControls",["$window","$animate","$log","param","$q",function(a,b,c,d,e){return{restrict:"EA",scope:{map:"=ponmMap",mapService:"=ponmMapService",mapEventListener:"=ponmMapEventListener"},templateUrl:"views/ponmMapControls.html",link:function(a){a.selected=void 0,a.states=[],a.getLocation=function(b){var c=e.defer();return a.mapService.getLocPois(b,function(a){c.resolve(a)}),c.promise.then(function(a){return a})},a.goLocation=function(b){var c=b.location;c&&(a.mapEventListener.setCenter(a.map,c.lat,c.lng),a.mapEventListener.setZoom(a.map,b.zoom))}}}}]),angular.module("ponmApp.directives").directive("ponmPhotoContainer",["$window","$parse","$animate","$log","$q",function(a,b,c,d,e){function f(a,b){this.image=a,this.maxSize=b}return f.prototype.loadPhotosphere=function(a){if(a.innerHTML="wait...",this.defer=e.defer(),this.holder=a,this.canUseCanvas()){var b=this;this.canDoWebGL(),this.loadEXIF(function(){b.cropImage()})}else a.innerHTML="<div style='width:100%;height:100%;overflow-x:scroll;overflow-y:hidden'><div style='margin: 10px; background: #ddd; opacity: 0.6; width: 300px; height: 20px; padding: 4px; position: relative'>If you upgrade to a better browser this is 3D!</div><img style='height:100%;margin-top: -48px' src='"+this.image+"' /></div>";return this.defer.promise},f.prototype.canUseCanvas=function(){var a=document.createElement("canvas"),b=a.getContext&&a.getContext("2d");return!!b},f.prototype.cropImage=function(){function a(a){var c=document.createElement("canvas");if(c.width=b.exif.full_width,c.height=b.exif.full_height,void 0!=b.maxSize&&(b.maxSize<c.width||b.maxSize<c.height)){var d=b.maxSize/c.width,e=b.maxSize/c.height;d*c.height<b.maxSize?(c.height=Math.ceil(d*c.height),c.width=b.maxSize):(c.width=Math.ceil(e*c.width),c.height=b.maxSize)}var f=c.getContext("2d");return f.fillStyle="#000",f.fillRect(0,0,c.width,c.height),f.drawImage(a,b.exif.x/b.exif.full_width*c.width,b.exif.y/b.exif.full_height*c.height,b.exif.crop_width/b.exif.full_width*c.width,b.exif.crop_height/b.exif.full_height*c.height),c.toDataURL("image/png")}var b=this;if(b.exif&&(b.exif.crop_width!=b.exif.full_width||b.maxSize&&(b.maxSize<b.exif.full_width||b.maxSize<b.exif.full_height)))if(this.image instanceof Image)b.start3D(a(this.image));else{var c=new Image;c.crossOrigin="anonymous",c.onload=function(){b.start3D(a(c))},c.src=this.image}else if(this.image instanceof Image)b.start3D(a(this.image));else{var c=new Image;c.crossOrigin="anonymous",c.onload=function(){b.start3D(c)},c.src=this.image}},f.prototype.canDoWebGL=function(){var a,b,c;if(void 0===this.isCanDoWebGL){try{a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl"),c=b.getSupportedExtensions(),this.maxSize=b.getParameter(b.MAX_TEXTURE_SIZE)}catch(d){return!1}this.isCanDoWebGL=!!b}return this.isCanDoWebGL},f.prototype.start3D=function(a){void 0==window.THREE&&alert("Please make sure three.js is loaded"),this.target=new THREE.Vector3,this.lat=0,this.lon=90,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.isUserInteracting=!1,this.onMouseDownLon=0,this.onMouseDownLat=0,this.camera=new THREE.PerspectiveCamera(75,parseInt(this.holder.innerWidth())/parseInt(this.holder.innerHeight()),1,1100),this.scene=new THREE.Scene;var b=new THREE.Mesh(new THREE.SphereGeometry(200,20,40),this.loadTexture(a));if(b.scale.x=-1,this.scene.add(b),this.canDoWebGL())try{this.renderer=new THREE.WebGLRenderer}catch(c){this.renderer=new THREE.CanvasRenderer}else this.renderer=new THREE.CanvasRenderer;this.renderer.setSize(parseInt(this.holder.innerWidth()),parseInt(this.holder.innerHeight())),this.holder.innerHTML="",this.holder.append(this.renderer.domElement),this.defer.resolve();var d=this;this.renderer.domElement.addEventListener("touchstart",function(a){d.onDocumentTouchStart(a,d)},!1),this.renderer.domElement.addEventListener("touchmove",function(a){d.onDocumentTouchMove(a,d)},!1),this.renderer.domElement.addEventListener("mousedown",function(a){d.onDocumentMouseDown(a,d)},!1),jQuery(this.renderer.domElement).mousewheel(function(a){d.onMouseWheel(a,d)}),document.addEventListener("mousemove",function(a){d.onDocumentMouseMove(a,d)},!1),document.addEventListener("mouseup",function(a){d.onDocumentMouseUp(a,d)},!1),this.restart()},f.prototype.restart=function(){this.resetTimer(this);var a=this;this.stopTimer=setTimeout(function(){a.stop()},3e3)},f.prototype.stop=function(){void 0!=this.timer&&clearTimeout(this.timer),void 0!=this.interval&&clearInterval(this.interval),void 0!=this.stopTimer&&clearTimeout(this.stopTimer)},f.prototype.startMoving=function(){var a=this;this.interval=setInterval(function(){a.lon=a.lon-.1,-3<a.lat&&a.lat<3||(a.lat>10?a.lat-=.1:a.lat>0?a.lat-=.04:a.lat<0&&a.lat>10?a.lat+=.1:a.lat<0&&(a.lat+=.04)),a.render()},10)},f.prototype.resetTimer=function(a){void 0!=a.timer&&clearTimeout(a.timer),void 0!=a.interval&&clearInterval(a.interval),a.startMoving()},f.prototype.onWindowResize=function(a){a=a||this,a.camera.aspect=parseInt(a.holder.innerWidth())/parseInt(a.holder.innerHeight()),a.camera.updateProjectionMatrix(),a.renderer.setSize(parseInt(a.holder.innerWidth()),parseInt(a.holder.innerHeight())),a.render()},f.prototype.onMouseWheel=function(a,b){var c=b.camera.fov-3*(a.wheelDeltaY||a.detail||a.deltaY);c>10&&100>c&&(b.camera.fov=c,b.camera.updateProjectionMatrix(),b.render(),a.preventDefault())},f.prototype.onDocumentMouseDown=function(a,b){a.preventDefault(),b.isUserInteracting=!0,b.onPointerDownPointerX=a.clientX,b.onPointerDownPointerY=a.clientY,b.onPointerDownLon=b.lon,b.onPointerDownLat=b.lat,b.stop()},f.prototype.onDocumentMouseMove=function(a,b){b.isUserInteracting&&(b.lon=.1*(b.onPointerDownPointerX-a.clientX)+b.onPointerDownLon,b.lat=.1*(a.clientY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.stop())},f.prototype.onDocumentTouchStart=function(a,b){1==a.touches.length&&(a.preventDefault(),b.onPointerDownPointerX=a.touches[0].pageX,b.onPointerDownPointerY=a.touches[0].pageY,b.onPointerDownLon=lon,b.onPointerDownLat=lat)},f.prototype.onDocumentTouchMove=function(a,b){1==a.touches.length&&(a.preventDefault(),b.lon=.1*(b.onPointerDownPointerX-a.touches[0].pageX)+b.onPointerDownLon,b.lat=.1*(a.touches[0].pageY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.stop())},f.prototype.onDocumentMouseUp=function(a,b){b.isUserInteracting=!1,b.render()},f.prototype.loadTexture=function(a){var b=new THREE.Texture,c=new THREE.MeshBasicMaterial({map:b,overdraw:!0}),d=this;return a instanceof Image?(b.needsUpdate=!0,c.map.image=a,setTimeout(function(){d.render()},100)):(b.needsUpdate=!0,THREE.ImageUtils.crossOrigin="anonymous",c.map=THREE.ImageUtils.loadTexture(a),setTimeout(function(){d.render()},100)),c},f.prototype.render=function(){this.lat=Math.max(-85,Math.min(85,this.lat));var a=(90-this.lat)*Math.PI/180,b=this.lon*Math.PI/180;this.target.x=500*Math.sin(a)*Math.cos(b),this.target.y=500*Math.cos(a),this.target.z=500*Math.sin(a)*Math.sin(b),this.camera.lookAt(this.target),this.renderer.render(this.scene,this.camera)},f.prototype.setEXIF=function(a){return this.exif=a,this},f.prototype.loadEXIF=function(a){if(void 0!=this.exif)return void a();var b=this;this.loadBinary(function(c){var d="</x:xmpmeta>",e=c.substring(c.indexOf("<x:xmpmeta"),c.indexOf(d)+d.length),f=function(a){var b=e.indexOf(a+'="')+a.length+2;return e.substring(b,e.indexOf('"',b))};b.exif={full_width:f("GPano:FullPanoWidthPixels"),full_height:f("GPano:FullPanoHeightPixels"),crop_width:f("GPano:CroppedAreaImageWidthPixels"),crop_height:f("GPano:CroppedAreaImageHeightPixels"),x:f("GPano:CroppedAreaLeftPixels"),y:f("GPano:CroppedAreaTopPixels")},console.log(b.exif),a()})},{restrict:"EA",templateUrl:"views/ponmPhotoContainer.html",link:function(b,e,g){function h(){var a=v.find(".flat-canvas");a.on("dblclick",function(){k()});var c;a.on("mousedown",function(){c=!0}),$(document).on("mousemove",function(){c=!1}),a.on("click",function(){c&&b.$emit("image.click")})}function i(a){d.debug("changeP360: "+a),angular.isString(a)&&(a=angular.lowercase(a),a="true"==a),a?(c.addClass(v,"p360"),p(x)):q(x)}function j(a){H=angular.element(a).panzoom({$zoomIn:e.parent().find(".zoom-in"),$zoomOut:e.parent().find(".zoom-out"),$zoomRange:e.parent().find(".zoom-range"),$reset:e.parent().find(".reset"),transition:!0,disablePan:!0}),H.parent().on("mousewheel.focal",function(a){a.preventDefault();var b=a.delta||a.originalEvent.wheelDelta,c=b?0>b:a.originalEvent.deltaY>0;H.panzoom("zoom",c,{increment:.1,animate:!0,focal:a})}),H.on("panzoomzoom",function(a,b,c){1>c?(H.panzoom("resetZoom"),H.panzoom("resetPan"),H.panzoom("option","disablePan",!0)):Math.abs(c-1)<.05?(1!=c&&(H.panzoom("resetZoom"),H.panzoom("option","disablePan",!0)),H.panzoom("resetPan")):H.panzoom("option","disablePan",!1)})}function k(){H.panzoom("reset"),H.panzoom("option","disablePan",!0)}function l(){if(D=g.ponmPhotoSrc,C=1,E="",F=!1,G="",b.imagePercentComplete=0,b.photo&&(F=b.photo.is360,F&&(G=b.corsproxyCtx+"/"+b.photo.oss_key+"@0e_2000w_1000h.jpg"),E=b.staticCtx+"/"+b.photo.oss_key+"@!photo-preview-sm",b.photo.width&&(C=b.photo.height/b.photo.width)),!D)return void c.addClass(u,"ponm-hide");if(v&&(v.find(".flat-canvas").empty(),i(F),q(w),c.removeClass(u,"ponm-hide")),D){s=new Image,s.onload=function(){o(),p(v)},E&&(s.photoLazy=!0,s.src=E),m(G||D,s).then(function(a){a==(G||D)&&(s.photoLazy=!1,s.src=a,c.addClass(u,"ponm-hide"))});var a=v.find(".flat-canvas");a.append(s),a.on("dblclick",function(){k()}),j(v.find(".flat-canvas")),k()}}function m(a){var c=jQuery.Deferred(),d=new XMLHttpRequest;
return d.onprogress=function(a){if(a.lengthComputable){var c=a.loaded/a.total*100;b.imagePercentComplete=c}},d.onreadystatechange=function(){4==d.readyState&&200==d.status&&setTimeout(function(){c.resolve(a)},500)},d.open("GET",a,!0),d.send(),c.promise()}function n(){var a=angular.element(s);if(a.css("height","initial"),a.css("width","initial"),s.photoLazy){{a.outerWidth(),a.outerHeight()}C>B/A?a.css("height","100%"):a.css("width","100%")}}function o(){A=e.innerWidth(),B=e.innerHeight(),t.css("line-height",B+"px"),n()}function p(a){c.addClass(a,"ponm-show")}function q(a){c.removeClass(a,"ponm-show")}function r(){q(v),p(w),w.find("canvas").length&&x.ponmPhotoSrcL==G?(p(w),z.restart()):(x.ponmPhotoSrcL=G,w.find(".p360-canvas").empty(),c.removeClass(u,"ponm-hide"),z=new f(G).setEXIF({full_width:g.ponmPhotoWidth,full_height:g.ponmPhotoHeight,crop_width:g.ponmPhotoWidth,crop_height:g.ponmPhotoHeight,x:0,y:0}),z.loadPhotosphere(w.find(".p360-canvas")).then(function(){c.addClass(u,"ponm-hide")}))}var s=null,t=e.find(".ponm-photo-container"),u=e.find(".loading"),v=e.find(".flat-image"),w=e.find(".p360-image"),x=e.find(".flat-image .image-button"),y=e.find(".p360-image .image-button"),z=null;h(),x.on("click",function(a){a.preventDefault(),r()}),y.on("click",function(a){a.preventDefault(),q(w),p(v),z.stop()}),e.css("width","100%"),e.css("height","100%"),e.css("background-color",g.ponmPhotoColor);var A=e.innerWidth(),B=e.innerHeight();g.$observe("ponmPhotoSrc",function(a){angular.isDefined(a)&&l()});var C,D,E,F,G,H=null;angular.element(a).resize(function(){o(),z&&z.onWindowResize()})}}}]),angular.module("ponmApp.directives").directive("ponmRectMultiSelect",["$log","$parse","safeApply",function(a,b,c){var d={selector:".photo",moveselect:!0};return{restrict:"A",link:function(a,e,f){function g(a){if(n){a.preventDefault();var b=a.pageX-r,c=a.pageY-s,d=Math.abs(l-b),e=Math.abs(m-c);10>d&&10>e||(o.css({width:d,height:e}),l>=b&&c>=m?o.css({left:b}):m>=c&&b>=l?o.css({top:c}):m>c&&l>b&&o.css({left:b,top:c}),j.moveselect&&h(a))}}function h(a){var d=(new Array,b(f.ponmRectSelector||"selected").assign);angular.forEach(e.find(j.selector),function(b){b=angular.element(b);var e=b.scope(),f=i(o,b);if(1==f){return void c(e,function(){d(e,!0)})}else a.shiftKey||c(e,function(){d(e,!1)})})}function i(a,b){var c=a.offset().top,d=a.offset().left,e=b.offset().top,f=b.offset().left;return!(c+a.outerHeight()<e||c>e+b.outerHeight()||d+a.outerWidth()<f||d>f+b.outerWidth())}var j,k=a.$eval(f.ponmRectMultiSelect||"{}");j=angular.extend({},d,k);var l=0,m=0,n=!1,o=angular.element('<div class="ghost-select"><span></span></div>'),p=angular.element('<div id="grid"></div>').append(o);e.prepend(p);var q=angular.element("<div id='big-ghost' class='big-ghost'></div>");e.append(q);var r=0,s=0;e.bind("mousedown",function(a){r=e.offset().left,s=e.offset().top;var b=a.pageX-r,c=a.pageY-s;q.removeClass("ponm-show"),o.addClass("ponm-show"),o.css({left:b,top:c}),l=b,m=c,n=!0}),$(document).bind("mousemove",g),$(document).bind("mouseup",function(a){if(n){n=!1;var b=Math.abs(l-a.pageX+r),c=Math.abs(m-a.pageY+s);10>b&&10>c||(h(a),o.removeClass("ponm-show"),o.width(0).height(0))}})}}}]),angular.module("ponmApp.directives").directive("repeatComplete",["$rootScope",function(a){function b(b,d){var e=++c;b.attr("repeat-complete-id",e),b.removeAttr("repeat-complete");var f=d.repeatComplete,g=b.parent(),h=g.scope()||a,i=h.$watch(function(){console.info("Digest running.");var a=g.children("*[ repeat-complete-id = '"+e+"' ]:last");if(a.length){var b=a.scope();b.$last&&(i(),b.$eval(f))}})}var c=0;return{compile:b,priority:1001,restrict:"A"}}]),angular.module("ponmApp.directives").directive("itemPicker",["$parse","$log","jsUtils",function(a,b,c){return{restrict:"EA",transclude:!0,require:"ngModel",scope:{loadData:"&",newData:"&",itemValueName:"@"},templateUrl:"views/tagPickerView.html",link:function(a,d,e,f){function g(){if(a.loadData){var c;(c=a.loadData())?(a.loading=!0,c().then(function(b){k=b,h(),a.loading=!1},function(){a.loading=!1})):b.error("load-data function "+e.loadData+" is not defined!")}else b.error("load-data attribute is not defined!")}function h(){a.items=[],angular.forEach(k,function(a,b){i(a,b)})}function i(b,c){return angular.isObject(b)?a.items.push({value:b[a.itemValueName],id:b.id,$key:c}):angular.isString(b)?a.items.push({value:b,$key:c}):void 0}var j=a.$eval(e.options||"{}");a.itemValueName=a.itemValueName||"value",a.placeHolder=e.placeHolder;var k=null;a.selectedItems=[];var l=d.find("div.dropdown-toggle");l.on("focus click",function(){k||(g(),a.$apply(function(){return a.items}))}),d.find(".dropdown-menu").on("click",function(a){a.preventDefault(),a.stopPropagation()}),a.setItem=function(b){var c=[];if(a.multipleSelect)a.selectedItems=[],b.$active=!b.$active,angular.forEach(a.items,function(b){b.$active&&(a.selectedItems.push(b),c.push(k[b.$key]))});else{if(b.$active)return;angular.forEach(a.items,function(a){a.$active=!1}),b.$active=!0,a.selectedItems=[b],c=k[b.$key]}a.originalItemValue=a.item,f.$setViewValue(c)},a.clearItems=function(){a.originalItemValue="",a.item="",a.items=null},a.createData=function(b){b&&(j.duplicate||!c.Array.containKeys(a.items,"value",b))&&a.newData&&(a.loading=!0,a.newData()(b).then(function(b){a.loading=!1;var c=k.push(b);a.newItem="",c=i(b,c-1),a.setItem(a.items[c-1])},function(){a.loading=!1}))},a.newItemValidate=function(b){var d={errorKey:"duplicate",isValid:!0};return b?(!j.duplicate&&c.Array.containKeys(a.items,"value",b)&&(d.isValid=!1),d):d},a.multipleSelect=void 0===e.multipleSelect||"false"===e.multipleSelect?!1:!0}}}]).directive("contenteditable",["$parse",function(){return{require:"ngModel",scope:{ngModel:"@"},link:function(a,b,c,d){function e(){b.css("color","grey"),b.html(b.placeholder)}function f(){b.css("color",""),b.html("")}b.placeholder=c.placeHolder,b.css("cursor","pointer"),b.on("blur",function(){c.multipleLine?(b.css("overflow","hidden"),a.$apply(function(){if(b.placeholder!=b.html()){var a="",c=b.contents();angular.forEach(c,function(b){b instanceof String?(a&&(a+="\n"),a+=b):""!=b.textContent&&(a&&(a+="\n"),a+=b.textContent)}),d.$setViewValue(a)}d.$render()})):a.$apply(function(){b.placeholder!=b.html()&&d.$setViewValue(b.html()),d.$render()})}),b.on("focus",function(){a.$apply(function(){b.placeholder==b.html()&&f()}),c.multipleLine}),d.$render=function(){d.$viewValue?b.html(d.$viewValue):e()},d.$render(),c.editable&&!a.$eval(c.editable)&&(b.on("input",function(a){b.html(d.$viewValue),a.preventDefault(),a.stopPropagation()}),b.on("keypress keydown keyup onchange",function(a){a.preventDefault(),a.stopPropagation()})),c.multipleLine||b.on("keypress",function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation())}),b.on("mouseenter",function(){d.$render(),a.$apply(function(){a.mouseEnter=!0})}),b.on("mouseleave",function(){a.$apply(function(){a.mouseEnter=!1})})}}}]),angular.module("ponmApp.directives").directive("userCard",["$log","$document","$http","$compile","$timeout","safeApply","UserService",function(a,b,c,d,e,f,g){var h="views/user-card.html",i={delay:500,removeDelay:100};return{restrict:"A",scope:{userId:"=userId",owner:"=owner"},link:function(a,f,j){function k(b){g.getOpenInfo({userId:b},function(b){"OK"==b.status&&(a.user=b.open_info)})}var l,m;m=a.$eval(j.userCard||"{}"),l=angular.extend({},i,m);var n,o;c.get(h).then(function(a){o=a.data});var p,q,r,s,t=10,u=10;f.on("mouseenter",function(){q=!0,s&&(e.cancel(s),s=null)}),f.on("mousemove",function(c){p&&(e.cancel(p),p=null),q&&!n&&(p=e(function(){!a.user&&a.userId&&k(a.userId),n=d(o)(a),b.find("body").append(n),n.css("top",c.clientY+u).css("left",c.clientX+t),n.on("mouseenter",function(){r=!0,s&&(e.cancel(s),s=null)}),n.on("mouseleave",function(){r=!1,s||(s=e(function(){n.remove(),n=null},l.removeDelay),s.then(function(){s=null}))})},l.delay),p.then(function(){p=null}))}),f.on("mouseout",function(){n&&!r&&(s||(s=e(function(){n.remove(),n=null},l.removeDelay),s.then(function(){s=null}))),p&&(e.cancel(p),p=null),q=!1}),a.$on("$destroy",function(){n&&(n.remove(),n=null)})}}}]),angular.module("ponmApp.directives").directive("waypoint",["$log","$timeout","$parse","safeApply",function(a,b,c,d){var e={stuckClass:"stuck",direction:"down right"};return{restrict:"A",link:function(a,f,g){var h,i=a.$eval(g.waypoint||"{}");h=angular.extend({},$.fn.waypoint.defaults,e,i);var j=c(g.onWaypoint);b(function(){$(f).waypoint(function(b){j&&d(a,function(){j(a,{$direction:b,$element:f})}),a.$emit("waypointEvent",b,i.target)},h)},500),g.$observe("waypointRefresh",function(){$.waypoints("refresh")}),g.$observe("waypointEnable",function(a){$(f).waypoint(a&&"true"==a?"enable":"disable")})}}}]).directive("waypointSticky",["$log","$timeout",function(a,b){var c={wrapper:'<div class="sticky-wrapper" />',stuckClass:"stuck",direction:"down right"},d=function(a,b){var c;return a.wrap(b.wrapper),c=a.parent(),c.data("isWaypointStickyWrapper",!0)};return{restrict:"A",link:function(e,f,g){a.debug("waypoint sticky...");var h,i,j,k,l;k=e.$eval(g.waypointSticky||"{}"),i=$.extend({},$.fn.waypoint.defaults,c,k),h=d(f,i),j=i.handler,l=$(f),i.handler=function(a){var b;return b=-1!==i.direction.indexOf(a),h.height(b?l.outerHeight():""),l.toggleClass(i.stuckClass,b),null!=j?j.call(f,a):void 0},b(function(){h.waypoint(i),l.data("stuckClass",i.stuckClass)},1e3),e.$on("waypoint-refresh",function(){$.waypoints("refresh")}),g.$observe("waypointEnable",function(a){l.waypoint(a&&"true"==a?"enable":"disable")})}}}]).directive("waypointInfinite",["$log","$timeout",function(a){var b;return b={container:"auto",offset:"bottom-in-view",loadingClass:"infinite-loading",onBeforePageLoad:$.noop},{restrict:"A",link:function(c,d,e){a.debug("waypoint infinite...");var f,g,h;h=c.$eval(e.waypointInfinite||"{}"),g=$.extend({},$.fn.waypoint.defaults,b,h),f="auto"===g.container?d:angular.element(g.container),g.handler=function(a){"down"===a||"right"===a?(c[g.onBeforePageLoad]().then(function(){f.removeClass(g.loadingClass),$.waypoints("refresh")}),f.addClass(g.loadingClass)):($.waypoints("refresh"),$.waypoints("viewportHeight"))},$(d).waypoint(g),e.$observe("waypointDisable",function(a){a&&"true"==a&&$(d).waypoint("destroy")})}}}]),angular.module("ponmApp.services",["ngCookies","ngResource"]).factory("AuthService",["$window","$resource","$cookies","$log","$q","ponmCtxConfig","SettingsService",function(a,b,c,d,e,f,g){function h(a){var b=e.defer();return k.save({type:"check"},{username:a.username,password:a.password},function(a){"OK"==a.status&&b.resolve()},function(a){d.debug(a.data),b.reject(1)}),b.promise}function i(a){var b=e.defer();return l.save({username:a.username,password:a.password}),b.promise}function j(){var a=e.defer();return f.login&&f.userId?a.resolve():k.get({},function(b){"OK"==b.status?(f.userId=b.user.id,f.id=b.user.id,f.username=b.user.username,f.name=b.user.name,f.avatar=b.user.avatar,f.login=!0,d.debug(b.user),a.resolve(),g.get({userId:f.userId},function(a){"OK"==a.status&&(f.settings.autoUpload=a.settings.auto_upload)})):"NO_AUTHORIZE"==b.status&&a.reject(1)}),a.promise}var k=b(f.apirest+"/auth/login/:type"),l=b(f.ctx+"/login/j_spring_security_check");return{loginCheck:h,login:i,checkLogin:j}}]).factory("CommentService",["$window","$resource",function(a,b){return b(a.apirest+"/comment/:commentId/:type",{commentId:"@id"},{modify:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}},like:{method:"GET",params:{type:"like"}},unLike:{method:"DELETE",params:{type:"like"}}})}]).factory("UserPhoto",["$window","$resource",function(a,b){return b(a.apirest+"/user/:userId/photos/:type/:tag/:pageSize/:pageNo",{userId:"@id"},{query:{method:"GET",isArray:!0},getByTag:{method:"GET",params:{type:"tag"}},getBounds:{method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}}})}]).factory("UserService",["$window","$resource",function(a,b){return b(a.apirest+"/user/:userId/:type/:value/:action",{userId:"@id"},{getMe:{method:"GET"},getOpenInfo:{method:"GET",params:{type:"openinfo"}},getSettings:{method:"GET",params:{type:"settings"}},updateSettings:{method:"POST",params:{type:"settings"}},getTravels:{method:"GET",params:{type:"travel"}},getTags:{method:"GET",params:{type:"tag"}},createTag:{method:"GET",params:{type:"tag"}},getRecycleBin:{method:"GET",params:{type:"recycle"}},emptyRecycleBin:{method:"DELETE",params:{type:"recycle"}},removeRecycle:{method:"DELETE",params:{type:"recycle"}},cancelRecycle:{method:"GET",params:{type:"recycle",action:"cancel"}},getMessages:{method:"GET",params:{type:"messages"}},getMyMessages:{method:"GET",params:{type:"mymessages"}},getFollowers:{method:"GET",params:{type:"follower"}},following:{method:"POST",params:{type:"following"}},unFollowing:{method:"DELETE",params:{type:"following"}},getCircles:{method:"GET",params:{type:"circle"}},getFollowSuggested:{method:"GET",params:{type:"follow",value:"suggested"}},getFollowInterested:{method:"GET",params:{type:"follow",value:"interested"}}})}]).factory("SettingsService",["$window","$resource",function(a,b){return b(a.apirest+"/settings/:userId/:type",{userId:"@id"},{changeMapVendor:{method:"POST",params:{type:"map"}},changePassword:{method:"POST",params:{type:"password"}},changeAccount:{method:"POST",params:{type:"account"}},changeUpload:{method:"POST",params:{type:"upload"}}})}]).factory("PhotoService",["$window","$resource",function(a,b){return b(a.apirest+"/photo/:photoId/:type/:pageSize/:pageNo",{photoId:"@id"},{getCameraInfo:{method:"GET",params:{type:"camerainfo"}},"delete":{method:"DELETE"},tag:{method:"POST",params:{type:"tag"}},updateProperties:{method:"POST",params:{type:"properties"}},getPhoto:{method:"GET"},getGPSInfo:{method:"GET",params:{type:"gps"}},favorite:{method:"PUT",params:{type:"favorite"}},removeFavorite:{method:"DELETE",params:{type:"favorite"}},getComments:{method:"GET",params:{type:"comment"}},like:{method:"GET",params:{type:"like"}},unLike:{method:"DELETE",params:{type:"like"}}})}]).service("GPSConvertService",["$window","$resource",function(a,b){return b(a.apirest+"/gps",{},{convert:{method:"GET",headers:{Accept:"application/json"}}})}]).service("AvatarService",["$window","$resource",function(a,b){return b(a.apirest+"/user/avatar",{},{upload:{method:"POST",headers:{"Content-Type":!1,Accept:"application/json"}}})}]).factory("TravelService",["$window","$resource",function(a,b){return b(a.apirest+"/travel/:travelId/:type/:typeId/:action",{travelId:"@id"},{create:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}},addPhoto:{method:"POST",params:{type:"photo"},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}},getTravel:{method:"GET",headers:{Accept:"application/json"}},changeTravel:{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"}},getSpot:{method:"GET",params:{type:"spot"}},changeSpot:{method:"POST",params:{type:"spot"},headers:{"Content-Type":"application/json",Accept:"application/json"}},createSpot:{method:"POST",params:{type:"spot"}},addSpotPhoto:{method:"POST",params:{type:"spot",action:"photo"},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}},changeSpotPhotoPosition:{method:"POST",params:{type:"spot",action:"position"}},deleteSpot:{method:"DELETE",params:{type:"spot"}},deletePhoto:{method:"DELETE",params:{type:"photo"},headers:{Accept:"application/json"}},like:{method:"GET",params:{type:"like"}},unLike:{method:"DELETE",params:{type:"like"}}})}]).factory("PanoramioService",["$window","$resource",function(a,b){return b(a.apirest+"/panoramio/:action",{id:"@id"},{getLatest:{method:"GET",params:{action:"photo",latest:!0},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}},search:{method:"GET",params:{action:"search",type:"all"},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json"}}})}]).factory("MessageService",["ponmCtxConfig","$resource",function(a,b){return b(a.apirest+"/message/:id/:type/:value",{id:"@id"},{like:{method:"GET",params:{type:"like"}},unLike:{method:"DELETE",params:{type:"like"}},share:{method:"POST",params:{type:"share"}}})}]).factory("RecycleService",["ponmCtxConfig","$resource",function(a,b){return b(a.apirest+"/recycle/:id/:type/:value",{id:"@id"},{cancel:{method:"GET",params:{type:"cancel"}}})}]).service("LoginUserService",["$window","$resource","$rootScope",function(a,b,c){this.getUserId=function(){return c.user.id}}]).factory("safeApply",["$rootScope",function(){return function(a,b){var c=a.$root&&a.$root.$$phase;"$apply"==c||"$digest"==c?b&&a.$eval(b):b?a.$apply(b):a.$apply()}}]).factory("ponmCtxConfig",["$window","$resource",function(a){return{ctx:a.ctx,staticCtx:a.staticCtx||"http://static.photoshows.cn",corsproxyCtx:a.corsproxyCtx||"http://www.corsproxy.com/static.photoshows.cn",apirest:a.apirest,userId:a.user&&a.user.id,name:a.user&&a.user.name,login:a.login,mapVendor:a.mapVendor,getCoordSS:function(a){return a||(a=this.mapVendor),"qq"==a?"gaode":a},dev:a.dev,settings:{autoUpload:!1}}}]),angular.module("ponmApp.services").factory("GeocodeService",["$window","$http","$q",function(a,b,c){var d={"国家":3,"省":7,"市":9,"区县":11,"乡镇":13,"村庄":16,"热点商圈":16,"小区":18,"兴趣点":18,"门牌号":19,"道路":17,"道路交叉路口":18,"公交站台、地铁站":18};return{levelMap:d,geo:function(a,c){return b.get("http://restapi.amap.com/v3/geocode/geo",{params:{address:a,key:"feb4691f59f30a28499c2a6197ba2773"},headers:{"Access-Control-Allow-Headers":"Content-Type, X-Requested-With","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Origin":"*"}}).then(function(b){"200"==b.status&&b.data&&"OK"==b.data.info&&(angular.forEach(b.data.geocodes,function(a){d[a.level]&&(a.zoom=d[a.level])}),c.apply(void 0,[b.data.geocodes,a]))})},regeo:function(a,c,d){var e="",f=!1;angular.isArray(a)?(f=!0,angular.forEach(a,function(a){var b=a.lng+","+a.lat;e=e?e+"|"+b:b})):angular.isObject(a)&&(e=a.lng+","+a.lat),b.get("http://restapi.amap.com/v3/geocode/regeo",{params:{location:e,batch:f,extensions:d?"all":"base",key:"feb4691f59f30a28499c2a6197ba2773"},headers:{"Access-Control-Allow-Headers":"Content-Type, X-Requested-With","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Origin":"*"}}).then(function(a){"200"==a.status&&a.data&&"OK"==a.data.info&&(f?c.apply(void 0,[a.data.regeocodes]):c.apply(void 0,[a.data.regeocode]))})},regeoAddresses:function(a,b){var d=c.defer();return this.regeo({lat:a,lng:b},function(a){var b={},c=a.addressComponent.province+a.addressComponent.district+a.addressComponent.city+a.addressComponent.township;angular.forEach(a.pois,function(a){b[c+a.name]={poiweight:a.poiweight,location:a.location}}),d.resolve({address:a.formatted_address,addresses:b})},"all"),d.promise}}}]),angular.module("ponmApp.services").factory("HashStateManager",["$window","$timeout","jsUtils",function(a,b,c){var d=function(a,b){this.scope=a,this.location=b,this.scope.hashStateObj={},this.hashStateCache={},this.initialized=!1;var d=this;a.$watch(function(){return b.hash()},function(a){d.initialized=!0,d.scope.hashStateObj=c.deparam(a)})};return d.prototype.watch=function(a,b){var c=a.split(" "),d=this;angular.forEach(c,function(a){d.scope.$watch("hashStateObj."+a,function(c){d.hashStateCache[a]!=c&&(b.apply(null,[c]),d.hashStateCache[a]=c)})})},d.prototype.bindingWatch=function(a,c){var d,e=a.split(" "),f=this;angular.forEach(e,function(a){f.scope.$watch("hashStateObj."+a,function(g){f.hashStateCache[a]!=g&&(d&&b.cancel(d),d=b(function(){var a=[];angular.forEach(e,function(b){a.push(f.get(b))}),c.apply(null,a)},0),f.hashStateCache[a]=g)})})},d.prototype.get=function(a){return this.scope.hashStateObj[a]},d.prototype.set=function(a,b){var d=this;angular.isObject(a)?angular.forEach(a,function(a,b){a?d.hashStateCache[b]=a:delete d.hashStateCache[b]}):b?this.hashStateCache[a]=b:delete this.hashStateCache[a],this.initialized&&this.location.hash(c.param(this.hashStateCache))},d.prototype.clear=function(){this.location.hash("")},d}]),angular.module("ponmApp.services").factory("alertService",["$window","$rootScope","$timeout","jsUtils",function(a,b,c){var d;return d={options:{ttl:3e3},add:function(a,b,d){var e=this,f={type:a,message:b,close:function(){return e.closeAlert(this)}};(d&&d.alone||this.options.alone)&&this.clear();var g=d&&d.ttl||this.options.ttl;return g&&(f.timeoutPromise=c(function(){f.close()},g)),this.alerts.push(f),f},closeAlert:function(a){return this.closeAlertIdx(this.alerts.indexOf(a))},closeAlertIdx:function(a){return this.alerts.splice(a,1)},clear:function(){angular.forEach(this.alerts,function(a){c.cancel(a.timeoutPromise)}),this.alerts=[]},alerts:[]}}]),angular.module("ponmApp.services").service("dialogService",["$window","$rootScope","$modal","jsUtils",function(a,b,c){var d={backdrop:!0,keyboard:!0,modalFade:!0,templateUrl:"views/ponm.dialog.html"},e={closeButtonText:"Close",actionButtonText:"OK",headerText:"Proceed?",bodyText:"Perform this action?"};this.showModal=function(a,b){return a||(a={}),a.backdrop="static",this.show(a,b)},this.show=function(a,b){var f={},g={};return angular.extend(f,d,a),angular.extend(g,e,b),f.controller||(f.controller=["$scope","$modalInstance",function(a,b){a.modalOptions=g,a.modalOptions.ok=function(a){b.close(a)},a.modalOptions.close=function(){b.dismiss("cancel")}}]),c.open(f).result}}]),angular.module("ponmApp.services").factory("jsUtils",["$window",function(){function a(b,c,d,e){var f;if(angular.isArray(c))angular.forEach(c,function(c,f){d||rbracket.test(b)?e(b,c):a(b+"["+("object"==typeof c?f:"")+"]",c,d,e)});else if(d||"object"!==jQuery.type(c))e(b,c);else for(f in c)a(b+"["+f+"]",c[f],d,e)}var b=/%20/g,c=decodeURIComponent;return{Array:{containKeys:function(a,b,c){var d=!1;return angular.forEach(a,function(a){a[b]==c&&(d=!0)}),d},removeItem:function(a,b,c){2==arguments.length&&(c=b,b=null);var d;for(d=a.length-1;d>=0;d-=1)(b&&a[d][b]==c||a[d]==c)&&delete a.splice(d,1)},mergeRightist:function(a,b,c){var d;for(d=a.length-1;d>=0;d-=1){var e=!1;angular.forEach(b,function(b){a[d][c]==b[c]&&(e=!0)}),e||delete a.splice(d,1)}for(d=b.length-1;d>=0;d-=1){var e=!1;angular.forEach(a,function(a){a[c]==b[d][c]&&(e=!0)}),e||a.push(b[d])}return a},append:function(a,b,c){var d;for(d=b.length-1;d>=0;d-=1){var e=!1;angular.forEach(a,function(a){a[c]==b[d][c]&&(e=!0)}),e||a.push(b[d])}return a}},param:function(c,d){var e,f=[],g=function(a,b){b=angular.isFunction(b)?b():null==b?"":b,f[f.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(angular.isArray(c)||c.jquery&&!angular.isObject(c))angular.forEach(c,function(){g(this.name,this.value)});else for(e in c)a(e,c[e],d,g);return f.join("&").replace(b,"+")},deparam:function(a,b){var d={},e={"true":!0,"false":!1,"null":null};return angular.forEach(a.replace(/\+/g," ").split("&"),function(a){var f,g=a.split("="),h=c(g[0]),i=d,j=0,k=h.split("]["),l=k.length-1;if(/\[/.test(k[0])&&/\]$/.test(k[l])?(k[l]=k[l].replace(/\]$/,""),k=k.shift().split("[").concat(k),l=k.length-1):l=0,2===g.length)if(f=c(g[1]),b&&(f=f&&!isNaN(f)?+f:"undefined"===f?void 0:void 0!==e[f]?e[f]:f),l)for(;l>=j;j++)h=""===k[j]?i.length:k[j],i=i[h]=l>j?i[h]||(k[j+1]&&isNaN(k[j+1])?{}:[]):f;else angular.isArray(d[h])?d[h].push(f):d[h]=void 0!==d[h]?[d[h],f]:f;else h&&(d[h]=b?void 0:"")}),d},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}}}]),function(a,b){b.module("ponm.Matchmedia",[]).provider("matchmedia",function(){var a={rules:{print:"print",screen:"screen",phone:"(max-width: 767px)",tablet:"(min-width: 768px) and (max-width: 979px)",desktop:"(min-width: 979px)",portrait:"(orientation: portrait)",landscape:"(orientation: landscape)"}};return a.$get=["$window","safeApply","logger",function(b,c,d){function e(a,b){return function(d){c(b,function(){a(d)})}}d.log("Creating matchmedia");var f={};return f.on=function(a,c,f){d.log("adding listener for query: "+a);var g=b.matchMedia(a),h=e(c,f);return g.addListener(h),h(g),function(){d.log("removing listener from query: "+a),g.removeListener(h)}},f.is=function(a){return d.log("test query: "+a),b.matchMedia(a).matches},f.onPrint=function(b,c){return f.on(a.rules.print,b,c)},f.onScreen=function(b,c){return f.on(a.rules.screen,b,c)},f.onPhone=function(b,c){return f.on(a.rules.phone,b,c)},f.onTablet=function(b,c){return f.on(a.rules.tablet,b,c)},f.onDesktop=function(b,c){return f.on(a.rules.desktop,b,c)},f.onPortrait=function(b,c){return f.on(a.rules.portrait,b,c)},f.onLandscape=function(b,c){return f.on(a.rules.landscape,b,c)},f.isPrint=function(){return f.is(a.rules.print)},f.isScreen=function(){return f.is(a.rules.screen)},f.isPhone=function(){return f.is(a.rules.phone)},f.isTablet=function(){return f.is(a.rules.tablet)},f.isDesktop=function(){return f.is(a.rules.desktop)},f.isPortrait=function(){return f.is(a.rules.portrait)},f.isLandscape=function(){return f.is(a.rules.landscape)},f}],a}).provider("logger",function(){this.DEVMODE=!1,this.setDEVMODE=function(a){this.DEVMODE=a},this.$get=["$window","$log",function(a,b){var c=this.DEVMODE,d={};return d.log=function(){c&&b.info(arguments)},d.always=function(){b.info(arguments)},d}]})}(window,window.angular),angular.module("ponmApp.services").factory("PhotosManager",["$q","UserPhoto",function(a,b){function c(a,b){this.userId=a,this.pageSize=b,this.pageNo=0,this.ended=!1,this.reqStack=[]}return c.prototype.get=function(){},c.prototype.more=function(){var c=a.defer();if(this.ended)return c.reject("ended"),c.promise;if(this.reqStack.length)return c.reject("processing"),c.promise;this.pageNo++,this.reqStack.push(this.pageNo);var d=this;return b.get({userId:this.userId,pageSize:this.pageSize,pageNo:this.pageNo},function(a){if("OK"==a.status){a.photos.length<d.pageSize&&(d.ended=!0);var b=d.reqStack.shift();c.resolve(a.photos,b)}else{var b=d.reqStack.shift();c.reject(a.status,b)}},function(a){var b=d.reqStack.shift();c.reject(a.data,b)}),c.promise},c}]),angular.module("ponmApp.services").factory("rgbHex",["$q",function(){function a(a){return!isNaN(parseFloat(a))&&isFinite(a)}function b(a){return a.replace(/^\s+|\s+$/g,"")}function c(c){return angular.isString(c)&&(c=b(c)),a(c)&&c>=0&&255>=c}function d(a){return/^[0-9a-f]{3}$|^[0-9a-f]{6}$/i.test(b(a))}function e(a){return a=parseInt(a,10).toString(16),1===a.length?"0"+a:a}function f(a){return parseInt(a,16).toString()}function g(b){return angular.isArray(b)||(b=b.split(",")),(3===b.length||4===b.length)&&c(b[0])&&c(b[1])&&c(b[2])&&(4!==b.length||a(b[3]))?"#"+e(b[0]).toUpperCase()+e(b[1]).toUpperCase()+e(b[2]).toUpperCase():null}function h(a){return d(a)?(3===a.length&&(a=a.charAt(0)+a.charAt(0)+a.charAt(1)+a.charAt(1)+a.charAt(2)+a.charAt(2)),"rgb("+f(a.substr(0,2))+","+f(a.substr(2,2))+","+f(a.substr(4,2))+")"):void 0}function i(a){return a.replace(/\s/g,"")}return function(a){if(!a)return null;var c=null,d=/^rgba?\((.*)\);?$/,e=/^#/;return angular.isArray(a)?g(a):(a=b(a.toString()),"transparent"===a||"rgba(0,0,0,0)"===i(a)?"transparent":d.test(a)?g(a.match(d)[1]):e.test(a)?h(a.split("#").reverse()[0]):(c=a.split(","),1===c.length?h(a):3===c.length||4===c.length?g(a):void 0))}}]),angular.module("ponmApp.services").factory("TravelManager",["$q","TravelService",function(){function a(a){this.travel=a,a&&(a.photos=[],angular.forEach(a.spots,function(b){a.photos=a.photos.concat(b.photos)})),this.calculate=function(){var a=this.travel;a.photo_size=0,angular.forEach(a.spots,function(b){angular.forEach(b.photos,function(a){b.time_start=b.time_start||a.date_time,b.time_end=b.time_end||a.date_time,b.time_start>a.date_time&&(b.time_start=a.date_time),b.time_end<a.date_time&&(b.time_end=a.date_time)}),b.photos.sort(function(a,b){return a.date_time-b.date_time}),a.photo_size+=b.photos.length,a.time_start=a.time_start||b.time_start,b.time_start<a.time_start&&(a.time_start=b.time_start);var c=b.time_end||b.time_start;a.time_end=a.time_end||c,c>a.time_end&&(a.time_end=c)}),a.spots.sort(function(a,b){return a.time_start-b.time_start}),angular.forEach(a.spots,function(b){b.day=Math.ceil((b.time_start-a.time_start)/864e5)+1})}}return a}]);