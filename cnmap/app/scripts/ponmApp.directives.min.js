"use strict";angular.module("ponmApp.directives").directive("flexText",["$compile","$rootScope","$log",function(){function a(a,b){this.$textarea=a,this.options=b,this._init()}return a.prototype={_init:function(){var a=this;this.$textarea.wrap('<div class="flex-text-wrap" />').before("<pre><span /><br /></pre>"),a.options.hasUnderline&&this.$textarea.after('<div class="under-line"/>'),this.$span=this.$textarea.parent().find("span"),this.$underLine=this.$textarea.parent().find(".under-line"),this.$textarea.on("input propertychange keyup change",function(){a._mirror()}),this.$textarea.on("focus",function(){a.$underLine&&a.$underLine.addClass("active")}),this.$textarea.on("blur",function(){a.$underLine&&a.$underLine.removeClass("active")}),this._mirror()},_mirror:function(){this.$span.text(this.$textarea.val())}},{restrict:"A",link:function(b,c,d){var e=new a(c,{hasUnderline:!!d.hasUnderline});b.$watch(function(){return c.val()},function(){e._mirror()})}}}]),angular.module("ponmApp.directives").directive("backstretch",function(){return{restrict:"A",link:function(a,b,c){jQuery(b).backstretch(c.backgroundUrl)}}}),angular.module("ponmApp.directives").directive("bdShare",["$window","$animate","$log","param","$q","$sce","$timeout",function(a,b,c,d,e,f,g){return{restrict:"A",templateUrl:"views/bdShare.html",link:function(b,c,d){a._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"1",bdSize:"16"},share:{bdSize:16}},d.bdImage&&"false"!=d.bdImage&&(a._bd_share_config.image={viewList:["qzone","tsina","tqq","renren","weixin"],viewText:"分享到：",viewSize:"16"}),b.scriptSrc="http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion="+~(-new Date/36e5),document.getElementById("bdshell_js").src=b.scriptSrc,c.on("mouseenter",function(){b.mouseLeaveTimer&&g.cancel(b.mouseLeaveTimer),b.$apply(function(){b.mouseEnter=!0})}),c.on("mouseleave",function(){b.mouseLeaveTimer=g(function(){b.$apply(function(){b.mouseEnter=!1})},1e3)})}}}]),angular.module("ponmApp.directives").filter("newlines",function(){return function(a){return a?a.split(/\n/g):""}}).filter("calculatetime",function(){return function(a){if(!a||!angular.isNumber(a))return"";var b=new Date(a),c=new Date,d=c-b,e=Math.round(d/864e5);if(1>e){var f=Math.round(d/36e5);if(1>f){var g=Math.round(d/6e4)+1;return g+"分钟前"}return f+"小时前"}return e>5?a:e+"天前"}}).filter("bytes",function(){return function(a,b){if(isNaN(parseFloat(a))||!isFinite(a))return"-";"undefined"==typeof b&&(b=1);var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}}),angular.module("ponmApp.directives").directive("imageGallery",["$parse","$log","jsUtils",function(){var a={},b={fullScreen:!0};return{restrict:"EA",templateUrl:"views/imageGallery.html",link:function(c,d,e){var f,g=c.$eval(e.imageGallery||e.options||"{}");f=angular.extend({},a,g);var h=d.find(".blueimp-gallery");b.container=h,f.galleryCallback&&c.$eval(f.galleryCallback)(function(a,c){blueimp.Gallery(a,angular.extend({},b,c))}),c.$on("image-gallery",function(a,d){var e=c.$eval(f.galleryData||"galleryData");blueimp.Gallery(e,angular.extend({},b,d))})}}}]),function(){var a;a=angular.module("ponmApp.directives"),a.value("THROTTLE_MILLISECONDS",null),a.directive("infiniteScroll",["$rootScope","$window","$timeout","THROTTLE_MILLISECONDS",function(a,b,c,d){return{scope:{infiniteScroll:"&",infiniteScrollContainer:"=",infiniteScrollDistance:"=",infiniteScrollDisabled:"=",infiniteScrollUseDocumentBottom:"="},link:function(e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t;return b=angular.element(b),q=null,r=null,i=null,j=null,p=!0,t=!1,o=function(){var c,d,g,h,k;return j===b?(c=$(j).height()+$(j).scrollTop(),g=$(f).offset().top+$(f).height()):(c=j.height(),d=0,void 0!==j.offset()&&(d=j.offset().top),g=f.offset().top-d+f.height()),t&&(g=$(document).height()),h=g-c,k=h<=$(j).height()*q+1,k?(i=!0,r?e.$$phase||a.$$phase?e.infiniteScroll():e.$apply(e.infiniteScroll):void 0):i=!1},s=function(a,b){var d,e,f;return f=null,e=0,d=function(){var b;return e=(new Date).getTime(),c.cancel(f),f=null,a.call(),b=null},function(){var g,h;return g=(new Date).getTime(),h=b-(g-e),0>=h?(clearTimeout(f),c.cancel(f),f=null,e=g,a.call()):f?void 0:f=c(d,h)}},null!=d&&(o=s(o,d)),e.$on("$destroy",function(){return j.off("scroll",o)}),m=function(a){return q=parseInt(a,10)||0},e.$watch("infiniteScrollDistance",m),m(e.infiniteScrollDistance),l=function(a){return r=!a,r&&i?(i=!1,o()):void 0},e.$watch("infiniteScrollDisabled",l),l(e.infiniteScrollDisabled),n=function(a){return t=a},e.$watch("infiniteScrollUseDocumentBottom",n),n(e.infiniteScrollUseDocumentBottom),h=function(a){return null!=j&&j.off("scroll",o),j="function"==typeof a.last&&a!==b?a.last():a,null!=a?j.on("scroll",o):void 0},h(b),k=function(a){if(null!=a&&0!==a.length){if(a=angular.element(a),null!=a)return h(a);throw new Exception("invalid infinite-scroll-container attribute.")}},e.$watch("infiniteScrollContainer",k),k(e.infiniteScrollContainer||[]),null!=g.infiniteScrollParent&&h(angular.element(f.parent())),null!=g.infiniteScrollImmediateCheck&&(p=e.$eval(g.infiniteScrollImmediateCheck)),c(function(){return p?o():void 0},0)}}}])}.call(this),angular.module("ponmApp.directives").directive("photoFluidContainer",["$window","$parse","$animate","$log","$timeout",function(a,b,c,d,e){return{restrict:"A",link:function(b,c,f){function g(){var a=c.innerWidth(),b=c.find(l.itemSelector);"maxi"==l.size?j(b,a):"mini"==l.size&&i(b,a)}function h(a,b){b>l.lineMaxHeight&&(b=l.lineMaxHeight);var c=Number(l.itemBorder),d=Number(l.itemMargin);b-=2*d+1,angular.forEach(a,function(a){var d=a.find("img");a.css("height",b+"px"),d.css("height",b-2*c+"px")})}function i(a,b){var c=[],d=0;angular.forEach(a,function(a){if(a=angular.element(a),a.scope&&a.scope()&&a.scope().photo&&a.scope().photo.width&&a.scope().photo.height)var e=a.scope().photo.width+2*l.itemMargin,f=a.scope().photo.height+2*l.itemMargin;else var e=a.outerWidth()+2*l.itemMargin,f=a.outerHeight()+2*l.itemMargin;var g=d+e*l.lineMinHeight/f;g>b?(h(c,b/d*l.lineMinHeight),c=[a],d=l.lineMinHeight*e/f):(c.push(a),d=g)}),c.length&&h(c,b/d*l.lineMinHeight)}function j(a,b){var c=[],d=0;angular.forEach(a,function(a){if(a=angular.element(a),a.scope&&a.scope()&&a.scope().photo&&a.scope().photo.width&&a.scope().photo.height)var e=a.scope().photo.width+2*l.itemMargin,f=a.scope().photo.height+2*l.itemMargin;else var e=a.outerWidth()+2*l.itemMargin,f=a.outerHeight()+2*l.itemMargin;c.push(a),d+=e/f*l.lineMaxHeight,d>=b&&(h(c,b*(l.lineMaxHeight/d)),c=[],d=0)}),c.length&&h(c,b*(l.lineMaxHeight/d))}var k,l={size:"maxi",lineMaxHeight:200,lineMinHeight:100,itemSelector:".fluid-brick",itemMargin:0,itemBorder:0};k=b.$eval(f.photoFluidContainer||"{}"),angular.extend(l,k),b.$watch(function(){return c.innerWidth&&c.innerWidth()},function(){d.debug("container width changed"),b.updateFluid()}),angular.element(a).bind("resize",function(){b.updateFluid()}),b.$on("ponmPhotoFluidResize",function(){d.debug("ponmPhotoFluidResize"),b.updateFluid()}),b.updateFluid=function(){d.debug("updateFluid"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){g(),e(function(){b.$apply(function(){})},500)},500)},b.$watch(f.photoFluidContainer,function(){d.debug("photoFluidContainer changed"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},1e3)})}}}]).directive("ponmHover",["$window","$parse","$animate","$log",function(a,b,c){return{restrict:"A",link:function(a,b,d){b.on("mouseenter",function(){var a=b.find(d.ponmHover);a.addClass("ponm-show"),c.addClass(a,"ponm-show")}),b.on("mouseleave",function(){var a=b.find(d.ponmHover);a.removeClass("ponm-show"),c.removeClass(a,"ponm-show")})}}}]),angular.module("ponmApp.directives").directive("ponmComment",["$window","$animate","$log","CommentService","jsUtils","$q","ponmCtxConfig",function(a,b,c,d,e,f,g){return{restrict:"A",scope:{comment:"=",userId:"="},templateUrl:"views/ponmComment.html",link:function(b,c){b.ctx=a.ctx,b.apirest=a.apirest,b.staticCtx=g.staticCtx,b.comment.editable=b.comment.user_id==b.userId;c.find(".thumbs-up"),c.find(".action");b.userId&&(c.on("mouseenter",function(){b.$apply(function(){b.mouseEnter=!0})}),c.on("mouseleave",function(){b.$apply(function(){b.mouseEnter=!1})})),b.deleteCommment=function(a){d.delete({commentId:a.id},function(c){"OK"==c.status&&b.$emit("deletedCommentEvent",a.id)})},b.likeComment=function(a){a.like?d.unLike({commentId:a.id},function(b){b=b||{},"OK"===b.status&&(a.like=!1,a.like_count-=1)},function(a){a.data}):d.like({commentId:a.id},function(b){b=b||{},"OK"===b.status&&(a.like=!0,a.like_count=a.like_count||0,a.like_count+=1)},function(a){a.data})},b.modifyComment=function(a,b){var c=f.defer();return b&&d.modify({commentId:a.id},e.param({content:b}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.replyComment=function(a){b.$emit("replyCommentEvent",{id:a.user_id,name:a.username})}}}}]),angular.module("ponmApp.directives").directive("ponmMapControls",["$window","$animate","$log","param","$q",function(a,b,c,d,e){return{restrict:"EA",scope:{map:"=ponmMap",mapService:"=ponmMapService",mapEventListener:"=ponmMapEventListener"},templateUrl:"views/ponmMapControls.html",link:function(a){a.selected=void 0,a.states=[],a.getLocation=function(b){var c=e.defer();return a.mapService.getLocPois(b,function(a){c.resolve(a)}),c.promise.then(function(a){return a})},a.goLocation=function(b){var c=b.location;c&&(a.mapEventListener.setCenter(a.map,c.lat,c.lng),a.mapEventListener.setZoom(a.map,b.zoom))}}}}]),angular.module("ponmApp.directives").directive("ponmPhotoContainer",["$window","$parse","$animate","$log","$q",function(a,b,c,d,e){function f(a,b){this.image=a,this.maxSize=b}return f.prototype.loadPhotosphere=function(a){if(a.innerHTML="wait...",this.defer=e.defer(),this.holder=a,this.canUseCanvas()){var b=this;this.canDoWebGL(),this.loadEXIF(function(){b.cropImage()})}else a.innerHTML="<div style='width:100%;height:100%;overflow-x:scroll;overflow-y:hidden'><div style='margin: 10px; background: #ddd; opacity: 0.6; width: 300px; height: 20px; padding: 4px; position: relative'>If you upgrade to a better browser this is 3D!</div><img style='height:100%;margin-top: -48px' src='"+this.image+"' /></div>";return this.defer.promise},f.prototype.canUseCanvas=function(){var a=document.createElement("canvas"),b=a.getContext&&a.getContext("2d");return!!b},f.prototype.cropImage=function(){function a(a){var c=document.createElement("canvas");if(c.width=b.exif.full_width,c.height=b.exif.full_height,void 0!=b.maxSize&&(b.maxSize<c.width||b.maxSize<c.height)){var d=b.maxSize/c.width,e=b.maxSize/c.height;d*c.height<b.maxSize?(c.height=Math.ceil(d*c.height),c.width=b.maxSize):(c.width=Math.ceil(e*c.width),c.height=b.maxSize)}var f=c.getContext("2d");return f.fillStyle="#000",f.fillRect(0,0,c.width,c.height),f.drawImage(a,b.exif.x/b.exif.full_width*c.width,b.exif.y/b.exif.full_height*c.height,b.exif.crop_width/b.exif.full_width*c.width,b.exif.crop_height/b.exif.full_height*c.height),c.toDataURL("image/png")}var b=this;if(b.exif&&(b.exif.crop_width!=b.exif.full_width||b.maxSize&&(b.maxSize<b.exif.full_width||b.maxSize<b.exif.full_height)))if(this.image instanceof Image)b.start3D(a(this.image));else{var c=new Image;c.crossOrigin="anonymous",c.onload=function(){b.start3D(a(c))},c.src=this.image}else if(this.image instanceof Image)b.start3D(a(this.image));else{var c=new Image;c.crossOrigin="anonymous",c.onload=function(){b.start3D(c)},c.src=this.image}},f.prototype.canDoWebGL=function(){var a,b,c;if(void 0===this.isCanDoWebGL){try{a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl"),c=b.getSupportedExtensions(),this.maxSize=b.getParameter(b.MAX_TEXTURE_SIZE)}catch(d){return!1}this.isCanDoWebGL=!!b}return this.isCanDoWebGL},f.prototype.start3D=function(a){void 0==window.THREE&&alert("Please make sure three.js is loaded"),this.target=new THREE.Vector3,this.lat=0,this.lon=90,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.isUserInteracting=!1,this.onMouseDownLon=0,this.onMouseDownLat=0,this.camera=new THREE.PerspectiveCamera(75,parseInt(this.holder.innerWidth())/parseInt(this.holder.innerHeight()),1,1100),this.scene=new THREE.Scene;var b=new THREE.Mesh(new THREE.SphereGeometry(200,20,40),this.loadTexture(a));if(b.scale.x=-1,this.scene.add(b),this.canDoWebGL())try{this.renderer=new THREE.WebGLRenderer}catch(c){this.renderer=new THREE.CanvasRenderer}else this.renderer=new THREE.CanvasRenderer;this.renderer.setSize(parseInt(this.holder.innerWidth()),parseInt(this.holder.innerHeight())),this.holder.innerHTML="",this.holder.append(this.renderer.domElement),this.defer.resolve();var d=this;this.renderer.domElement.addEventListener("touchstart",function(a){d.onDocumentTouchStart(a,d)},!1),this.renderer.domElement.addEventListener("touchmove",function(a){d.onDocumentTouchMove(a,d)},!1),this.renderer.domElement.addEventListener("mousedown",function(a){d.onDocumentMouseDown(a,d)},!1),jQuery(this.renderer.domElement).mousewheel(function(a){d.onMouseWheel(a,d)}),document.addEventListener("mousemove",function(a){d.onDocumentMouseMove(a,d)},!1),document.addEventListener("mouseup",function(a){d.onDocumentMouseUp(a,d)},!1),this.restart()},f.prototype.restart=function(){this.resetTimer(this);var a=this;this.stopTimer=setTimeout(function(){a.stop()},3e3)},f.prototype.stop=function(){void 0!=this.timer&&clearTimeout(this.timer),void 0!=this.interval&&clearInterval(this.interval),void 0!=this.stopTimer&&clearTimeout(this.stopTimer)},f.prototype.startMoving=function(){var a=this;this.interval=setInterval(function(){a.lon=a.lon-.1,-3<a.lat&&a.lat<3||(a.lat>10?a.lat-=.1:a.lat>0?a.lat-=.04:a.lat<0&&a.lat>10?a.lat+=.1:a.lat<0&&(a.lat+=.04)),a.render()},10)},f.prototype.resetTimer=function(a){void 0!=a.timer&&clearTimeout(a.timer),void 0!=a.interval&&clearInterval(a.interval),a.startMoving()},f.prototype.onWindowResize=function(a){a=a||this,a.camera.aspect=parseInt(a.holder.innerWidth())/parseInt(a.holder.innerHeight()),a.camera.updateProjectionMatrix(),a.renderer.setSize(parseInt(a.holder.innerWidth()),parseInt(a.holder.innerHeight())),a.render()},f.prototype.onMouseWheel=function(a,b){var c=b.camera.fov-3*(a.wheelDeltaY||a.detail||a.deltaY);c>10&&100>c&&(b.camera.fov=c,b.camera.updateProjectionMatrix(),b.render(),a.preventDefault())},f.prototype.onDocumentMouseDown=function(a,b){a.preventDefault(),b.isUserInteracting=!0,b.onPointerDownPointerX=a.clientX,b.onPointerDownPointerY=a.clientY,b.onPointerDownLon=b.lon,b.onPointerDownLat=b.lat,b.stop()},f.prototype.onDocumentMouseMove=function(a,b){b.isUserInteracting&&(b.lon=.1*(b.onPointerDownPointerX-a.clientX)+b.onPointerDownLon,b.lat=.1*(a.clientY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.stop())},f.prototype.onDocumentTouchStart=function(a,b){1==a.touches.length&&(a.preventDefault(),b.onPointerDownPointerX=a.touches[0].pageX,b.onPointerDownPointerY=a.touches[0].pageY,b.onPointerDownLon=lon,b.onPointerDownLat=lat)},f.prototype.onDocumentTouchMove=function(a,b){1==a.touches.length&&(a.preventDefault(),b.lon=.1*(b.onPointerDownPointerX-a.touches[0].pageX)+b.onPointerDownLon,b.lat=.1*(a.touches[0].pageY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.stop())},f.prototype.onDocumentMouseUp=function(a,b){b.isUserInteracting=!1,b.render()},f.prototype.loadTexture=function(a){var b=new THREE.Texture,c=new THREE.MeshBasicMaterial({map:b,overdraw:!0}),d=this;return a instanceof Image?(b.needsUpdate=!0,c.map.image=a,setTimeout(function(){d.render()},100)):(b.needsUpdate=!0,THREE.ImageUtils.crossOrigin="anonymous",c.map=THREE.ImageUtils.loadTexture(a),setTimeout(function(){d.render()},100)),c},f.prototype.render=function(){this.lat=Math.max(-85,Math.min(85,this.lat));var a=(90-this.lat)*Math.PI/180,b=this.lon*Math.PI/180;this.target.x=500*Math.sin(a)*Math.cos(b),this.target.y=500*Math.cos(a),this.target.z=500*Math.sin(a)*Math.sin(b),this.camera.lookAt(this.target),this.renderer.render(this.scene,this.camera)},f.prototype.setEXIF=function(a){return this.exif=a,this},f.prototype.loadEXIF=function(a){if(void 0!=this.exif)return void a();var b=this;this.loadBinary(function(c){var d="</x:xmpmeta>",e=c.substring(c.indexOf("<x:xmpmeta"),c.indexOf(d)+d.length),f=function(a){var b=e.indexOf(a+'="')+a.length+2;return e.substring(b,e.indexOf('"',b))};b.exif={full_width:f("GPano:FullPanoWidthPixels"),full_height:f("GPano:FullPanoHeightPixels"),crop_width:f("GPano:CroppedAreaImageWidthPixels"),crop_height:f("GPano:CroppedAreaImageHeightPixels"),x:f("GPano:CroppedAreaLeftPixels"),y:f("GPano:CroppedAreaTopPixels")},console.log(b.exif),a()})},{restrict:"EA",templateUrl:"views/ponmPhotoContainer.html",link:function(b,e,g){function h(a){d.debug("changeP360: "+a),angular.isString(a)&&(a=angular.lowercase(a),a="true"==a),a?(c.addClass(v,"p360"),m(x)):n(x)}function i(a){C=angular.element(a).panzoom({$zoomIn:e.parent().find(".zoom-in"),$zoomOut:e.parent().find(".zoom-out"),$zoomRange:e.parent().find(".zoom-range"),$reset:e.parent().find(".reset"),transition:!0}),C.parent().on("mousewheel.focal",function(a){a.preventDefault();var b=a.delta||a.originalEvent.wheelDelta,c=b?0>b:a.originalEvent.deltaY>0;C.panzoom("zoom",c,{increment:.1,animate:!0,focal:a})}),C.on("panzoomzoom",function(a,b,c){1>c?(C.panzoom("resetZoom"),C.panzoom("resetPan")):Math.abs(c-1)<.05&&(1!=c&&C.panzoom("resetZoom"),C.panzoom("resetPan"))})}function j(){C.panzoom("reset")}function k(){if(!g.ponmPhotoSrcL1)return void c.addClass(u,"ponm-hide");var a=g.ponmPhotoIs360&&"false"!=g.ponmPhotoIs360;if(v&&(v.find(".flat-canvas").empty(),h(a),n(w),c.removeClass(u,"ponm-hide")),g.ponmPhotoSrcL1){p=new Image,p.onload=function(){var a=angular.element(p);r=a.outerWidth(),s=a.outerHeight(),D=s/r,l(),m(v),q&&n(angular.element(q)),c.addClass(u,"ponm-hide")},q&&(angular.element(p).css("position","absolute"),angular.element(p).css("top","0")),p.src=g.ponmPhotoSrcL1;var b=v.find(".flat-canvas");b.append(p),b.on("dblclick",function(){j()}),i(v.find(".flat-canvas")),j()}}function l(){A=e.innerWidth(),B=e.innerHeight(),t.css("line-height",B+"px")}function m(a){c.addClass(a,"ponm-show")}function n(a){c.removeClass(a,"ponm-show")}function o(){n(v),m(w),w.find("canvas").length&&x.ponmPhotoSrcL==g.ponmPhotoSrcL1?(m(w),z.restart()):(x.ponmPhotoSrcL=g.ponmPhotoSrcL1,w.find(".p360-canvas").empty(),c.removeClass(u,"ponm-hide"),z=new f(g.ponmPhotoSrcP360).setEXIF({full_width:g.ponmPhotoWidth,full_height:g.ponmPhotoHeight,crop_width:g.ponmPhotoWidth,crop_height:g.ponmPhotoHeight,x:0,y:0}),z.loadPhotosphere(w.find(".p360-canvas")).then(function(){c.addClass(u,"ponm-hide")}))}var p=null,q=null,r=1,s=1,t=e.find(".ponm-photo-container"),u=e.find(".loading"),v=e.find(".flat-image"),w=e.find(".p360-image"),x=e.find(".flat-image .image-button"),y=e.find(".p360-image .image-button"),z=null;x.on("click",function(a){a.preventDefault(),o()}),x.mouseenter(function(){x.find(".icon-p360").css("opacity",1)}),x.mouseout(function(){x.find(".icon-p360").css("opacity",.5)}),y.on("click",function(a){a.preventDefault(),n(w),m(v),z.stop()}),y.mouseenter(function(){y.find(".icon-pflat").css("opacity",1)}),y.mouseout(function(){y.find(".icon-pflat").css("opacity",.5)}),e.css("width","100%"),e.css("height","100%"),e.css("background-color",g.ponmPhotoColor);var A=e.innerWidth(),B=e.innerHeight();g.$observe("ponmPhotoIs360",function(a){angular.isDefined(a)&&h(a)}),g.$observe("ponmPhotoSrcL1",function(a){angular.isDefined(a)&&k()});var C=null;angular.element(a).resize(function(){l(),z&&z.onWindowResize()});var D=null}}}]),angular.module("ponmApp.directives").directive("ponmRectMultiSelect",["$log","$parse","safeApply",function(a,b,c){var d={selector:".photo",moveselect:!0,offsetX:0,offsetY:0};return{restrict:"A",link:function(e,f,g){function h(b){if(o){b.preventDefault();var c=b.pageX+k.offsetX,d=b.pageY+k.offsetY;a.debug("mouseX: "+c+" mouseY: "+d);var e=Math.abs(m-c),f=Math.abs(n-d);10>e&&10>f||(p.css({width:e,height:f}),m>=c&&d>=n?p.css({left:c}):n>=d&&c>=m?p.css({top:d}):n>d&&m>c&&p.css({left:c,top:d}),k.moveselect&&i(b))}}function i(){var a=(new Array,b(g.ponmRectSelector||"selected").assign);angular.forEach(f.find(k.selector),function(b){b=angular.element(b);var d=b.scope(),e=j(p,b);if(1==e){return void c(d,function(){a(d,!0)})}else c(d,function(){a(d,!1)})})}function j(a,b){var c=a.offset().top,d=a.offset().left,e=b.offset().top,f=b.offset().left;return!(c+a.outerHeight()<e||c>e+b.outerHeight()||d+a.outerWidth()<f||d>f+b.outerWidth())}var k,l=e.$eval(g.ponmRectMultiSelect||"{}");k=angular.extend({},d,l);var m=0,n=0,o=!1,p=angular.element('<div class="ghost-select"><span></span></div>'),q=angular.element('<div id="grid"></div>').append(p);f.prepend(q);var r=angular.element("<div id='big-ghost' class='big-ghost'></div>");f.append(r),f.bind("mousedown",function(a){var b=a.pageX+k.offsetX,c=a.pageY+k.offsetY;r.removeClass("ponm-show"),p.addClass("ponm-show"),p.css({left:b,top:c}),m=b,n=c,o=!0}),$(document).bind("mousemove",h),$(document).bind("mouseup",function(a){if(o){o=!1;var b=Math.abs(m-a.pageX-k.offsetX),c=Math.abs(n-a.pageY-k.offsetY);10>b&&10>c||(i(a),p.removeClass("ponm-show"),p.width(0).height(0))}})}}}]),angular.module("ponmApp.directives").directive("repeatComplete",["$rootScope",function(a){function b(b,d){var e=++c;b.attr("repeat-complete-id",e),b.removeAttr("repeat-complete");var f=d.repeatComplete,g=b.parent(),h=g.scope()||a,i=h.$watch(function(){console.info("Digest running.");var a=g.children("*[ repeat-complete-id = '"+e+"' ]:last");if(a.length){var b=a.scope();b.$last&&(i(),b.$eval(f))}})}var c=0;return{compile:b,priority:1001,restrict:"A"}}]),angular.module("ponmApp.directives").directive("itemPicker",["$parse","$log","jsUtils",function(a,b,c){return{restrict:"EA",require:"ngModel",scope:{loadData:"&",newData:"&",itemValueName:"@"},templateUrl:"views/tagPickerView.html",link:function(a,d,e,f){function g(){if(a.loadData){var c;(c=a.loadData())?(a.loading=!0,c().then(function(b){k=b,h(),a.loading=!1},function(){a.loading=!1})):b.error("load-data function "+e.loadData+" is not defined!")}else b.error("load-data attribute is not defined!")}function h(){a.items=[],angular.forEach(k,function(a,b){i(a,b)})}function i(b,c){return angular.isObject(b)?a.items.push({value:b[a.itemValueName],id:b.id,$key:c}):angular.isString(b)?a.items.push({value:b,$key:c}):void 0}var j=a.$eval(e.options||"{}");a.itemValueName=a.itemValueName||"value",a.placeHolder=e.placeHolder||"添加";var k=null;a.selectedItems=[];var l=d.find("div.dropdown-toggle");l.on("focus click",function(){k||(g(),a.$apply(function(){return a.items}))}),d.find(".dropdown-menu").on("click",function(a){a.preventDefault(),a.stopPropagation()}),a.setItem=function(b){var c=[];if(a.multipleSelect)a.selectedItems=[],b.$active=!b.$active,angular.forEach(a.items,function(b){b.$active&&(a.selectedItems.push(b),c.push(k[b.$key]))});else{if(b.$active)return;angular.forEach(a.items,function(a){a.$active=!1}),b.$active=!0,a.selectedItems=[b],c=k[b.$key]}a.originalItemValue=a.item,f.$setViewValue(c)},a.clearItems=function(){a.originalItemValue="",a.item="",a.items=null},a.createData=function(b){b&&(j.duplicate||!c.Array.containKeys(a.items,"value",b))&&a.newData&&(a.loading=!0,a.newData()(b).then(function(b){a.loading=!1;var c=k.push(b);a.newItem="",c=i(b,c-1),a.setItem(a.items[c-1])},function(){a.loading=!1}))},a.newItemValidate=function(b){var d={errorKey:"duplicate",isValid:!0};return b?(!j.duplicate&&c.Array.containKeys(a.items,"value",b)&&(d.isValid=!1),d):d},a.multipleSelect=void 0===e.multipleSelect||"false"===e.multipleSelect?!1:!0}}}]).directive("contenteditable",["$parse",function(){return{require:"ngModel",scope:{ngModel:"@"},link:function(a,b,c,d){function e(){b.css("color","grey"),b.html(b.placeholder)}function f(){b.css("color",""),b.html("")}b.placeholder=c.placeHolder,b.css("cursor","pointer"),b.on("blur",function(){c.multipleLine?(b.css("overflow","hidden"),a.$apply(function(){if(b.placeholder!=b.html()){var a="",c=b.contents();angular.forEach(c,function(b){b instanceof String?(a&&(a+="\n"),a+=b):""!=b.textContent&&(a&&(a+="\n"),a+=b.textContent)}),d.$setViewValue(a)}d.$render()})):a.$apply(function(){b.placeholder!=b.html()&&d.$setViewValue(b.html()),d.$render()})}),b.on("focus",function(){a.$apply(function(){b.placeholder==b.html()&&f()}),c.multipleLine}),d.$render=function(){d.$viewValue?b.html(d.$viewValue):e()},d.$render(),c.editable&&!a.$eval(c.editable)&&(b.on("input",function(a){b.html(d.$viewValue),a.preventDefault(),a.stopPropagation()}),b.on("keypress keydown keyup onchange",function(a){a.preventDefault(),a.stopPropagation()})),c.multipleLine||b.on("keypress",function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation())}),b.on("mouseenter",function(){d.$render(),a.$apply(function(){a.mouseEnter=!0})}),b.on("mouseleave",function(){a.$apply(function(){a.mouseEnter=!1})})}}}]),angular.module("ponmApp.directives").directive("waypoint",["$log","$timeout",function(a,b){var c={stuckClass:"stuck",direction:"down right"};return{restrict:"A",link:function(d,e,f){a.debug("waypoint...");var g,h=d.$eval(f.waypoint||"{}");g=angular.extend({},$.fn.waypoint.defaults,c,h),b(function(){a.debug("set waypoint"),$(e).waypoint(function(a){d.$emit("waypointEvent",a,h.id)},g)},500),f.$observe("waypointRefresh",function(){$.waypoints("refresh")}),f.$observe("waypointEnable",function(a){$(e).waypoint(a&&"true"==a?"enable":"disable")})}}}]).directive("waypointSticky",["$log","$timeout",function(a,b){var c;return c={stuckClass:"stuck",direction:"down right"},{restrict:"A",link:function(d,e,f){a.debug("waypoint sticky...");var g,h,i,j;i=d.$eval(f.waypointSticky||"{}"),g=$.extend({},$.fn.waypoint.defaults,c,i),h=g.handler,j=$(e),g.handler=function(a){var b;return b=-1!==g.direction.indexOf(a),j.toggleClass(g.stuckClass,b),null!=h?h.call(e,a):void 0},b(function(){j.waypoint(g),j.data("stuckClass",g.stuckClass)},500),f.$observe("waypointEnable",function(a){a&&"true"==a||(j.waypoint("destroy"),j.removeClass(j.data("stuckClass")))})}}}]).directive("whenScrolled",function(){return function(a,b,c){var d=b[0];b.bind("scroll",function(){d.scrollTop+d.offsetHeight>=d.scrollHeight&&a.$apply(c.whenScrolled)})}}).directive("waypointInfinite",["$log","$timeout",function(a){var b;return b={container:"auto",offset:"bottom-in-view",loadingClass:"infinite-loading",onBeforePageLoad:$.noop},{restrict:"A",link:function(c,d,e){a.debug("waypoint infinite...");var f,g,h;h=c.$eval(e.waypointInfinite||"{}"),g=$.extend({},$.fn.waypoint.defaults,b,h),f="auto"===g.container?d:angular.element(g.container),g.handler=function(a){"down"===a||"right"===a?(c[g.onBeforePageLoad]().then(function(){f.removeClass(g.loadingClass),$.waypoints("refresh")}),f.addClass(g.loadingClass)):($.waypoints("refresh"),$.waypoints("viewportHeight"))},$(d).waypoint(g),e.$observe("waypointDisable",function(a){a&&"true"==a&&$(d).waypoint("destroy")})}}}]);