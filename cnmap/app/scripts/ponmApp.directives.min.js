"use strict";angular.module("ponmApp.directives").filter("newlines",function(){return function(a){return a?a.split(/\n/g):""}}).filter("calculatetime",function(){return function(a){if(!a||!angular.isNumber(a))return"";var b=new Date(a),c=new Date,d=c-b,e=Math.round(d/864e5);if(1>e){var f=Math.round(d/36e5);if(1>f){var g=Math.round(d/6e4)+1;return g+"分钟前"}return f+"小时前"}return e>5?a:e+"天前"}}).filter("bytes",function(){return function(a,b){if(isNaN(parseFloat(a))||!isFinite(a))return"-";"undefined"==typeof b&&(b=1);var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(d))).toFixed(b)+" "+c[d]}}),angular.module("ponmApp.directives").directive("flexText",["$compile","$rootScope","$log",function(){function a(a,b){this.$textarea=a,this.options=b,this._init()}return a.prototype={_init:function(){var a=this;this.$textarea.wrap('<div class="flex-text-wrap" />').before("<pre><span /><br /></pre>"),a.options.hasUnderline&&this.$textarea.after('<div class="under-line"/>'),this.$span=this.$textarea.parent().find("span"),this.$underLine=this.$textarea.parent().find(".under-line"),this.$textarea.on("input propertychange keyup change",function(){a._mirror()}),this.$textarea.on("focus",function(){a.$underLine&&a.$underLine.addClass("active")}),this.$textarea.on("blur",function(){a.$underLine&&a.$underLine.removeClass("active")}),this._mirror()},_mirror:function(){this.$span.text(this.$textarea.val())}},{restrict:"A",link:function(b,c,d){var e=new a(c,{hasUnderline:!!d.hasUnderline});b.$watch(function(){return c.val()},function(){e._mirror()})}}}]),angular.module("ponmApp.directives").directive("ponmPhotoContainer",["$window","$parse","$animate","$log","$q",function(a,b,c,d,e){function f(a,b){this.image=a,this.maxSize=b}return f.prototype.loadPhotosphere=function(a){if(a.innerHTML="wait...",this.defer=e.defer(),this.holder=a,this.canUseCanvas()){var b=this;this.canDoWebGL(),this.loadEXIF(function(){b.cropImage()})}else a.innerHTML="<div style='width:100%;height:100%;overflow-x:scroll;overflow-y:hidden'><div style='margin: 10px; background: #ddd; opacity: 0.6; width: 300px; height: 20px; padding: 4px; position: relative'>If you upgrade to a better browser this is 3D!</div><img style='height:100%;margin-top: -48px' src='"+this.image+"' /></div>";return this.defer.promise},f.prototype.canUseCanvas=function(){var a=document.createElement("canvas"),b=a.getContext&&a.getContext("2d");return!!b},f.prototype.cropImage=function(){function a(a){var c=document.createElement("canvas");if(c.width=b.exif.full_width,c.height=b.exif.full_height,void 0!=b.maxSize&&(b.maxSize<c.width||b.maxSize<c.height)){var d=b.maxSize/c.width,e=b.maxSize/c.height;d*c.height<b.maxSize?(c.height=Math.ceil(d*c.height),c.width=b.maxSize):(c.width=Math.ceil(e*c.width),c.height=b.maxSize)}var f=c.getContext("2d");return f.fillStyle="#000",f.fillRect(0,0,c.width,c.height),f.drawImage(a,b.exif.x/b.exif.full_width*c.width,b.exif.y/b.exif.full_height*c.height,b.exif.crop_width/b.exif.full_width*c.width,b.exif.crop_height/b.exif.full_height*c.height),c.toDataURL("image/png")}var b=this;if(b.exif&&(b.exif.crop_width!=b.exif.full_width||b.maxSize&&(b.maxSize<b.exif.full_width||b.maxSize<b.exif.full_height)))if(this.image instanceof Image)b.start3D(a(this.image));else{var c=new Image;c.crossOrigin="anonymous",c.onload=function(){b.start3D(a(c))},c.src=this.image}else if(this.image instanceof Image)b.start3D(a(this.image));else{var c=new Image;c.crossOrigin="anonymous",c.onload=function(){b.start3D(c)},c.src=this.image}},f.prototype.canDoWebGL=function(){var a,b,c;if(void 0===this.isCanDoWebGL){try{a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl"),c=b.getSupportedExtensions(),this.maxSize=b.getParameter(b.MAX_TEXTURE_SIZE)}catch(d){return!1}this.isCanDoWebGL=!!b}return this.isCanDoWebGL},f.prototype.start3D=function(a){void 0==window.THREE&&alert("Please make sure three.js is loaded"),this.target=new THREE.Vector3,this.lat=0,this.lon=90,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.isUserInteracting=!1,this.onMouseDownLon=0,this.onMouseDownLat=0,this.camera=new THREE.PerspectiveCamera(75,parseInt(this.holder.innerWidth())/parseInt(this.holder.innerHeight()),1,1100),this.scene=new THREE.Scene;var b=new THREE.Mesh(new THREE.SphereGeometry(200,20,40),this.loadTexture(a));if(b.scale.x=-1,this.scene.add(b),this.canDoWebGL())try{this.renderer=new THREE.WebGLRenderer}catch(c){this.renderer=new THREE.CanvasRenderer}else this.renderer=new THREE.CanvasRenderer;this.renderer.setSize(parseInt(this.holder.innerWidth()),parseInt(this.holder.innerHeight())),this.holder.innerHTML="",this.holder.append(this.renderer.domElement),this.defer.resolve();var d=this;this.renderer.domElement.addEventListener("touchstart",function(a){d.onDocumentTouchStart(a,d)},!1),this.renderer.domElement.addEventListener("touchmove",function(a){d.onDocumentTouchMove(a,d)},!1),this.renderer.domElement.addEventListener("mousedown",function(a){d.onDocumentMouseDown(a,d)},!1),jQuery(this.renderer.domElement).mousewheel(function(a){d.onMouseWheel(a,d)}),document.addEventListener("mousemove",function(a){d.onDocumentMouseMove(a,d)},!1),document.addEventListener("mouseup",function(a){d.onDocumentMouseUp(a,d)},!1),this.restart()},f.prototype.restart=function(){this.resetTimer(this);var a=this;this.stopTimer=setTimeout(function(){a.stop()},3e3)},f.prototype.stop=function(){void 0!=this.timer&&clearTimeout(this.timer),void 0!=this.interval&&clearInterval(this.interval),void 0!=this.stopTimer&&clearTimeout(this.stopTimer)},f.prototype.startMoving=function(){var a=this;this.interval=setInterval(function(){a.lon=a.lon-.1,-3<a.lat&&a.lat<3||(a.lat>10?a.lat-=.1:a.lat>0?a.lat-=.04:a.lat<0&&a.lat>10?a.lat+=.1:a.lat<0&&(a.lat+=.04)),a.render()},10)},f.prototype.resetTimer=function(a){void 0!=a.timer&&clearTimeout(a.timer),void 0!=a.interval&&clearInterval(a.interval),a.startMoving()},f.prototype.onWindowResize=function(a){a=a||this,a.camera.aspect=parseInt(a.holder.innerWidth())/parseInt(a.holder.innerHeight()),a.camera.updateProjectionMatrix(),a.renderer.setSize(parseInt(a.holder.innerWidth()),parseInt(a.holder.innerHeight())),a.render()},f.prototype.onMouseWheel=function(a,b){var c=b.camera.fov-3*(a.wheelDeltaY||a.detail||a.deltaY);c>10&&100>c&&(b.camera.fov=c,b.camera.updateProjectionMatrix(),b.render(),a.preventDefault())},f.prototype.onDocumentMouseDown=function(a,b){a.preventDefault(),b.isUserInteracting=!0,b.onPointerDownPointerX=a.clientX,b.onPointerDownPointerY=a.clientY,b.onPointerDownLon=b.lon,b.onPointerDownLat=b.lat,b.stop()},f.prototype.onDocumentMouseMove=function(a,b){b.isUserInteracting&&(b.lon=.1*(b.onPointerDownPointerX-a.clientX)+b.onPointerDownLon,b.lat=.1*(a.clientY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.stop())},f.prototype.onDocumentTouchStart=function(a,b){1==a.touches.length&&(a.preventDefault(),b.onPointerDownPointerX=a.touches[0].pageX,b.onPointerDownPointerY=a.touches[0].pageY,b.onPointerDownLon=lon,b.onPointerDownLat=lat)},f.prototype.onDocumentTouchMove=function(a,b){1==a.touches.length&&(a.preventDefault(),b.lon=.1*(b.onPointerDownPointerX-a.touches[0].pageX)+b.onPointerDownLon,b.lat=.1*(a.touches[0].pageY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.stop())},f.prototype.onDocumentMouseUp=function(a,b){b.isUserInteracting=!1,b.render()},f.prototype.loadTexture=function(a){var b=new THREE.Texture,c=new THREE.MeshBasicMaterial({map:b,overdraw:!0}),d=this;return a instanceof Image?(b.needsUpdate=!0,c.map.image=a,setTimeout(function(){d.render()},100)):(b.needsUpdate=!0,THREE.ImageUtils.crossOrigin="anonymous",c.map=THREE.ImageUtils.loadTexture(a),setTimeout(function(){d.render()},100)),c},f.prototype.render=function(){this.lat=Math.max(-85,Math.min(85,this.lat));var a=(90-this.lat)*Math.PI/180,b=this.lon*Math.PI/180;this.target.x=500*Math.sin(a)*Math.cos(b),this.target.y=500*Math.cos(a),this.target.z=500*Math.sin(a)*Math.sin(b),this.camera.lookAt(this.target),this.renderer.render(this.scene,this.camera)},f.prototype.setEXIF=function(a){return this.exif=a,this},f.prototype.loadEXIF=function(a){if(void 0!=this.exif)return void a();var b=this;this.loadBinary(function(c){var d="</x:xmpmeta>",e=c.substring(c.indexOf("<x:xmpmeta"),c.indexOf(d)+d.length),f=function(a){var b=e.indexOf(a+'="')+a.length+2;return e.substring(b,e.indexOf('"',b))};b.exif={full_width:f("GPano:FullPanoWidthPixels"),full_height:f("GPano:FullPanoHeightPixels"),crop_width:f("GPano:CroppedAreaImageWidthPixels"),crop_height:f("GPano:CroppedAreaImageHeightPixels"),x:f("GPano:CroppedAreaLeftPixels"),y:f("GPano:CroppedAreaTopPixels")},console.log(b.exif),a()})},{restrict:"EA",templateUrl:"views/ponmPhotoContainer.html",link:function(b,e,g){function h(a){d.debug("changeP360: "+a),angular.isString(a)&&(a=angular.lowercase(a),a="true"==a),a?(c.addClass(v,"p360"),m(x)):n(x)}function i(a){C=angular.element(a).panzoom({$zoomIn:e.parent().find(".zoom-in"),$zoomOut:e.parent().find(".zoom-out"),$zoomRange:e.parent().find(".zoom-range"),$reset:e.parent().find(".reset"),transition:!0}),C.parent().on("mousewheel.focal",function(a){a.preventDefault();var b=a.delta||a.originalEvent.wheelDelta,c=b?0>b:a.originalEvent.deltaY>0;C.panzoom("zoom",c,{increment:.1,animate:!0,focal:a})}),C.on("panzoomzoom",function(a,b,c){1>c?(C.panzoom("resetZoom"),C.panzoom("resetPan")):Math.abs(c-1)<.05&&(1!=c&&C.panzoom("resetZoom"),C.panzoom("resetPan"))})}function j(){C.panzoom("reset")}function k(){if(!g.ponmPhotoSrcL1)return void c.addClass(u,"ponm-hide");var a=g.ponmPhotoIs360&&"false"!=g.ponmPhotoIs360;v&&(v.find(".flat-canvas").empty(),h(a),n(w),c.removeClass(u,"ponm-hide")),g.ponmPhotoSrcL1&&(p=new Image,p.onload=function(){var a=angular.element(p);r=a.outerWidth(),s=a.outerHeight(),D=s/r,l(),m(v),q&&n(angular.element(q)),c.addClass(u,"ponm-hide")},q&&(angular.element(p).css("position","absolute"),angular.element(p).css("top","0")),p.src=a?g.ponmPhotoSrcP360:g.ponmPhotoSrcL1,v.find(".flat-canvas").append(p),i(v.find(".flat-canvas")),j())}function l(){A=e.innerWidth(),B=e.innerHeight(),t.css("line-height",B+"px")}function m(a){c.addClass(a,"ponm-show")}function n(a){c.removeClass(a,"ponm-show")}function o(){n(v),m(w),w.find("canvas").length&&x.ponmPhotoSrcL==g.ponmPhotoSrcL1?(m(w),z.restart()):(x.ponmPhotoSrcL=g.ponmPhotoSrcL1,w.find(".p360-canvas").empty(),c.removeClass(u,"ponm-hide"),z=new f(g.ponmPhotoSrcP360).setEXIF({full_width:g.ponmPhotoWidth,full_height:g.ponmPhotoHeight,crop_width:g.ponmPhotoWidth,crop_height:g.ponmPhotoHeight,x:0,y:0}),z.loadPhotosphere(w.find(".p360-canvas")).then(function(){c.addClass(u,"ponm-hide")}))}var p=null,q=null,r=1,s=1,t=e.find(".ponm-photo-container"),u=e.find(".loading"),v=e.find(".flat-image"),w=e.find(".p360-image"),x=e.find(".flat-image .image-button"),y=e.find(".p360-image .image-button"),z=null;x.on("click",function(a){a.preventDefault(),o()}),x.mouseenter(function(){x.find(".icon-p360").css("opacity",1)}),x.mouseout(function(){x.find(".icon-p360").css("opacity",.5)}),y.on("click",function(a){a.preventDefault(),n(w),m(v),z.stop()}),y.mouseenter(function(){y.find(".icon-pflat").css("opacity",1)}),y.mouseout(function(){y.find(".icon-pflat").css("opacity",.5)}),e.css("width","100%"),e.css("height","100%"),e.css("background-color",g.ponmPhotoColor);var A=e.innerWidth(),B=e.innerHeight();g.$observe("ponmPhotoIs360",function(a){angular.isDefined(a)&&h(a)}),g.$observe("ponmPhotoSrcL1",function(a){angular.isDefined(a)&&k()});var C=null;angular.element(a).resize(function(){l(),z&&z.onWindowResize()});var D=null}}}]),angular.module("ponmApp.directives").directive("photoFluidContainer",["$window","$parse","$animate","$log","$timeout",function(a,b,c,d,e){return{restrict:"A",link:function(b,c,f){function g(){var a=c.innerWidth(),b=f.fluidLineItemMargin||0;d.debug("lingItemMargin: "+b);var e=c.find(l);i(e,a,b)}function h(a,b){b>j&&(b=j);var c=Number(f.fluidLineBorder),d=Number(f.fluidLineItemMargin);b-=4*d,b=Math.round(b),angular.forEach(a,function(a){var d=a.find("img");a.css("height",b+"px"),d.css("height",b-2*c+"px")})}function i(a,b,c){var d=[],e=0;angular.forEach(a,function(a){a=angular.element(a);var f=a.outerWidth()+2*c,g=a.outerHeight()+2*c;d.push(a),e+=Math.round(f/g*j),e>=b&&(h(d,Math.round(b*(j/e))),d=[],e=0)}),d.length&&h(d,Math.round(b/e*j))}var j=0,k=0;j=b.$eval(f.fluidLineMaxHeight)||200,k=b.$eval(f.fluidLineMinHeight)||100;var l=f.itemSelector||".fluid-brick";$(a).resize(function(){b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},500)}),b.$on("ponmPhotoFluidResize",function(){d.debug("ponmPhotoFluidResize"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},500)}),b.updateFluid=function(){if(d.debug("updateFluid"),a.imagesLoaded){var b=a.imagesLoaded&&a.imagesLoaded(c);b.on("always",function(){g()})}},b.$watch(f.photoFluidContainer,function(){d.debug("photoFluidContainer changed"),b.updatePromise&&e.cancel(b.updatePromise),b.updatePromise=e(function(){b.updateFluid(),b.updatePromise=null},1e3)})}}}]).directive("ponmHover",["$window","$parse","$animate","$log",function(a,b,c){return{restrict:"A",link:function(a,b){b.on("mouseenter",function(){var a=b.find("> .action");c.addClass(a,"ponm-show")}),b.on("mouseleave",function(){var a=b.find("> .action");c.removeClass(a,"ponm-show")})}}}]),angular.module("ponmApp.directives").directive("ponmComment",["$window","$animate","$log","CommentService","param","$q","ponmCtxConfig",function(a,b,c,d,e,f,g){return{restrict:"A",scope:{comment:"=",userId:"="},templateUrl:"views/ponmComment.html",link:function(b,c){b.ctx=a.ctx,b.apirest=a.apirest,b.staticCtx=g.staticCtx,b.comment.editable=b.comment.user_id==b.userId;c.find(".thumbs-up"),c.find(".action");b.userId&&(c.on("mouseenter",function(){b.$apply(function(){b.mouseEnter=!0})}),c.on("mouseleave",function(){b.$apply(function(){b.mouseEnter=!1})})),b.deleteCommment=function(a){d.delete({commentId:a.id},function(c){"OK"==c.status&&b.$emit("deletedCommentEvent",a.id)})},b.likeComment=function(a){a.like?d.unLike({commentId:a.id},function(b){b=b||{},"OK"===b.status&&(a.like=!1,a.like_count-=1)},function(a){a.data}):d.like({commentId:a.id},function(b){b=b||{},"OK"===b.status&&(a.like=!0,a.like_count=a.like_count||0,a.like_count+=1)},function(a){a.data})},b.modifyComment=function(a,b){var c=f.defer();return b&&d.modify({commentId:a.id},e({content:b}),function(a){"OK"==a.status?c.resolve():c.resolve(a.info)},function(a){c.reject(a.data?a.data.info:"Server error!")}),c.promise},b.replyComment=function(a){b.$emit("replyCommentEvent",{id:a.user_id,name:a.username})}}}}]),angular.module("ponmApp.directives").directive("repeatComplete",["$rootScope",function(a){function b(b,d){var e=++c;b.attr("repeat-complete-id",e),b.removeAttr("repeat-complete");var f=d.repeatComplete,g=b.parent(),h=g.scope()||a,i=h.$watch(function(){console.info("Digest running.");var a=g.children("*[ repeat-complete-id = '"+e+"' ]:last");if(a.length){var b=a.scope();b.$last&&(i(),b.$eval(f))}})}var c=0;return{compile:b,priority:1001,restrict:"A"}}]),angular.module("ponmApp.directives").directive("bdShare",["$window","$animate","$log","param","$q","$sce","$timeout",function(a,b,c,d,e,f,g){return{restrict:"A",templateUrl:"views/bdShare.html",link:function(b,c,d){a._bd_share_config={common:{bdSnsKey:{},bdText:"",bdMini:"2",bdMiniList:!1,bdPic:"",bdStyle:"1",bdSize:"16"},share:{bdSize:16}},d.bdImage&&"false"!=d.bdImage&&(a._bd_share_config.image={viewList:["qzone","tsina","tqq","renren","weixin"],viewText:"分享到：",viewSize:"16"}),b.scriptSrc="http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion="+~(-new Date/36e5),document.getElementById("bdshell_js").src=b.scriptSrc,c.on("mouseenter",function(){b.mouseLeaveTimer&&g.cancel(b.mouseLeaveTimer),b.$apply(function(){b.mouseEnter=!0})}),c.on("mouseleave",function(){b.mouseLeaveTimer=g(function(){b.$apply(function(){b.mouseEnter=!1})},1e3)})}}}]),angular.module("ponmApp.directives").directive("backstretch",function(){return{restrict:"A",link:function(a,b,c){jQuery(b).backstretch(c.backgroundUrl)}}}),angular.module("ponmApp.directives").directive("waypoint",["$log",function(a){return{restrict:"A",link:function(b,c,d){a.debug("waypoint..."),setTimeout(function(){a.debug("set waypoint"),$(c).waypoint(function(c){a.debug("waypoint - waypointEvent"),b.$emit("waypointEvent",c,d.waypoint)},{context:".waypoint-scrollable",continuous:!0,offset:d.waypointOffset||"10%"})},1e3),d.$observe("waypointRefresh",function(){$.waypoints("refresh")}),d.$observe("waypointEnable",function(a){$(c).waypoint(a&&"true"==a?"enable":"disable")})}}}]),angular.module("ponmApp.directives").directive("ponmMapControls",["$window","$animate","$log","param","$q",function(a,b,c,d,e){return{restrict:"EA",scope:{map:"=ponmMap",mapService:"=ponmMapService",mapEventListener:"=ponmMapEventListener"},templateUrl:"views/ponmMapControls.html",link:function(a){a.selected=void 0,a.states=[],a.getLocation=function(b){var c=e.defer();return a.mapService.getLocPois(b,function(a){c.resolve(a)}),c.promise.then(function(a){return a})},a.goLocation=function(b){var c=b.location;c&&(a.mapEventListener.setCenter(a.map,c.lat,c.lng),a.mapEventListener.setZoom(a.map,b.zoom))}}}}]),angular.module("ponmApp.directives").directive("ponmRectMultiSelect",["$log","$parse","safeApply",function(a,b,c){return{restrict:"A",link:function(a,d,e){function f(a){if(k){a.preventDefault();var b=Math.abs(i-a.pageX),c=Math.abs(j-a.pageY);10>b&&10>c||(l.css({width:b,height:c}),a.pageX<=i&&a.pageY>=j?l.css({left:a.pageX}):a.pageY<=j&&a.pageX>=i?l.css({top:a.pageY}):a.pageY<j&&a.pageX<i&&l.css({left:a.pageX,top:a.pageY}),void 0!=e.ponmRectMoveselect&&"false"!=e.ponmRectMoveselect&&g(a))}}function g(){var a=(new Array,b(e.ponmRectSelector||"selected").assign);angular.forEach(d.find(e.ponmRectMultiSelect||".elements"),function(b){b=angular.element(b);var d=b.scope(),e=h(l,b);if(1==e){return void c(d,function(){a(d,!0)})}else c(d,function(){a(d,!1)})})}function h(a,b){var c=a.offset().top,d=a.offset().left,e=b.offset().top,f=b.offset().left;return!(c+a.outerHeight()<e||c>e+b.outerHeight()||d+a.outerWidth()<f||d>f+b.outerWidth())}var i=0,j=0,k=!1,l=angular.element('<div class="ghost-select"><span></span></div>'),m=angular.element('<div id="grid"></div>').append(l);d.prepend(m);var n=angular.element("<div id='big-ghost' class='big-ghost'></div>");d.append(n),d.bind("mousedown",function(a){n.removeClass("ponm-show"),l.addClass("ponm-show"),l.css({left:a.pageX,top:a.pageY}),i=a.pageX,j=a.pageY,k=!0}),$(document).bind("mousemove",f),$(document).bind("mouseup",function(a){if(k){k=!1;var b=Math.abs(i-a.pageX),c=Math.abs(j-a.pageY);10>b&&10>c||(g(a),l.removeClass("ponm-show"),l.width(0).height(0))}})}}}]);